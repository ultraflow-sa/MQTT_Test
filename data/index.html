<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A3 Setup - Main</title>
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/style.css?v=' + new Date().getTime();
      document.head.appendChild(link);
    </script>
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
  </head>
  <body>
    <div class="header-box">
      <h1>A3 Setup</h1>
    </div>
    <div class="device-info">
      <label for="deviceSerial">Enter or Select Device Serial:</label>
      <input list="serialList" id="deviceSerial" placeholder="e.g., 123456">
      <datalist id="serialList"></datalist>
    </div>
    <div class="btn-row">
      <button type="button" class="btn" id="actionButton">Connect/Search</button>
    </div>
    <script>
      // HiveMQ Cloud credentials
      const hivemqBrokerUrl = 'wss://bd58f8878eef4f5eb73ac65312b10130.s1.eu.hivemq.cloud:8884/mqtt';
      const hivemqUsername = 'a3Admin';
      const hivemqPassword = 'DontLetMeIn247';

      let client = null;
      let searchMode = true;
      let foundSerials = new Set();
      let identifyTimeout = null;

      const actionButton = document.getElementById("actionButton");
      const serialInput = document.getElementById("deviceSerial");
      const serialList = document.getElementById("serialList");

      function connectMQTT() {
        if (client && client.connected) return;
        client = mqtt.connect(hivemqBrokerUrl, {
          clientId: 'webClient-' + Math.random().toString(16).substr(2, 8),
          username: hivemqUsername,
          password: hivemqPassword,
          clean: true,
          connectTimeout: 4000,
          reconnectPeriod: 2000,
        });

        client.on('connect', function() {
          console.log('Connected to HiveMQ MQTT broker.');
          client.subscribe('a3/identifyResponse', function() {
            console.log('Subscribed to a3/identifyResponse');
          });
        });

        client.on('message', function(topic, message) {
          if (topic === 'a3/identifyResponse' && searchMode) {
            try {
              const payload = JSON.parse(message.toString());
              if (payload.serial) {
                if (!foundSerials.has(payload.serial)) {
                  foundSerials.add(payload.serial);
                  let option = document.createElement('option');
                  option.value = payload.serial;
                  serialList.appendChild(option);
                  console.log('Found device serial:', payload.serial);
                }
              }
            } catch (e) {
              console.log('Error parsing identifyResponse:', e);
            }
          } else if (topic.endsWith('/serialResponse') && !searchMode) {
            try {
              const payload = JSON.parse(message.toString());
              if (payload.serial && payload.version) {
                // Redirect to main.html with serial and version as query params
                window.location.href = `main.html?serial=${encodeURIComponent(payload.serial)}&version=${encodeURIComponent(payload.version)}`;
              }
            } catch (e) {
              console.log('Error parsing serialResponse:', e);
            }
          }
        });
      }

      function startIdentify() {
        foundSerials.clear();
        serialList.innerHTML = '';
        searchMode = true;
        connectMQTT();
        // Subscribe to identifyResponse
        client.subscribe('a3/identifyResponse', function() {
          // Publish identify request
          client.publish('a3/identifyYourself', 'whois');
          console.log('Published "whois" to a3/identifyYourself');
        });
        // Wait for responses for 3 seconds, then enable selection
        if (identifyTimeout) clearTimeout(identifyTimeout);
        identifyTimeout = setTimeout(() => {
          actionButton.innerText = "Connect";
          searchMode = false;
        }, 3000);
      }

      function querySerial(serial) {
        searchMode = false;
        // Subscribe to the serialResponse topic
        const responseTopic = `a3/${serial}/serialResponse`;
        client.subscribe(responseTopic, function() {
          // Publish querySerial
          client.publish(`a3/${serial}/querySerial`, "indexQuery");
          console.log(`Published "indexQuery" to a3/${serial}/querySerial`);
        });
      }

      actionButton.onclick = function() {
        const inputSerial = serialInput.value.trim();
        if (searchMode) {
          if (inputSerial.length === 0) {
            actionButton.innerText = "Searching...";
            startIdentify();
          } else {
            // User entered a serial, skip search and query directly
            querySerial(inputSerial);
          }
        } else {
          if (inputSerial.length === 0) {
            alert("Please select or enter a serial number.");
            return;
          }
          querySerial(inputSerial);
        }
      };

      // Auto-connect MQTT on page load
      window.addEventListener('DOMContentLoaded', function() {
        connectMQTT();
      });
    </script>
  </body>
</html>