<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A3 Setup</title>
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/style.css?v=' + new Date().getTime();
      document.head.appendChild(link);
    </script>
    <style>
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
      label.var-label {
        font-family: monospace;
        font-size: 0.95em;
        color: #888;
        margin-left: 8px;
      }
    </style>
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
  </head>
  <body>
    <div class="header-box">
      <h1>A3 Setup</h1>
    </div>
    <div class="content main-content">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" id="tabMainBtn" type="button">Main</button>
        <button class="tab-btn" id="tabLiveBtn" type="button">Live</button>
        <button class="tab-btn" id="tabSettingsBtn" type="button">Settings</button>
        <button class="tab-btn" id="tabWiFiBtn" type="button">WiFi</button>
      </div>
      <!-- Tab Contents -->
      <div class="tab-content active" id="tabMain">
        <div class="info-row">
          <div>
            Serial: <span id="serial-number" class="info-value">...</span>
          </div>
          <div>
            Version: <span id="ver-string" class="info-value">...</span>
          </div>
        </div>
        <div id="status-message" class="status-message"></div>
        <div class="btn-row">
          <button class="btn" id="backBtn">CHANGE</button>
        </div>
      </div>
      <div class="tab-content" id="tabLive">
        <div style="margin: 40px 0 20px 0; text-align: center;">
          <strong>Live tab content goes here.</strong>
        </div>
      </div>
      <div class="tab-content" id="tabSettings">
        <form id="settingsForm" autocomplete="off">
          <div class="settings-group" id="settingsFields">
            <!-- Pump 1 -->
            <div class="settings-row">
              <label for="modeSelect"><strong>Mode</strong>
                <span class="var-label">modeP1</span>
              </label>
              <select id="modeSelect" name="modeP1">
                <option value="PLS">PLS</option>
                <option value="SLS">SLS</option>
              </select>
            </div>
            <div class="settings-row">
              <label for="runModeP1"><strong>Run Mode</strong>
                <span class="var-label">runModeP1</span>
              </label>
              <select id="runModeP1" name="runModeP1">
                <option value="TIME">TIME</option>
                <option value="CYCLE">CYCLE</option>
              </select>
            </div>
            <div class="settings-row">
              <label for="pauseTime"><strong>Pause Time</strong>
                <span class="var-label">pauseTimeP1</span>
              </label>
              <input type="number" id="pauseTime" name="pauseTimeP1" placeholder="Enter pause time">
            </div>
            <div class="settings-row">
              <label for="timeCyclesP1"><strong>Time/Cycles</strong>
                <span class="var-label">timeCyclesP1</span>
              </label>
              <input type="number" id="timeCyclesP1" name="timeCyclesP1" placeholder="Enter value">
            </div>
            <div class="settings-row">
              <label for="proxy1"><strong>Proxy1</strong>
                <span class="var-label">proxy1P1</span>
              </label>
              <input type="checkbox" id="proxy1" name="proxy1P1">
            </div>
            <div class="settings-row" id="dwellTime1Row" style="display:none;">
              <label for="dwellTime1"><strong>Dwell Time Proxy1</strong>
                <span class="var-label">dwellTimeP1Px1</span>
              </label>
              <input type="number" id="dwellTime1" name="dwellTimeP1Px1" placeholder="Enter dwell time">
            </div>
            <div class="settings-row">
              <label for="proxy2"><strong>Proxy2</strong>
                <span class="var-label">proxy2P1</span>
              </label>
              <input type="checkbox" id="proxy2" name="proxy2P1">
            </div>
            <div class="settings-row" id="dwellTime2Row" style="display:none;">
              <label for="dwellTime2"><strong>Dwell Time Proxy2</strong>
                <span class="var-label">dwellTimeP1Px2</span>
              </label>
              <input type="number" id="dwellTime2" name="dwellTimeP1Px2" placeholder="Enter dwell time for Proxy2">
            </div>
            <div class="settings-row">
              <label for="levelSense"><strong>Level Sense</strong>
                <span class="var-label">levelP1</span>
              </label>
              <input type="checkbox" id="levelSense" name="levelP1">
            </div>
            <div class="settings-row" id="levelSenseOptionsRow" style="display:none;">
              <label for="levelSenseOptions"><strong>Level Sense Mode</strong>
                <span class="var-label">levelTypeP1</span>
              </label>
              <select id="levelSenseOptions" name="levelTypeP1">
                <option value="HEF">Hall Sense</option>
                <option value="PULE">Pulse Empty</option>
                <option value="PULF">Pulse Full</option>
                <option value="LLO">Steady</option>
              </select>
            </div>
            <div class="settings-row" id="levelNoncRow" style="display:none;">
              <label for="levelNonc"><strong>Type</strong>
                <span class="var-label">levelNoncP1</span>
              </label>
              <select id="levelNonc" name="levelNoncP1">
                <option value="NO">NO</option>
                <option value="NC">NC</option>
              </select>
            </div>
            <!-- Pump 2 -->
            <div class="settings-row">
              <label for="pump2"><strong>Pump2 In Use</strong>
                <span class="var-label">pump2InUse</span>
              </label>
              <input type="checkbox" id="pump2" name="pump2InUse">
            </div>
            <div id="pump2SettingsGroup" style="display:none;">
              <div class="settings-row">
                <label for="pump2Mode"><strong>Mode</strong>
                  <span class="var-label">modeP2</span>
                </label>
                <select id="pump2Mode" name="modeP2">
                  <option value="PLS">PLS</option>
                  <option value="SLS">SLS</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2RunMode"><strong>Run Mode</strong>
                  <span class="var-label">runModeP2</span>
                </label>
                <select id="pump2RunMode" name="runModeP2">
                  <option value="TIME">TIME</option>
                  <option value="CYCLE">CYCLE</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2PauseTime"><strong>Pause Time</strong>
                  <span class="var-label">pauseTimeP2</span>
                </label>
                <input type="number" id="pump2PauseTime" name="pauseTimeP2" placeholder="Enter pause time">
              </div>
              <div class="settings-row">
                <label for="timeCyclesP2"><strong>Time/Cycles</strong>
                  <span class="var-label">timeCyclesP2</span>
                </label>
                <input type="number" id="timeCyclesP2" name="timeCyclesP2" placeholder="Enter value">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy1"><strong>Proxy1</strong>
                  <span class="var-label">proxy1P2</span>
                </label>
                <input type="checkbox" id="pump2Proxy1" name="proxy1P2">
              </div>
              <div class="settings-row" id="pump2DwellTime1Row" style="display:none;">
                <label for="pump2DwellTime1"><strong>Dwell Time Proxy1</strong>
                  <span class="var-label">dwellTimeP2Px1</span>
                </label>
                <input type="number" id="pump2DwellTime1" name="dwellTimeP2Px1" placeholder="Enter dwell time">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy2"><strong>Proxy2</strong>
                  <span class="var-label">proxy2P2</span>
                </label>
                <input type="checkbox" id="pump2Proxy2" name="proxy2P2">
              </div>
              <div class="settings-row" id="pump2DwellTime2Row" style="display:none;">
                <label for="pump2DwellTime2"><strong>Dwell Time Proxy2</strong>
                  <span class="var-label">dwellTimeP2Px2</span>
                </label>
                <input type="number" id="pump2DwellTime2" name="dwellTimeP2Px2" placeholder="Enter dwell time for Proxy2">
              </div>
              <div class="settings-row">
                <label for="pump2LevelSense"><strong>Level Sense</strong>
                  <span class="var-label">levelP2</span>
                </label>
                <input type="checkbox" id="pump2LevelSense" name="levelP2">
              </div>
              <div class="settings-row" id="pump2LevelSenseOptionsRow" style="display:none;">
                <label for="pump2LevelSenseOptions"><strong>Level Sense Mode</strong>
                  <span class="var-label">levelTypeP2</span>
                </label>
                <select id="pump2LevelSenseOptions" name="levelTypeP2">
                  <option value="HEF">Hall Sense</option>
                  <option value="PULE">Pulse Empty</option>
                  <option value="PULF">Pulse Full</option>
                  <option value="LLO">Steady</option>
                </select>
              </div>
              <div class="settings-row" id="pump2LevelNoncRow" style="display:none;">
                <label for="pump2LevelNonc"><strong>Type</strong>
                  <span class="var-label">levelNoncP2</span>
                </label>
                <select id="pump2LevelNonc" name="levelNoncP2">
                  <option value="NO">NO</option>
                  <option value="NC">NC</option>
                </select>
              </div>
            </div>
          </div>
          <div class="btn-row" id="testModeBtnRow" style="margin-bottom:10px;">
            <button type="button" class="btn" id="testModeBtn">Test</button>
            <button type="submit" class="btn" id="saveSettingsBtn">Save Settings</button>
          </div>
        </form>
        <!-- Test Mode UI (hidden by default) -->
        <div id="testModePanel" style="display:none;">
          <div class="testmode-panel-container">
            <div class="testmode-row">
              <span class="testmode-label">Pump1</span>
              <button type="button" class="btn testmode-pump-btn pump-off" id="pump1TestBtn">ON/OFF</button>
            </div>
            <div class="testmode-row" id="proxy1Row">
              <span class="testmode-label">Proxy1</span>
              <span class="testmode-indicator proxy-off" id="proxy1Indicator">OFF</span>
            </div>
            <div class="testmode-row" id="proxy2Row">
              <span class="testmode-label">Proxy2</span>
              <span class="testmode-indicator proxy-off" id="proxy2Indicator">OFF</span>
            </div>
          </div>
          <div class="btn-row" style="margin-top:24px;">
            <button type="button" class="btn" id="testModeBackBtn">Back</button>
            <button type="submit" class="btn" id="testModeSaveBtn">Save Settings</button>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tabWiFi">
        <form id="wifiFormMain" autocomplete="off">
          <div class="fields-flex">
            <div class="input-group">
              <label for="ssid-main">WiFi Name:</label>
              <input type="text" id="ssid-main" name="ssid" required>
            </div>
            <div class="input-group">
              <label for="password-main">WiFi Password:</label>
              <input type="password" id="password-main" name="password" required>
            </div>
          </div>
          <div class="btn-row">
            <button type="submit" class="btn">SAVE</button>
          </div>
        </form>
      </div>
    </div>
    <script>
window.onload = function() {
  let lastBlockCurrentP1Value = undefined;
  let userBlockCurrentP1Value = undefined;
  let latestSettingsPayload = { p1: null, p2: null, xtra: null };
  let serial = null;
  let client = null;
  let queryTimeout = null;

  // Blockage Current logic for Pump1
  const blockageManual = document.getElementById('blockageManual');
  const blockageAuto = document.getElementById('blockageAuto');
  const blockageManualRow = document.getElementById('blockageManualRow');
  const blockageAutoRow = document.getElementById('blockageAutoRow');
  const blockageManualValue = document.getElementById('blockageManualValue');
  const blockageAutoValue = document.getElementById('blockageAutoValue');

  // Blockage Current logic for Pump2
  const pump2BlockageManual = document.getElementById('pump2BlockageManual');
  const pump2BlockageAuto = document.getElementById('pump2BlockageAuto');
  const pump2BlockageManualRow = document.getElementById('pump2BlockageManualRow');
  const pump2BlockageAutoRow = document.getElementById('pump2BlockageAutoRow');
  const pump2BlockageManualValue = document.getElementById('pump2BlockageManualValue');
  const pump2BlockageAutoValue = document.getElementById('pump2BlockageAutoValue');

  // Track user edits
  blockageManualValue.addEventListener('input', function() {
    userBlockCurrentP1Value = this.value;
  });

  function updateBlockageRows() {
    if (blockageManual.checked) {
      blockageManualRow.style.display = '';
      blockageAutoRow.style.display = 'none';
      if (userBlockCurrentP1Value !== undefined && userBlockCurrentP1Value !== '') {
        blockageManualValue.value = userBlockCurrentP1Value;
      } else if (lastBlockCurrentP1Value !== undefined && lastBlockCurrentP1Value !== null && lastBlockCurrentP1Value !== '') {
        blockageManualValue.value = lastBlockCurrentP1Value;
      } else {
        blockageManualValue.value = '';
        blockageManualValue.placeholder = 'Enter motor current';
      }
    } else if (blockageAuto.checked) {
      blockageManualRow.style.display = 'none';
      blockageAutoRow.style.display = '';
      blockageAutoValue.value = 'Pump starting';
    } else {
      blockageManualRow.style.display = 'none';
      blockageAutoRow.style.display = 'none';
    }
  }
  blockageManual.addEventListener('change', updateBlockageRows);
  blockageAuto.addEventListener('change', updateBlockageRows);

  function updatePump2BlockageRows() {
    if (pump2BlockageManual.checked) {
      pump2BlockageManualRow.style.display = '';
      pump2BlockageAutoRow.style.display = 'none';
    } else if (pump2BlockageAuto.checked) {
      pump2BlockageManualRow.style.display = 'none';
      pump2BlockageAutoRow.style.display = '';
      pump2BlockageAutoValue.value = 'Pump starting';
    } else {
      pump2BlockageManualRow.style.display = 'none';
      pump2BlockageAutoRow.style.display = 'none';
    }
  }
  pump2BlockageManual.addEventListener('change', updatePump2BlockageRows);
  pump2BlockageAuto.addEventListener('change', updatePump2BlockageRows);

  // Tab switching logic
  const tabMainBtn = document.getElementById('tabMainBtn');
  const tabLiveBtn = document.getElementById('tabLiveBtn');
  const tabSettingsBtn = document.getElementById('tabSettingsBtn');
  const tabWiFiBtn = document.getElementById('tabWiFiBtn');
  const tabMain = document.getElementById('tabMain');
  const tabLive = document.getElementById('tabLive');
  const tabSettings = document.getElementById('tabSettings');
  const tabWiFi = document.getElementById('tabWiFi');

  tabMainBtn.onclick = function() {
    tabMainBtn.classList.add('active');
    tabLiveBtn.classList.remove('active');
    tabSettingsBtn.classList.remove('active');
    tabWiFiBtn.classList.remove('active');
    tabMain.classList.add('active');
    tabLive.classList.remove('active');
    tabSettings.classList.remove('active');
    tabWiFi.classList.remove('active');
  };
  tabLiveBtn.onclick = function() {
    tabLiveBtn.classList.add('active');
    tabMainBtn.classList.remove('active');
    tabSettingsBtn.classList.remove('active');
    tabWiFiBtn.classList.remove('active');
    tabLive.classList.add('active');
    tabMain.classList.remove('active');
    tabSettings.classList.remove('active');
    tabWiFi.classList.remove('active');
  };
  tabSettingsBtn.onclick = function() {
    tabSettingsBtn.classList.add('active');
    tabMainBtn.classList.remove('active');
    tabLiveBtn.classList.remove('active');
    tabWiFiBtn.classList.remove('active');
    tabSettings.classList.add('active');
    tabMain.classList.remove('active');
    tabLive.classList.remove('active');
    tabWiFi.classList.remove('active');
    // Always re-query settings when opening the tab
    if (client && client.connected && typeof client.publish === "function") {
      const serial = getSerialFromURL();
      if (serial) {
        client.publish(`a3/${serial}/queryP1Settings`, serial);
        client.publish(`a3/${serial}/queryP2Settings`, serial);
        client.publish(`a3/${serial}/queryXtraSettings`, serial);
        showStatus("Requesting settings from device...");
      }
    }
  };
  tabWiFiBtn.onclick = function() {
    tabWiFiBtn.classList.add('active');
    tabMainBtn.classList.remove('active');
    tabLiveBtn.classList.remove('active');
    tabSettingsBtn.classList.remove('active');
    tabWiFi.classList.add('active');
    tabMain.classList.remove('active');
    tabLive.classList.remove('active');
    tabSettings.classList.remove('active');
  };

  // Show/hide logic for dwell time and options fields
  function setupShowHideCheckbox(triggerId, targetRowId) {
    const trigger = document.getElementById(triggerId);
    const target = document.getElementById(targetRowId);
    if (trigger && target) {
      trigger.addEventListener('change', function() {
        target.style.display = this.checked ? '' : 'none';
      });
    }
  }
  setupShowHideCheckbox('proxy1', 'dwellTime1Row');
  setupShowHideCheckbox('proxy2', 'dwellTime2Row');
  setupShowHideCheckbox('levelSense', 'levelSenseOptionsRow');
  setupShowHideCheckbox('extLamp', 'extLampOptionsRow');
  setupShowHideCheckbox('pump2', 'pump2SettingsGroup');
  setupShowHideCheckbox('pump2Proxy1', 'pump2DwellTime1Row');
  setupShowHideCheckbox('pump2Proxy2', 'pump2DwellTime2Row');
  setupShowHideCheckbox('pump2LevelSense', 'pump2LevelSenseOptionsRow');
  setupShowHideCheckbox('pump2ExtLamp', 'pump2ExtLampOptionsRow');

  document.getElementById('levelSenseOptions').addEventListener('change', function() {
    const noncRow = document.getElementById('levelNoncRow');
    if (this.value === 'LLO') {
      noncRow.style.display = '';
    } else {
      noncRow.style.display = 'none';
    }
  });

  document.getElementById('pump2LevelSenseOptions').addEventListener('change', function() {
    const noncRow = document.getElementById('pump2LevelNoncRow');
    if (this.value === 'LLO') {
      noncRow.style.display = '';
    } else {
      noncRow.style.display = 'none';
    }
  });

  // Test Mode logic
  const testModeBtn = document.getElementById('testModeBtn');
  const testModePanel = document.getElementById('testModePanel');
  const settingsForm = document.getElementById('settingsForm');
  const testModeBackBtn = document.getElementById('testModeBackBtn');
  const proxy1Row = document.getElementById('proxy1Row');
  const proxy2Row = document.getElementById('proxy2Row');

  function updateProxyRowsVisibility() {
    proxy1Row.style.display = document.getElementById('proxy1').checked ? '' : 'none';
    proxy2Row.style.display = document.getElementById('proxy2').checked ? '' : 'none';
  }

  testModeBtn.onclick = function() {
    settingsForm.style.display = 'none';
    testModePanel.style.display = '';
    updateProxyRowsVisibility();
  };
  testModeBackBtn.onclick = function() {
    testModePanel.style.display = 'none';
    settingsForm.style.display = '';
  };

  document.getElementById('proxy1').addEventListener('change', updateProxyRowsVisibility);
  document.getElementById('proxy2').addEventListener('change', updateProxyRowsVisibility);

  // Track pump state for correct MQTT payload
  let pump1IsOn = false;
  const pump1TestBtn = document.getElementById('pump1TestBtn');
  pump1TestBtn.onclick = function() {
    if (client) {
      const payload = pump1IsOn ? "off" : "on";
      client.publish(`a3/${serial}/test/pump1`, payload);
      console.log(`Published test command for Pump1: ${payload}`);
    }
  };

  // MQTT config
  const hivemqBrokerUrl = 'wss://bd58f8878eef4f5eb73ac65312b10130.s1.eu.hivemq.cloud:8884/mqtt';
  const hivemqUsername = 'a3Admin';
  const hivemqPassword = 'DontLetMeIn247';

  function getSerialFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("serial");
  }

  function showStatus(msg, isError = false) {
    const status = document.getElementById("status-message");
    status.textContent = msg;
    status.className = "status-message" + (isError ? " error" : "");
  }

  function connectMQTTAndQuery() {
    serial = getSerialFromURL();
    if (!serial) {
      showStatus("No serial number provided in URL.", true);
      return;
    }
    document.getElementById("serial-number").textContent = serial;
    showStatus("Connecting to device...", false);

    client = mqtt.connect(hivemqBrokerUrl, {
      clientId: 'webClient-' + Math.random().toString(16).substr(2, 8),
      username: hivemqUsername,
      password: hivemqPassword,
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 2000,
    });

    client.on('connect', function() {
      showStatus("Connected. Querying device...");
      const responseTopic = `a3/${serial}/serialResponse`;
      const P1testResponseTopic = `a3/${serial}/test/pump1`;
      const P1prox1TestTopic = `a3/${serial}/test/proxy1`;
      const P1prox2TestTopic = `a3/${serial}/test/proxy2`;
      const P1settingsReplyTopic = `a3/${serial}/P1settingsReply`;
      const P2settingsReplyTopic = `a3/${serial}/P2settingsReply`;
      const xtraSettingsReplyTopic = `a3/${serial}/xtraSettingsReply`;

      // Subscribe to all topics first
      client.subscribe(responseTopic);
      client.subscribe(P1testResponseTopic);
      client.subscribe(P1prox1TestTopic);
      client.subscribe(P1prox2TestTopic);
      client.subscribe(P1settingsReplyTopic);
      client.subscribe(P2settingsReplyTopic);
      client.subscribe(xtraSettingsReplyTopic);

      // Always query serial on connect!
      client.publish(`a3/${serial}/querySerial`, "mainQuery");

      queryTimeout = setTimeout(() => {
        showStatus("No response from device. Please check connection and try again.", true);
      }, 10000);
    });

    client.on('message', function(topic, message) {
      console.log("MQTT message received:", topic, message.toString());
      if (topic === `a3/${serial}/serialResponse`) {
        try {
          const payload = JSON.parse(message.toString());
          if (payload.serial) {
            document.getElementById("serial-number").textContent = payload.serial;
          }
          if (payload.version) {
            document.getElementById("ver-string").textContent = payload.version;
          }
          showStatus("");
          clearTimeout(queryTimeout);

          // Now that we have the serial response, request all settings
          client.publish(`a3/${serial}/queryP1Settings`, serial);
          client.publish(`a3/${serial}/queryP2Settings`, serial);
          client.publish(`a3/${serial}/queryXtraSettings`, serial);

        } catch (e) {
          showStatus("Error parsing device response.", true);
        }
      }
      if (topic === `a3/${serial}/P1settingsReply`) {
        latestSettingsPayload.p1 = message.toString();
        if (latestSettingsPayload.p1 && latestSettingsPayload.p2 && latestSettingsPayload.xtra) {
          applySettingsFromPayload(latestSettingsPayload);
          showStatus("Settings loaded from device.");
        }
      }
      if (topic === `a3/${serial}/P2settingsReply`) {
        latestSettingsPayload.p2 = message.toString();
        if (latestSettingsPayload.p1 && latestSettingsPayload.p2 && latestSettingsPayload.xtra) {
          applySettingsFromPayload(latestSettingsPayload);
          showStatus("Settings loaded from device.");
        }
      }
      if (topic === `a3/${serial}/xtraSettingsReply`) {
        latestSettingsPayload.xtra = message.toString();
        if (latestSettingsPayload.p1 && latestSettingsPayload.p2 && latestSettingsPayload.xtra) {
          applySettingsFromPayload(latestSettingsPayload);
          showStatus("Settings loaded from device.");
        }
      }
      if (topic === `a3/${serial}/test/pump1`) {
        const btn = document.getElementById('pump1TestBtn');
        if (!btn) return;
        const payload = message.toString();
        if (payload === "running") {
          btn.classList.add('pump-on');
          btn.classList.remove('pump-off');
          btn.textContent = "ON";
          pump1IsOn = true;
        } else if (payload === "stopped") {
          btn.classList.remove('pump-on');
          btn.classList.add('pump-off');
          btn.textContent = "OFF";
          pump1IsOn = false;
        }
      }
      if (topic === `a3/${serial}/test/proxy1`) {
        const ind = document.getElementById('proxy1Indicator');
        if (!ind) return;
        const payload = message.toString();
        if (payload === "on") {
          ind.classList.add('proxy-on');
          ind.classList.remove('proxy-off');
          ind.textContent = "ON";
        } else if (payload === "off") {
          ind.classList.remove('proxy-on');
          ind.classList.add('proxy-off');
          ind.textContent = "OFF";
        }
      }
      if (topic === `a3/${serial}/test/proxy2`) {
        const ind = document.getElementById('proxy2Indicator');
        if (!ind) return;
        const payload = message.toString();
        if (payload === "on") {
          ind.classList.add('proxy-on');
          ind.classList.remove('proxy-off');
          ind.textContent = "ON";
        } else if (payload === "off") {
          ind.classList.remove('proxy-on');
          ind.classList.add('proxy-off');
          ind.textContent = "OFF";
        }
      }
    });

    client.on('error', function() {
      showStatus("MQTT connection error.", true);
    });
  }

  document.getElementById("backBtn").onclick = function() {
    window.location.href = "index.html";
  };
  connectMQTTAndQuery();
};
</script>
  </body>
</html>