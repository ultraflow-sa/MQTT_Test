<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A3 Setup</title>
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/style.css?v=' + new Date().getTime();
      document.head.appendChild(link);
    </script>
    <style>
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
    </style>
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
  </head>
  <body>
    <div class="header-box">
      <h1>A3 Setup</h1>
    </div>
    <div class="content main-content">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" id="tabMainBtn" type="button">Main</button>
        <button class="tab-btn" id="tabLiveBtn" type="button">Live</button>
        <button class="tab-btn" id="tabSettingsBtn" type="button">Settings</button>
        <button class="tab-btn" id="tabWiFiBtn" type="button">WiFi</button>
      </div>
      <!-- Tab Contents -->
      <div class="tab-content active" id="tabMain">
        <div class="info-row">
          <div>
            Serial: <span id="serial-number" class="info-value">...</span>
          </div>
          <div>
            Version: <span id="ver-string" class="info-value">...</span>
          </div>
        </div>
        <div id="status-message" class="status-message"></div>
        <div class="btn-row">
          <button class="btn" id="backBtn">CHANGE</button>
        </div>
      </div>
      <div class="tab-content" id="tabLive">
        <div id="livePanel">
          <div class="live-panel-container panel-container">
            <!-- Pump1 Section -->
            <div class="live-pump-section pump-section">
              <!-- Pump1 Button Container -->
              <div class="live-pump-header pump-header">
                <span class="live-pump-title pump-title">Pump1</span>
                <button type="button" class="btn live-run-btn pump-btn pump-btn-stopped" id="pump1LiveBtn">RUN</button>
              </div>
              
              <!-- Pump1 Status Rows -->
              <div class="live-row control-row" id="livePump1PauseRow">
                <span class="live-label control-label">Pause Time</span>
                <span class="live-value control-value" id="livePump1PauseValue">00:00:00</span>
              </div>
              <div class="live-row control-row" id="livePump1CyclesRow">
                <span class="live-label control-label">Time/Cycles</span>
                <span class="live-value control-value" id="livePump1CyclesValue">00:00</span>
              </div>
              
              <!-- Pump1 Indicators Container -->
              <div class="indicators-container" id="livePump1IndicatorsContainer">
                <div class="indicator-group" id="livePump1Proxy1Row" style="display:none;">
                  <span class="indicator-label">Proxy1</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump1Proxy1"></span>
                </div>
                <div class="indicator-group" id="livePump1Proxy2Row" style="display:none;">
                  <span class="indicator-label">Proxy2</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump1Proxy2"></span>
                </div>
                <div class="indicator-group" id="livePump1LevelRow" style="display:none;">
                  <span class="indicator-label">Level</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump1Level"></span>
                </div>
                <div class="indicator-group" id="livePump1ExtLampRow" style="display:none;">
                  <span class="indicator-label">Sys Fault</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump1ExtLamp"></span>
                </div>
              </div>
            </div>
            
            <!-- Pump Section Separator -->
            <div class="pump-separator"></div>
            
            <!-- Pump2 Section -->
            <div class="live-pump-section pump-section" id="livePump2Section" style="display:none;">
              <!-- Pump2 Button Container -->
              <div class="live-pump-header pump-header">
                <span class="live-pump-title pump-title">Pump2</span>
                <button type="button" class="btn live-run-btn pump-btn pump-btn-stopped" id="pump2LiveBtn">RUN</button>
              </div>
              
              <!-- Pump2 Status Rows -->
              <div class="live-row control-row" id="livePump2PauseRow">
                <span class="live-label control-label">Pause Time</span>
                <span class="live-value control-value" id="livePump2PauseValue">00:00:00</span>
              </div>
              <div class="live-row control-row" id="livePump2CyclesRow">
                <span class="live-label control-label">Time/Cycles</span>
                <span class="live-value control-value" id="livePump2CyclesValue">00:00</span>
              </div>
              
              <!-- Pump2 Indicators Container -->
              <div class="indicators-container" id="livePump2IndicatorsContainer">
                <div class="indicator-group" id="livePump2Proxy1Row" style="display:none;">
                  <span class="indicator-label">Proxy1</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump2Proxy1"></span>
                </div>
                <div class="indicator-group" id="livePump2Proxy2Row" style="display:none;">
                  <span class="indicator-label">Proxy2</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump2Proxy2"></span>
                </div>
                <div class="indicator-group" id="livePump2LevelRow" style="display:none;">
                  <span class="indicator-label">Level</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump2Level"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tabSettings">
        <form id="settingsForm" autocomplete="off">
          <div class="settings-group" id="settingsFields">
            <!-- Mode -->
            <div class="settings-row">
              <label for="modeSelect"><strong>Mode</strong></label>
              <select id="modeSelect" name="mode">
                <option value="PLS">PLS</option>
                <option value="SLS">SLS</option>
              </select>
            </div>
            <!-- Pause Time -->
            <div class="settings-row">
              <label for="pauseTime"><strong>Pause Time</strong></label>
              <input type="text" id="pauseTime" name="pauseTime" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
            </div>
            <!-- Time/Cycles -->
            <div class="settings-row">
              <label for="timeCyclesSelect"><strong>Time/Cycles</strong></label>
              <select id="timeCyclesSelect" name="timeCycles">
                <option value="TIME">Time</option>
                <option value="CYCLE">Cycles</option>
              </select>
            </div>
            <!-- Time/Cycles Value -->
            <div class="settings-row" id="timeCyclesValueRow">
              <label for="timeCyclesValue" id="timeCyclesValueLabel"><strong>Pump ON Time</strong></label>
              <input type="text" id="timeCyclesValue" name="timeCyclesValue" placeholder="00:00">
            </div>
            <!-- Proxy1 -->
            <div class="settings-row">
              <label for="proxy1"><strong>Proxy1</strong></label>
              <input type="checkbox" id="proxy1" name="proxy1">
            </div>
            <!-- Dwell Time (Proxy1) -->
            <div class="settings-row" id="dwellTime1Row" style="display:none;">
              <label for="dwellTime1"><strong>Dwell Time</strong></label>
              <input type="text" id="dwellTime1" name="dwellTime1" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
            </div>
            <!-- Proxy2 -->
            <div class="settings-row">
              <label for="proxy2"><strong>Proxy2</strong></label>
              <input type="checkbox" id="proxy2" name="proxy2">
            </div>
            <div class="settings-row" id="dwellTime2Row" style="display:none;">
              <label for="dwellTime2"><strong>Dwell Time</strong></label>
              <input type="text" id="dwellTime2" name="dwellTime2" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
            </div>
            <!-- Level Sense -->
            <div class="settings-row">
              <label for="levelSense"><strong>Level Sense</strong></label>
              <input type="checkbox" id="levelSense" name="levelSense">
            </div>
            <div class="settings-row" id="levelSenseOptionsRow" style="display:none;">
              <label for="levelSenseOptions"><strong>Level Sense Mode</strong></label>
              <select id="levelSenseOptions" name="levelSenseOptions">
                <option value="HEF">Hall Sense</option>
                <option value="PULE">Pulse Empty</option>
                <option value="PULF">Pulse Full</option>
                <option value="LLO">Steady</option>
              </select>
            </div>
            <div class="settings-row" id="levelNoncRow" style="display:none;">
              <label for="levelNonc"><strong>Type</strong></label>
              <select id="levelNonc" name="levelNonc">
                <option value="NO">NO</option>
                <option value="NC">NC</option>
              </select>
            </div>
            <!-- Ext Lamp -->
            <div class="settings-row">
              <label for="extLamp"><strong>Sys Fault</strong></label>
              <input type="checkbox" id="extLamp" name="extLamp">
            </div>
            <div class="settings-row" id="extLampOptionsRow" style="display:none;">
              <label for="extLampOptions"><strong>Lamp Mode</strong></label>
              <select id="extLampOptions" name="extLampOptions">
                <option value="RGB">RGB</option>
                <option value="STE">Steady</option>
                <option value="FLA">Flash</option>
              </select>
            </div>
            <!-- Blockage Current -->
            <div class="settings-row">
              <div style="display: flex; flex-direction: column; width: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px;">
                  <label><strong>Blockage Current</strong></label>
                  <button type="button" class="btn blockage-test-btn" id="blockageTestBtn">Test Pump</button>
                </div>
                <div style="text-align: center; width: 100%;">
                  <input type="text" id="blockageCurrentValue" name="blockageCurrentValue" placeholder="Enter motor current" style="width: 200px;">
                </div>
              </div>
            </div>
            <!-- Pump2 -->
            <div class="settings-row">
              <label for="pump2"><strong>Pump2</strong></label>
              <input type="checkbox" id="pump2" name="pump2">
            </div>
            <div id="pump2SettingsGroup" style="display:none;">
              <div class="settings-row">
                <label for="pump2Mode"><strong>Mode</strong></label>
                <select id="pump2Mode" name="pump2Mode">
                  <option value="PLS">PLS</option>
                  <option value="SLS">SLS</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2PauseTime"><strong>Pause Time</strong></label>
                <input type="text" id="pump2PauseTime" name="pump2PauseTime" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
              </div>
              <div class="settings-row">
                <label for="pump2TimeCyclesSelect"><strong>Time/Cycles</strong></label>
                <select id="pump2TimeCyclesSelect" name="pump2TimeCycles">
                  <option value="TIME">Time</option>
                  <option value="CYCLE">Cycles</option>
                </select>
              </div>
              <div class="settings-row" id="pump2TimeCyclesValueRow">
                <label for="pump2TimeCyclesValue" id="pump2TimeCyclesValueLabel"><strong>Pump ON Time</strong></label>
                <input type="text" id="pump2TimeCyclesValue" name="pump2TimeCyclesValue" placeholder="00:00">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy1"><strong>Proxy1</strong></label>
                <input type="checkbox" id="pump2Proxy1" name="pump2Proxy1">
              </div>
              <div class="settings-row" id="pump2DwellTime1Row" style="display:none;">
                <label for="pump2DwellTime1"><strong>Dwell Time</strong></label>
                <input type="text" id="pump2DwellTime1" name="pump2DwellTime1" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy2"><strong>Proxy2</strong></label>
                <input type="checkbox" id="pump2Proxy2" name="pump2Proxy2">
              </div>
              <div class="settings-row" id="pump2DwellTime2Row" style="display:none;">
                <label for="pump2DwellTime2"><strong>Dwell Time</strong></label>
                <input type="text" id="pump2DwellTime2" name="pump2DwellTime2" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
              </div>
              <div class="settings-row">
                <label for="pump2LevelSense"><strong>Level Sense</strong></label>
                <input type="checkbox" id="pump2LevelSense" name="pump2LevelSense">
              </div>
              <div class="settings-row" id="pump2LevelSenseOptionsRow" style="display:none;">
                <label for="pump2LevelSenseOptions"><strong>Level Sense Mode</strong></label>
                <select id="pump2LevelSenseOptions" name="pump2LevelSenseOptions">
                  <option value="HEF">Hall Sense</option>
                  <option value="PULE">Pulse Empty</option>
                  <option value="PULF">Pulse Full</option>
                  <option value="LLO">Steady</option>
                </select>
              </div>
              <div class="settings-row" id="pump2LevelNoncRow" style="display:none;">
                <label for="pump2LevelNonc"><strong>Type</strong></label>
                <select id="pump2LevelNonc" name="pump2LevelNonc">
                  <option value="NO">NO</option>
                  <option value="NC">NC</option>
                </select>
              </div>
              <div class="settings-row">
                <div style="display: flex; flex-direction: column; width: 100%;">
                  <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px;">
                    <label><strong>Blockage Current</strong></label>
                    <button type="button" class="btn blockage-test-btn" id="pump2BlockageTestBtn">Test Pump</button>
                  </div>
                  <div style="text-align: center; width: 100%;">
                    <input type="text" id="pump2BlockageCurrentValue" name="pump2BlockageCurrentValue" placeholder="Enter motor current" style="width: 200px;">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="btn-row" id="testModeBtnRow" style="margin-bottom:10px;">
            <button type="button" class="btn" id="testModeBtn">Test</button>
            <button type="submit" class="btn" id="saveSettingsBtn">Save Settings</button>
          </div>
        </form>
        <!-- Test Mode UI (hidden by default) -->
        <div id="testModePanel" style="display:none;">
          <div class="testmode-panel-container panel-container">
            <!-- Pump1 Section -->
            <div class="pump-control-section">
              <div class="testmode-row control-row">
                <span class="testmode-label control-label">Pump1</span>
                <button type="button" class="btn testmode-pump-btn pump-btn pump-off" id="pump1TestBtn">ON</button>
              </div>
              
              <!-- Pump1 Indicators Container -->
              <div class="indicators-container" id="testPump1IndicatorsContainer">
                <div class="indicator-group" id="proxy1Row">
                  <span class="indicator-label">Proxy1</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="proxy1Indicator"></span>
                </div>
                <div class="indicator-group" id="proxy2Row">
                  <span class="indicator-label">Proxy2</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="proxy2Indicator"></span>
                </div>
                <div class="indicator-group" id="pump1LevelRow" style="display:none;">
                  <span class="indicator-label">Level</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="pump1LevelIndicator"></span>
                </div>
                <div class="indicator-group" id="extLampRow" style="display:none;">
                  <span class="indicator-label">Sys Fault</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="extLampIndicator"></span>
                </div>
              </div>
            </div>
            
            <!-- Pump Section Separator -->
            <div class="pump-separator"></div>
            
            <!-- Pump2 Section -->
            <div class="pump-control-section" id="pump2TestSection" style="display:none;">
              <div class="testmode-row control-row" id="pump2TestRow">
                <span class="testmode-label control-label">Pump2</span>
                <button type="button" class="btn testmode-pump-btn pump-btn pump-off" id="pump2TestBtn">ON</button>
              </div>
              
              <!-- Pump2 Indicators Container -->
              <div class="indicators-container" id="testPump2IndicatorsContainer">
                <div class="indicator-group" id="pump2Proxy1Row" style="display:none;">
                  <span class="indicator-label">Proxy1</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="pump2Proxy1Indicator"></span>
                </div>
                <div class="indicator-group" id="pump2Proxy2Row" style="display:none;">
                  <span class="indicator-label">Proxy2</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="pump2Proxy2Indicator"></span>
                </div>
                <div class="indicator-group" id="pump2LevelRow" style="display:none;">
                  <span class="indicator-label">Level</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="pump2LevelIndicator"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="btn-row" style="margin-top:24px;">
            <button type="button" class="btn" id="testModeBackBtn">Back</button>
            <button type="submit" class="btn" id="testModeSaveBtn">Save Settings</button>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tabWiFi">
        <form id="wifiFormMain" autocomplete="off">
          <div class="fields-flex">
            <div class="input-group">
              <label for="ssid-main">WiFi Name:</label>
              <input type="text" id="ssid-main" name="ssid" required>
            </div>
            <div class="input-group">
              <label for="password-main">WiFi Password:</label>
              <input type="password" id="password-main" name="password" required>
            </div>
          </div>
          <div class="btn-row">
            <button type="submit" class="btn">SAVE</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      let latestSettingsPayload = { p1: null, p2: null, xtra: null };
      let p1AutoCalibrating = false;
      let p2AutoCalibrating = false;
      let isAlreadyConnected = false;
      let settingsPreloaded = false;
      let preloadingInProgress = false;
      let preloadStep = 0; // 0 = not started, 1 = P1, 2 = P2, 3 = Xtra, 4 = complete

      // Blockage Current logic for Pump1 and Pump2
      const blockageCurrentValue = document.getElementById('blockageCurrentValue');
      const pump2BlockageCurrentValue = document.getElementById('pump2BlockageCurrentValue');
      const blockageTestBtn = document.getElementById('blockageTestBtn');
      const pump2BlockageTestBtn = document.getElementById('pump2BlockageTestBtn');

      // Track pump state for correct MQTT payload
      let pump1IsOn = false;
      let pump2IsOn = false; // ADD this line

      // Add pump1 test button click handler
      const pump1TestBtn = document.getElementById('pump1TestBtn');
      if (pump1TestBtn) {
        pump1TestBtn.onclick = function() {
          if (client && client.connected && serial) {
            const payload = pump1IsOn ? "off" : "on";
            client.publish(`a3/${serial}/test/pump1`, payload);
            console.log(`Published test command for Pump1: ${payload}`);
          }
        };
      }

      // ADD pump2 test button click handler
      const pump2TestBtn = document.getElementById('pump2TestBtn');
      if (pump2TestBtn) {
        pump2TestBtn.onclick = function() {
          if (client && client.connected && serial) {
            const payload = pump2IsOn ? "off" : "on";
            client.publish(`a3/${serial}/test/pump2`, payload);
            console.log(`Published test command for Pump2: ${payload}`);
          }
        };
      }

      // Blockage test button handlers
      if (blockageTestBtn) {
        blockageTestBtn.onclick = function() {
          if (client && client.connected && serial) {
            p1AutoCalibrating = true;
            blockageCurrentValue.value = 'Pump Starting';
            client.publish(`a3/${serial}/test/pump1`, "currentAutoCalibrate");
            console.log("Started P1 blockage current test");
          }
        };
      }

      if (pump2BlockageTestBtn) {
        pump2BlockageTestBtn.onclick = function() {
          if (client && client.connected && serial) {
            p2AutoCalibrating = true;
            pump2BlockageCurrentValue.value = 'Pump Starting';
            client.publish(`a3/${serial}/test/pump2`, "currentAutoCalibrate");
            console.log("Started P2 blockage current test");
          }
        };
      }

      // Auto calibration functions
      function startP1AutoCalibration() {
        if (client && client.connected && serial) {
          p1AutoCalibrating = true;
          client.publish(`a3/${serial}/test/pump1`, "currentAutoCalibrate");
          console.log("Started P1 auto calibration");
        }
      }

      function startP2AutoCalibration() {
        if (client && client.connected && serial) {
          p2AutoCalibrating = true;
          const topic = `a3/${serial}/test/pump2`;
          const result = client.publish(topic, "currentAutoCalibrate");
          console.log("Started P2 auto calibration - p2AutoCalibrating set to:", p2AutoCalibrating);
        } else {
          console.log("Cannot start P2 auto calibration - requirements not met");
        }
      }

      // Time conversion functions
      function secondsToHMS(seconds) {
        const totalSeconds = parseInt(seconds);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const secs = totalSeconds % 60;
        
        return String(hours).padStart(2, '0') + ':' + 
               String(minutes).padStart(2, '0') + ':' + 
               String(secs).padStart(2, '0');
      }

      function secondsToMS(seconds) {
        const totalSeconds = parseInt(seconds);
        const minutes = Math.floor(totalSeconds / 60);
        const secs = totalSeconds % 60;
        
        return String(minutes).padStart(2, '0') + ':' + 
               String(secs).padStart(2, '0');
      }

      function msToSeconds(msString) {
        const parts = msString.split(':');
        if (parts.length !== 2) return 0;
        
        const minutes = parseInt(parts[0]) || 0;
        const seconds = parseInt(parts[1]) || 0;
        
        return (minutes * 60) + seconds;
      }

      function hmsToSeconds(hmsString) {
        const parts = hmsString.split(':');
        if (parts.length !== 3) return 0;
        
        const hours = parseInt(parts[0]) || 0;
        const minutes = parseInt(parts[1]) || 0;
        const seconds = parseInt(parts[2]) || 0;
        
        return (hours * 3600) + (minutes * 60) + seconds;
      }

      function validateHMSInput(input) {
        input.addEventListener('input', function() {
          let value = this.value.replace(/[^0-9:]/g, '');
          
          // Auto-format as user types
          if (value.length === 2 && !value.includes(':')) {
            value += ':';
          } else if (value.length === 5 && value.split(':').length === 2) {
            value += ':';
          }
          
          this.value = value;
        });

        input.addEventListener('blur', function() {
          let value = this.value;
          const parts = value.split(':');
          
          // Ensure we have 3 parts
          while (parts.length < 3) {
            parts.push('00');
          }
          
          // Validate and format each part
          const hours = Math.max(0, Math.min(99, parseInt(parts[0]) || 0));
          const minutes = Math.max(0, Math.min(59, parseInt(parts[1]) || 0));
          const seconds = Math.max(0, Math.min(59, parseInt(parts[2]) || 0));
          
          this.value = String(hours).padStart(2, '0') + ':' + 
                       String(minutes).padStart(2, '0') + ':' + 
                       String(seconds).padStart(2, '0');
        });
      }

      function validateMSInput(input) {
        input.addEventListener('input', function() {
          // Check if this input is for cycles mode
          const isCycleMode = this.id === 'timeCyclesValue' && 
            document.getElementById('timeCyclesSelect').value === 'CYCLE';
          const isPump2CycleMode = this.id === 'pump2TimeCyclesValue' && 
            document.getElementById('pump2TimeCyclesSelect').value === 'CYCLE';
          
          if (isCycleMode || isPump2CycleMode) {
            // For cycles mode, only allow integers
            let value = this.value.replace(/[^0-9]/g, '');
            this.value = value;
          } else {
            // For time mode, use existing MM:SS formatting
            let value = this.value.replace(/[^0-9:]/g, '');
            if (value.length === 2 && !value.includes(':')) {
              value += ':';
            }
            this.value = value;
          }
        });

        input.addEventListener('blur', function() {
          const isCycleMode = this.id === 'timeCyclesValue' && 
            document.getElementById('timeCyclesSelect').value === 'CYCLE';
          const isPump2CycleMode = this.id === 'pump2TimeCyclesValue' && 
            document.getElementById('pump2TimeCyclesSelect').value === 'CYCLE';
          
          if (isCycleMode || isPump2CycleMode) {
            // For cycles mode, ensure it's a valid integer
            const cycles = parseInt(this.value) || 0;
            this.value = cycles.toString();
          } else {
            // For time mode, use existing MM:SS formatting
            let value = this.value;
            const parts = value.split(':');
            
            while (parts.length < 2) {
              parts.push('00');
            }
            
            const minutes = Math.max(0, Math.min(999, parseInt(parts[0]) || 0));
            const seconds = Math.max(0, Math.min(59, parseInt(parts[1]) || 0));
            
            this.value = String(minutes).padStart(2, '0') + ':' + 
                        String(seconds).padStart(2, '0');
          }
        });
      }

      // Apply validation to inputs
      validateHMSInput(document.getElementById('pauseTime'));
      validateHMSInput(document.getElementById('pump2PauseTime'));
      validateMSInput(document.getElementById('timeCyclesValue'));
      validateMSInput(document.getElementById('pump2TimeCyclesValue'));
      validateHMSInput(document.getElementById('dwellTime1'));
      validateHMSInput(document.getElementById('dwellTime2'));
      validateHMSInput(document.getElementById('pump2DwellTime1'));
      validateHMSInput(document.getElementById('pump2DwellTime2'));

      // Dynamic label updates for Time/Cycles
      function updateTimeCyclesLabel() {
        const timeCyclesSelect = document.getElementById('timeCyclesSelect');
        const timeCyclesValueLabel = document.getElementById('timeCyclesValueLabel');
        const timeCyclesValue = document.getElementById('timeCyclesValue');
        
        // Don't apply conversion during settings loading
        if (window.isLoadingSettings) return;
        
        if (timeCyclesSelect.value === 'TIME') {
          timeCyclesValueLabel.innerHTML = '<strong>Pump ON Time</strong>';
          timeCyclesValue.placeholder = 'Enter Time';
          
          // Clear the value when switching to TIME mode
          timeCyclesValue.value = '00:00';
        } else if (timeCyclesSelect.value === 'CYCLE') {
          timeCyclesValueLabel.innerHTML = '<strong>Pump ON Cycles</strong>';
          timeCyclesValue.placeholder = 'Enter Cycles';
          
          // Clear the value when switching to CYCLE mode
          timeCyclesValue.value = '0';
        }
      }

      function updatePump2TimeCyclesLabel() {
        const pump2TimeCyclesSelect = document.getElementById('pump2TimeCyclesSelect');
        const pump2TimeCyclesValueLabel = document.getElementById('pump2TimeCyclesValueLabel');
        const pump2TimeCyclesValue = document.getElementById('pump2TimeCyclesValue');
        
        // Don't apply conversion during settings loading
        if (window.isLoadingSettings) return;
        
        if (pump2TimeCyclesSelect.value === 'TIME') {
          pump2TimeCyclesValueLabel.innerHTML = '<strong>Pump ON Time</strong>';
          pump2TimeCyclesValue.placeholder = 'Enter Time';
          
          // Clear the value when switching to TIME mode
          pump2TimeCyclesValue.value = '00:00';
        } else if (pump2TimeCyclesSelect.value === 'CYCLE') {
          pump2TimeCyclesValueLabel.innerHTML = '<strong>Pump ON Cycles</strong>';
          pump2TimeCyclesValue.placeholder = 'Enter Cycles';
          
          // Clear the value when switching to CYCLE mode
          pump2TimeCyclesValue.value = '0';
        }
      }

      document.getElementById('timeCyclesSelect').addEventListener('change', updateTimeCyclesLabel);
      document.getElementById('pump2TimeCyclesSelect').addEventListener('change', updatePump2TimeCyclesLabel);

      // Tab switching logic
      const tabMainBtn = document.getElementById('tabMainBtn');
      const tabLiveBtn = document.getElementById('tabLiveBtn');
      const tabSettingsBtn = document.getElementById('tabSettingsBtn');
      const tabWiFiBtn = document.getElementById('tabWiFiBtn');
      const tabMain = document.getElementById('tabMain');
      const tabLive = document.getElementById('tabLive');
      const tabSettings = document.getElementById('tabSettings');
      const tabWiFi = document.getElementById('tabWiFi');

      function switchAwayFromSettings() {
        // Send pump off messages when switching away from settings tab
        const testModePanel = document.getElementById('testModePanel');
        if (testModePanel && testModePanel.style.display !== 'none') {
          sendPumpOffMessages();
        }
      }

      // Add these variables at the top to store device info
      let deviceSerial = null;
      let deviceVersion = null;
      // Live button states
      let pump1LiveRunning = false;
      let pump2LiveRunning = false;
      let pump1LiveBtn = null;
      let pump2LiveBtn = null;

      // Update the main tab click handler
      tabMainBtn.onclick = function() {
        switchAwayFromSettings();
        tabMainBtn.classList.add('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabMain.classList.add('active');
        tabLive.classList.remove('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
        
        // Only show status if settings aren't already preloaded
        if (settingsPreloaded) {
          showStatus("Device connected and ready");
        } else {
          showStatus("");
        }
      };
    
      tabLiveBtn.onclick = function() {
        // Query settings FIRST, before making tab active
        querySettingsForTab('Live');

        switchAwayFromSettings();
        tabLiveBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabLive.classList.add('active');
        tabMain.classList.remove('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
      };

      // Update the Settings tab click handler
      tabSettingsBtn.onclick = function() {
        // Query settings FIRST, before making tab active
        querySettingsForTab('Settings');

        switchAwayFromSettings();
        tabMainBtn.classList.remove('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.add('active');
        tabWiFiBtn.classList.remove('active');
        tabMain.classList.remove('active');
        tabLive.classList.remove('active');
        tabSettings.classList.add('active');
        tabWiFi.classList.remove('active');
      };

      tabWiFiBtn.onclick = function() {
        switchAwayFromSettings(); // ADD this line
        tabWiFiBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFi.classList.add('active');
        tabMain.classList.remove('active');
        tabLive.classList.remove('active');
        tabSettings.classList.remove('active');
      };

      if (pump1LiveBtn) {
        pump1LiveBtn.onclick = function() {
          if (client && client.connected && serial) {
            const command = pump1LiveRunning ? "stop" : "start";
            client.publish(`a3/${serial}/live/pump1`, command);
            console.log(`Published live command for Pump1: ${command}`);
          }
        };
      }

      if (pump2LiveBtn) {
        pump2LiveBtn.onclick = function() {
          if (client && client.connected && serial) {
            const command = pump2LiveRunning ? "stop" : "start";
            client.publish(`a3/${serial}/live/pump2`, command);
            console.log(`Published live command for Pump2: ${command}`);
          }
        };
      }

      // Show/hide logic for dwell time and options fields
      function setupShowHideCheckbox(triggerId, targetRowId) {
        const trigger = document.getElementById(triggerId);
        const target = document.getElementById(targetRowId);
        if (trigger && target) {
          trigger.addEventListener('change', function() {
            target.style.display = this.checked ? '' : 'none';
          });
        }
      }

      function preloadSettings() {
      if (preloadingInProgress) {
        console.log("Preloading already in progress, skipping");
        return;
      }
      
      if (!client || !client.connected) {
        console.log("Not connected, cannot preload settings");
        return;
      }
      
      if (!serial) {
        serial = deviceSerial || getSerialFromURL() || localStorage.getItem('deviceSerial');
      }
      
      if (!serial) {
        showStatus("No device serial available for settings preload", true);
        return;
      }
      
      console.log("Starting sequential settings preload...");
      showStatus("Loading device settings...", false);
      
      // ALWAYS clear any existing timeout first
      if (queryTimeout) {
        console.log("Clearing existing timeout before starting preload");
        clearTimeout(queryTimeout);
        queryTimeout = null;
      }

      // Reset settings payload and flags
      latestSettingsPayload = { p1: null, p2: null, xtra: null };
      settingsPreloaded = false;
      preloadingInProgress = true;
      preloadStep = 1;
      
      queryTimeout = setTimeout(() => {
        console.log("Settings preload timeout - resetting");
        preloadingInProgress = false;
        preloadStep = 0;
        queryTimeout = null;
        showStatus("Settings preload timeout - device may not be responding", true);
      }, 15000); // 15 second timeout for the entire process
      
      // Start with P1 settings
      console.log("Querying P1 settings...");
      client.publish(`a3/${serial}/queryP1Settings`, serial);
    }

      function initializeLiveMode() {
        console.log("Initializing Live Mode display");
        
        // Set initial button states - RED background with RUN label (pump is stopped)
        const pump1LiveBtn = document.getElementById('pump1LiveBtn');
        const pump2LiveBtn = document.getElementById('pump2LiveBtn');
        
        if (pump1LiveBtn) {
          pump1LiveBtn.classList.remove('pump-btn-running');
          pump1LiveBtn.classList.add('pump-btn-stopped');
          pump1LiveBtn.textContent = "RUN";
          
          // CLEAR any existing handlers first to prevent duplicates
          pump1LiveBtn.onclick = null;
          pump1LiveBtn.removeEventListener('click', handlePump1LiveClick);
          
          // Add new handler
          pump1LiveBtn.addEventListener('click', handlePump1LiveClick);
        }
        
        if (pump2LiveBtn) {
          pump2LiveBtn.classList.remove('pump-btn-running');
          pump2LiveBtn.classList.add('pump-btn-stopped');
          pump2LiveBtn.textContent = "RUN";
          
          // CLEAR any existing handlers first to prevent duplicates
          pump2LiveBtn.onclick = null;
          pump2LiveBtn.removeEventListener('click', handlePump2LiveClick);
          
          // Add new handler
          pump2LiveBtn.addEventListener('click', handlePump2LiveClick);
        }
        
        // Update live display based on current settings
        updateLiveDisplay();
      }

      // Define the click handlers as separate functions to prevent duplication
      function handlePump1LiveClick() {
        if (client && client.connected && serial) {
          const command = pump1LiveRunning ? "stop" : "start";
          const topic = `a3/${serial}/live/pump1`;
          
          console.log(`MQTT PUBLISH: Topic=${topic}, Command=${command}, State=${pump1LiveRunning ? 'running' : 'stopped'}`);
          
          try {
            const result = client.publish(topic, command);
            console.log(`Published live command for Pump1: ${command} - Result: ${result}`);
          } catch (error) {
            console.error(`Failed to publish Pump1 live command: ${error}`);
          }
        } else {
          console.warn('Cannot send Pump1 live command - MQTT not connected or serial missing');
        }
      }

      function handlePump2LiveClick() {
        if (client && client.connected && serial) {
          const command = pump2LiveRunning ? "stop" : "start";
          const topic = `a3/${serial}/live/pump2`;
          
          console.log(`MQTT PUBLISH: Topic=${topic}, Command=${command}, State=${pump2LiveRunning ? 'running' : 'stopped'}`);
          
          try {
            const result = client.publish(topic, command);
            console.log(`Published live command for Pump2: ${command} - Result: ${result}`);
          } catch (error) {
            console.error(`Failed to publish Pump2 live command: ${error}`);
          }
        } else {
          console.warn('Cannot send Pump2 live command - MQTT not connected or serial missing');
        }
      }

      // Remove the duplicate handlers at lines 753-773 and replace with this at the top level:
      // Initialize handlers once when page loads
      document.addEventListener('DOMContentLoaded', function() {
        initializeEventHandlers();
      });

      function initializeEventHandlers() {
        console.log("Initializing all event handlers");
        
        // Test mode pump handlers
        const pump1TestBtn = document.getElementById('pump1TestBtn');
        if (pump1TestBtn) {
          pump1TestBtn.removeEventListener('click', handlePump1TestClick);
          pump1TestBtn.addEventListener('click', handlePump1TestClick);
        }

        const pump2TestBtn = document.getElementById('pump2TestBtn');
        if (pump2TestBtn) {
          pump2TestBtn.removeEventListener('click', handlePump2TestClick);
          pump2TestBtn.addEventListener('click', handlePump2TestClick);
        }

        // Blockage test handlers
        const blockageTestBtn = document.getElementById('blockageTestBtn');
        if (blockageTestBtn) {
          blockageTestBtn.removeEventListener('click', handleBlockageTestClick);
          blockageTestBtn.addEventListener('click', handleBlockageTestClick);
        }

        const pump2BlockageTestBtn = document.getElementById('pump2BlockageTestBtn');
        if (pump2BlockageTestBtn) {
          pump2BlockageTestBtn.removeEventListener('click', handlePump2BlockageTestClick);
          pump2BlockageTestBtn.addEventListener('click', handlePump2BlockageTestClick);
        }
      }

      // Define all click handlers as separate functions (KEEP ONLY ONE SET)
      function handlePump1TestClick() {
        if (client && client.connected && serial) {
          const payload = pump1IsOn ? "off" : "on";
          const topic = `a3/${serial}/test/pump1`;
          
          console.log(`MQTT PUBLISH: Topic=${topic}, Payload=${payload}, CurrentState=${pump1IsOn ? 'on' : 'off'}`);
          
          try {
            const result = client.publish(topic, payload);
            console.log(`Published test command for Pump1: ${payload} - Result: ${result}`);
          } catch (error) {
            console.error(`Failed to publish Pump1 test command: ${error}`);
          }
        } else {
          console.warn('Cannot send Pump1 test command - MQTT not connected or serial missing');
        }
      }

      function handlePump2TestClick() {
        if (client && client.connected && serial) {
          const payload = pump2IsOn ? "off" : "on";
          const topic = `a3/${serial}/test/pump2`;
          
          console.log(`MQTT PUBLISH: Topic=${topic}, Payload=${payload}, CurrentState=${pump2IsOn ? 'on' : 'off'}`);
          
          try {
            const result = client.publish(topic, payload);
            console.log(`Published test command for Pump2: ${payload} - Result: ${result}`);
          } catch (error) {
            console.error(`Failed to publish Pump2 test command: ${error}`);
          }
        } else {
          console.warn('Cannot send Pump2 test command - MQTT not connected or serial missing');
        }
      }

      function handleBlockageTestClick() {
        if (client && client.connected && serial) {
          const topic = `a3/${serial}/test/pump1`;
          const command = "currentAutoCalibrate";
          
          console.log(`MQTT PUBLISH: Topic=${topic}, Command=${command}, AutoCalibrating=${p1AutoCalibrating}`);
          
          try {
            p1AutoCalibrating = true;
            blockageCurrentValue.value = 'Pump Starting';
            const result = client.publish(topic, command);
            console.log(`Started P1 blockage current test - Result: ${result}`);
          } catch (error) {
            console.error(`Failed to start P1 blockage test: ${error}`);
            p1AutoCalibrating = false;
          }
        } else {
          console.warn('Cannot start P1 blockage test - MQTT not connected or serial missing');
        }
      }

      function handlePump2BlockageTestClick() {
        if (client && client.connected && serial) {
          const topic = `a3/${serial}/test/pump2`;
          const command = "currentAutoCalibrate";
          
          console.log(`MQTT PUBLISH: Topic=${topic}, Command=${command}, AutoCalibrating=${p2AutoCalibrating}`);
          
          try {
            p2AutoCalibrating = true;
            pump2BlockageCurrentValue.value = 'Pump Starting';
            const result = client.publish(topic, command);
            console.log(`Started P2 blockage current test - Result: ${result}`);
          } catch (error) {
            console.error(`Failed to start P2 blockage test: ${error}`);
            p2AutoCalibrating = false;
          }
        } else {
          console.warn('Cannot start P2 blockage test - MQTT not connected or serial missing');
        }
      }

      // REMOVE THE SECOND DUPLICATE SECTION starting around line 1020
      // Remove everything from the second "document.addEventListener('DOMContentLoaded'..." 
      // down to the second set of function definitions

      // Keep only ONE connectMQTTAndQuery function (the existing one should work)
      // Make sure you have these missing functions that are needed:

      function getSerialFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("serial");
      }

      function showStatus(msg, isError = false) {
        const status = document.getElementById("status-message");
        if (status) {
          status.textContent = msg;
          status.className = "status-message" + (isError ? " error" : "");
        }
      }

      // Add the missing MQTT configuration and missing functions:
      const hivemqBrokerUrl = 'wss://bd58f8878eef4f5eb73ac65312b10130.s1.eu.hivemq.cloud:8884/mqtt';
      const hivemqUsername = 'a3Admin';
      const hivemqPassword = 'DontLetMeIn247';

      let client = null;
      let serial = null;
      let queryTimeout = null;

      // Add the missing applySettingsFromPayload function:
      function applySettingsFromPayload(payloads) {
        console.log("applySettingsFromPayload called with:", payloads);
        
        // Clear any active timeout when settings are being applied
        if (queryTimeout) {
          console.log("Settings being applied, clearing any active timeout");
          clearTimeout(queryTimeout);
          queryTimeout = null;
        }
        
        // Set flag to prevent auto-logic during loading
        window.isLoadingSettings = true;
        
        try {
          // Parse settings
          const settingsP1 = JSON.parse(payloads.p1);
          const settingsP2 = JSON.parse(payloads.p2);
          const settingsXtra = JSON.parse(payloads.xtra);
          
          console.log("Parsed P1 settings:", settingsP1);
          console.log("Parsed P2 settings:", settingsP2);
          console.log("Parsed Xtra settings:", settingsXtra);
          
          // Apply P1 settings
          document.getElementById('modeSelect').value = settingsP1.modeP1 || 'PLS';
          document.getElementById('pauseTime').value = secondsToHMS(settingsP1.pauseTimeP1 || 0);
          document.getElementById('timeCyclesSelect').value = settingsP1.runModeP1 || 'TIME';
          
          // Apply time/cycles value based on mode
          if (settingsP1.runModeP1 === 'TIME') {
            document.getElementById('timeCyclesValue').value = secondsToMS(settingsP1.timeCyclesP1 || 0);
          } else {
            document.getElementById('timeCyclesValue').value = settingsP1.timeCyclesP1 || 0;
          }
          
          // Apply proxy settings
          document.getElementById('proxy1').checked = settingsP1.proxy1P1 === "YES";
          document.getElementById('proxy2').checked = settingsP1.proxy2P1 === "YES";
          
          if (settingsP1.dwellTimeP1Px1) {
            document.getElementById('dwellTime1').value = secondsToHMS(settingsP1.dwellTimeP1Px1);
          }
          if (settingsP1.dwellTimeP1Px2) {
            document.getElementById('dwellTime2').value = secondsToHMS(settingsP1.dwellTimeP1Px2);
          }
          
          // Apply level sense settings
          document.getElementById('levelSense').checked = settingsP1.levelP1 === "YES";
          if (settingsP1.levelTypeP1) {
            document.getElementById('levelSenseOptions').value = settingsP1.levelTypeP1;
          }
          if (settingsP1.levelNoncP1) {
            document.getElementById('levelNonc').value = settingsP1.levelNoncP1;
          }
          
          // Apply P2 settings
          document.getElementById('pump2').checked = settingsP2.pump2InUse === "YES";
          if (settingsP2.pump2InUse === "YES") {
            document.getElementById('pump2Mode').value = settingsP2.modeP2 || 'PLS';
            document.getElementById('pump2PauseTime').value = secondsToHMS(settingsP2.pauseTimeP2 || 0);
            document.getElementById('pump2TimeCyclesSelect').value = settingsP2.runModeP2 || 'TIME';
            
            if (settingsP2.runModeP2 === 'TIME') {
              document.getElementById('pump2TimeCyclesValue').value = secondsToMS(settingsP2.timeCyclesP2 || 0);
            } else {
              document.getElementById('pump2TimeCyclesValue').value = settingsP2.timeCyclesP2 || 0;
            }
            
            document.getElementById('pump2Proxy1').checked = settingsP2.proxy1P2 === "YES";
            document.getElementById('pump2Proxy2').checked = settingsP2.proxy2P2 === "YES";
            
            if (settingsP2.dwellTimeP2Px1) {
              document.getElementById('pump2DwellTime1').value = secondsToHMS(settingsP2.dwellTimeP2Px1);
            }
            if (settingsP2.dwellTimeP2Px2) {
              document.getElementById('pump2DwellTime2').value = secondsToHMS(settingsP2.dwellTimeP2Px2);
            }
            
            document.getElementById('pump2LevelSense').checked = settingsP2.levelP2 === "YES";
            if (settingsP2.levelTypeP2) {
              document.getElementById('pump2LevelSenseOptions').value = settingsP2.levelTypeP2;
            }
            if (settingsP2.levelNoncP2) {
              document.getElementById('pump2LevelNonc').value = settingsP2.levelNoncP2;
            }
          }
          
          // Apply extra settings
          document.getElementById('extLamp').checked = settingsXtra.extLampInUse === "YES";
          if (settingsXtra.extLampType) {
            document.getElementById('extLampOptions').value = settingsXtra.extLampType;
          }
          
          // Apply blockage current values
          if (settingsXtra.blockCurrentP1) {
            document.getElementById('blockageCurrentValue').value = settingsXtra.blockCurrentP1;
          }
          if (settingsXtra.blockCurrentP2) {
            document.getElementById('pump2BlockageCurrentValue').value = settingsXtra.blockCurrentP2;
          }
          
          // Apply visibility after a brief delay to ensure DOM is updated
          setTimeout(() => {
            applyVisibilityOnlyForLoadedSettings();
            
            // Update labels for Time/Cycles
            updateTimeCyclesLabel();
            if (settingsP2.runModeP2) {
              updatePump2TimeCyclesLabel();
            }
            
            // Handle both Settings and Live tabs
            if (window.isLoadingForLive) {
              window.isLoadingForLive = false;
              initializeLiveMode();
              showStatus("Live mode ready", false);
              console.log("Live mode initialized with loaded settings");
            } else {
              showStatus("Settings loaded from device.");
              console.log("Settings loading complete");
            }
            
            // Re-enable auto-logic
            window.isLoadingSettings = false;
          }, 300);
          
        } catch (e) {
          window.isLoadingSettings = false;
          window.isLoadingForLive = false;
          showStatus("Failed to parse settings from device.", true);
          console.error("applySettingsFromPayload error:", e);
        }
      }

      // Add missing updateHallEffectIndicator function:
      function updateHallEffectIndicator(indicator, payload, checkHallEffect, pumpNumber) {
        if (!indicator) return;
        
        // Get the level type for the appropriate pump
        let levelType = '';
        if (pumpNumber === 1) {
          levelType = document.getElementById('levelSenseOptions') ? document.getElementById('levelSenseOptions').value : '';
        } else if (pumpNumber === 2) {
          levelType = document.getElementById('pump2LevelSenseOptions') ? document.getElementById('pump2LevelSenseOptions').value : '';
        }

        // Apply Hall Effect logic when level type is HEF
        if (levelType === 'HEF') {
          // This is a Hall Effect sensor - expect percentage values
          indicator.classList.add('hall-effect');
          
          // Remove all level classes first
          indicator.classList.remove('lamp-off', 'lamp-on', 'level-low', 'level-medium', 'level-high');
          
          // Parse percentage from payload
          const percentage = parseFloat(payload);
          
          if (!isNaN(percentage)) {
            indicator.textContent = Math.round(percentage) + '%';
            
            // Apply color coding based on percentage
            if (percentage < 10) {
              indicator.classList.add('level-low');
            } else if (percentage >= 10 && percentage <= 50) {
              indicator.classList.add('level-medium');
            } else {
              indicator.classList.add('level-high');
            }
          } else {
            // Invalid percentage, show as low level
            indicator.textContent = '0%';
            indicator.classList.add('level-low');
          }
        } else {
          // Regular on/off indicator (non-HEF level types)
          indicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high');
          indicator.textContent = ''; // No text for regular indicators
          
          if (payload === "on") {
            indicator.classList.remove('lamp-off');
            indicator.classList.add('lamp-on');
          } else if (payload === "off") {
            indicator.classList.remove('lamp-on');
            indicator.classList.add('lamp-off');
          }
        }
      }

      // Add missing updateLiveDisplay function:
      function updateLiveDisplay() {
        console.log("Updating Live Mode display based on settings");
        
        const pump2Enabled = document.getElementById('pump2') && document.getElementById('pump2').checked;
        const livePump2Section = document.getElementById('livePump2Section');
        if (livePump2Section) {
          livePump2Section.style.display = pump2Enabled ? '' : 'none';
        }
        
        // Show/hide pump1 rows based on settings
        const proxy1Enabled = document.getElementById('proxy1') && document.getElementById('proxy1').checked;
        const proxy2Enabled = document.getElementById('proxy2') && document.getElementById('proxy2').checked;
        const levelEnabled = document.getElementById('levelSense') && document.getElementById('levelSense').checked;
        const extLampEnabled = document.getElementById('extLamp') && document.getElementById('extLamp').checked;
        
        document.getElementById('livePump1Proxy1Row').style.display = proxy1Enabled ? '' : 'none';
        document.getElementById('livePump1Proxy2Row').style.display = proxy2Enabled ? '' : 'none';
        document.getElementById('livePump1LevelRow').style.display = levelEnabled ? '' : 'none';
        document.getElementById('livePump1ExtLampRow').style.display = extLampEnabled ? '' : 'none';

        // Update pump2 if enabled
        if (pump2Enabled) {
          const pump2Proxy1Enabled = document.getElementById('pump2Proxy1') && document.getElementById('pump2Proxy1').checked;
          const pump2Proxy2Enabled = document.getElementById('pump2Proxy2') && document.getElementById('pump2Proxy2').checked;
          const pump2LevelEnabled = document.getElementById('pump2LevelSense') && document.getElementById('pump2LevelSense').checked;
          
          document.getElementById('livePump2Proxy1Row').style.display = pump2Proxy1Enabled ? '' : 'none';
          document.getElementById('livePump2Proxy2Row').style.display = pump2Proxy2Enabled ? '' : 'none';
          document.getElementById('livePump2LevelRow').style.display = pump2LevelEnabled ? '' : 'none';
        }
        
        // Load values from settings into display fields
        const pauseTime = document.getElementById('pauseTime');
        if (pauseTime && pauseTime.value) {
          document.getElementById('livePump1PauseValue').textContent = pauseTime.value;
        }
        
        const timeCyclesValue = document.getElementById('timeCyclesValue');
        if (timeCyclesValue && timeCyclesValue.value) {
          document.getElementById('livePump1CyclesValue').textContent = timeCyclesValue.value;
        }
        
        if (pump2Enabled) {
          const pump2PauseTime = document.getElementById('pump2PauseTime');
          if (pump2PauseTime && pump2PauseTime.value) {
            document.getElementById('livePump2PauseValue').textContent = pump2PauseTime.value;
          }
          
          const pump2TimeCyclesValue = document.getElementById('pump2TimeCyclesValue');
          if (pump2TimeCyclesValue && pump2TimeCyclesValue.value) {
            document.getElementById('livePump2CyclesValue').textContent = pump2TimeCyclesValue.value;
          }
        }
      }
    </script>
  </body>
</html>