<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A3 Setup</title>
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/style.css?v=' + new Date().getTime();
      document.head.appendChild(link);
    </script>
    <style>
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
    </style>
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
  </head>
  <body>
    <div class="header-box">
      <h1>A3 Setup</h1>
    </div>
    <div class="content main-content">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" id="tabMainBtn" type="button">Main</button>
        <button class="tab-btn" id="tabLiveBtn" type="button">Live</button>
        <button class="tab-btn" id="tabSettingsBtn" type="button">Settings</button>
        <button class="tab-btn" id="tabWiFiBtn" type="button">WiFi</button>
      </div>
      <!-- Tab Contents -->
      <div class="tab-content active" id="tabMain">
        <div class="info-row">
          <div>
            Serial: <span id="serial-number" class="info-value">...</span>
          </div>
          <div>
            Version: <span id="ver-string" class="info-value">...</span>
          </div>
        </div>
        <div id="status-message" class="status-message"></div>
        <div class="btn-row">
          <button class="btn" id="backBtn">CHANGE</button>
        </div>
      </div>
      <div class="tab-content" id="tabLive">
        <div style="margin: 40px 0 20px 0; text-align: center;">
          <strong>Live tab content goes here.</strong>
        </div>
      </div>
      <div class="tab-content" id="tabSettings">
        <form id="settingsForm" autocomplete="off">
          <div class="settings-group" id="settingsFields">
            <!-- Mode -->
            <div class="settings-row">
              <label for="modeSelect"><strong>Mode</strong></label>
              <select id="modeSelect" name="mode">
                <option value="PLS">PLS</option>
                <option value="SLS">SLS</option>
              </select>
            </div>
            <!-- Pause Time -->
            <div class="settings-row">
              <label for="pauseTime"><strong>Pause Time</strong></label>
              <input type="text" id="pauseTime" name="pauseTime" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
            </div>
            <!-- Time/Cycles -->
            <div class="settings-row">
              <label for="timeCyclesSelect"><strong>Time/Cycles</strong></label>
              <select id="timeCyclesSelect" name="timeCycles">
                <option value="TIME">Time</option>
                <option value="CYCLE">Cycles</option>
              </select>
            </div>
            <!-- Time/Cycles Value -->
            <div class="settings-row" id="timeCyclesValueRow">
              <label for="timeCyclesValue" id="timeCyclesValueLabel"><strong>Pump ON Time</strong></label>
              <input type="text" id="timeCyclesValue" name="timeCyclesValue" placeholder="00:00">
            </div>
            <!-- Proxy1 -->
            <div class="settings-row">
              <label for="proxy1"><strong>Proxy1</strong></label>
              <input type="checkbox" id="proxy1" name="proxy1">
            </div>
            <!-- Dwell Time (Proxy1) -->
            <div class="settings-row" id="dwellTime1Row" style="display:none;">
              <label for="dwellTime1"><strong>Dwell Time</strong></label>
              <input type="number" id="dwellTime1" name="dwellTime1" placeholder="Enter dwell time">
            </div>
            <!-- Proxy2 -->
            <div class="settings-row">
              <label for="proxy2"><strong>Proxy2</strong></label>
              <input type="checkbox" id="proxy2" name="proxy2">
            </div>
            <div class="settings-row" id="dwellTime2Row" style="display:none;">
              <label for="dwellTime2"><strong>Dwell Time Proxy2</strong></label>
              <input type="number" id="dwellTime2" name="dwellTime2" placeholder="Enter dwell time for Proxy2">
            </div>
            <!-- Level Sense -->
            <div class="settings-row">
              <label for="levelSense"><strong>Level Sense</strong></label>
              <input type="checkbox" id="levelSense" name="levelSense">
            </div>
            <div class="settings-row" id="levelSenseOptionsRow" style="display:none;">
              <label for="levelSenseOptions"><strong>Level Sense Mode</strong></label>
              <select id="levelSenseOptions" name="levelSenseOptions">
                <option value="HEF">Hall Sense</option>
                <option value="PULE">Pulse Empty</option>
                <option value="PULF">Pulse Full</option>
                <option value="LLO">Steady</option>
              </select>
            </div>
            <div class="settings-row" id="levelNoncRow" style="display:none;">
              <label for="levelNonc"><strong>Type</strong></label>
              <select id="levelNonc" name="levelNonc">
                <option value="NO">NO</option>
                <option value="NC">NC</option>
              </select>
            </div>
            <!-- Ext Lamp -->
            <div class="settings-row">
              <label for="extLamp"><strong>Ext Lamp</strong></label>
              <input type="checkbox" id="extLamp" name="extLamp">
            </div>
            <div class="settings-row" id="extLampOptionsRow" style="display:none;">
              <label for="extLampOptions"><strong>Lamp Mode</strong></label>
              <select id="extLampOptions" name="extLampOptions">
                <option value="RGB">RGB</option>
                <option value="STE">Steady</option>
                <option value="FLA">Flash</option>
              </select>
            </div>
            <!-- Blockage Current -->
            <div class="settings-row">
              <label><strong>Blockage Current</strong></label>
              <input type="checkbox" id="blockageManual" name="blockageManual">
              <span style="margin-right:8px;">Manual</span>
              <input type="checkbox" id="blockageAuto" name="blockageAuto">
              <span>Auto</span>
            </div>
            <div class="settings-row" id="blockageManualRow" style="display:none;">
              <label for="blockageManualValue"><strong>Manual Current</strong></label>
              <input type="number" id="blockageManualValue" name="blockageManualValue" placeholder="Enter motor current">
            </div>
            <div class="settings-row" id="blockageAutoRow" style="display:none;">
              <label for="blockageAutoValue"><strong>Auto Test</strong></label>
              <input type="text" id="blockageAutoValue" name="blockageAutoValue" placeholder="Pump Starting" disabled>
            </div>
            <!-- Pump2 -->
            <div class="settings-row">
              <label for="pump2"><strong>Pump2</strong></label>
              <input type="checkbox" id="pump2" name="pump2">
            </div>
            <div id="pump2SettingsGroup" style="display:none;">
              <div class="settings-row">
                <label for="pump2Mode"><strong>Mode</strong></label>
                <select id="pump2Mode" name="pump2Mode">
                  <option value="PLS">PLS</option>
                  <option value="SLS">SLS</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2PauseTime"><strong>Pause Time</strong></label>
                <input type="text" id="pump2PauseTime" name="pump2PauseTime" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
              </div>
              <div class="settings-row">
                <label for="pump2TimeCyclesSelect"><strong>Time/Cycles</strong></label>
                <select id="pump2TimeCyclesSelect" name="pump2TimeCycles">
                  <option value="TIME">Time</option>
                  <option value="CYCLE">Cycles</option>
                </select>
              </div>
              <div class="settings-row" id="pump2TimeCyclesValueRow">
                <label for="pump2TimeCyclesValue" id="pump2TimeCyclesValueLabel"><strong>Pump ON Time</strong></label>
                <input type="text" id="pump2TimeCyclesValue" name="pump2TimeCyclesValue" placeholder="00:00">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy1"><strong>Proxy1</strong></label>
                <input type="checkbox" id="pump2Proxy1" name="pump2Proxy1">
              </div>
              <div class="settings-row" id="pump2DwellTime1Row" style="display:none;">
                <label for="pump2DwellTime1"><strong>Dwell Time</strong></label>
                <input type="number" id="pump2DwellTime1" name="pump2DwellTime1" placeholder="Enter dwell time">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy2"><strong>Proxy2</strong></label>
                <input type="checkbox" id="pump2Proxy2" name="pump2Proxy2">
              </div>
              <div class="settings-row" id="pump2DwellTime2Row" style="display:none;">
                <label for="pump2DwellTime2"><strong>Dwell Time Proxy2</strong></label>
                <input type="number" id="pump2DwellTime2" name="pump2DwellTime2" placeholder="Enter dwell time for Proxy2">
              </div>
              <div class="settings-row">
                <label for="pump2LevelSense"><strong>Level Sense</strong></label>
                <input type="checkbox" id="pump2LevelSense" name="pump2LevelSense">
              </div>
              <div class="settings-row" id="pump2LevelSenseOptionsRow" style="display:none;">
                <label for="pump2LevelSenseOptions"><strong>Level Sense Mode</strong></label>
                <select id="pump2LevelSenseOptions" name="pump2LevelSenseOptions">
                  <option value="HEF">Hall Sense</option>
                  <option value="PULE">Pulse Empty</option>
                  <option value="PULF">Pulse Full</option>
                  <option value="LLO">Steady</option>
                </select>
              </div>
              <div class="settings-row" id="pump2LevelNoncRow" style="display:none;">
                <label for="pump2LevelNonc"><strong>Type</strong></label>
                <select id="pump2LevelNonc" name="pump2LevelNonc">
                  <option value="NO">NO</option>
                  <option value="NC">NC</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2ExtLamp"><strong>Ext Lamp</strong></label>
                <input type="checkbox" id="pump2ExtLamp" name="pump2ExtLamp">
              </div>
              <div class="settings-row" id="pump2ExtLampOptionsRow" style="display:none;">
                <label for="pump2ExtLampOptions"><strong>Lamp Mode</strong></label>
                <select id="pump2ExtLampOptions" name="pump2ExtLampOptions">
                  <option value="RGB">RGB</option>
                  <option value="STE">Steady</option>
                  <option value="FLA">Flash</option>
                </select>
              </div>
              <div class="settings-row">
                <label><strong>Blockage Current</strong></label>
                <input type="checkbox" id="pump2BlockageManual" name="pump2BlockageManual">
                <span style="margin-right:8px;">Manual</span>
                <input type="checkbox" id="pump2BlockageAuto" name="pump2BlockageAuto">
                <span>Auto</span>
              </div>
              <div class="settings-row" id="pump2BlockageManualRow" style="display:none;">
                <label for="pump2BlockageManualValue"><strong>Manual Current</strong></label>
                <input type="number" id="pump2BlockageManualValue" name="pump2BlockageManualValue" placeholder="Enter motor current">
              </div>
              <div class="settings-row" id="pump2BlockageAutoRow" style="display:none;">
                <label for="pump2BlockageAutoValue"><strong>Auto Test</strong></label>
                <input type="text" id="pump2BlockageAutoValue" name="pump2BlockageAutoValue" placeholder="Pump Starting" disabled>
              </div>
            </div>
          </div>
          <div class="btn-row" id="testModeBtnRow" style="margin-bottom:10px;">
            <button type="button" class="btn" id="testModeBtn">Test</button>
            <button type="submit" class="btn" id="saveSettingsBtn">Save Settings</button>
          </div>
        </form>
        <!-- Test Mode UI (hidden by default) -->
        <div id="testModePanel" style="display:none;">
          <div class="testmode-panel-container">
            <div class="testmode-row">
              <span class="testmode-label">Pump1</span>
              <button type="button" class="btn testmode-pump-btn pump-off" id="pump1TestBtn">ON/OFF</button>
            </div>
            <div class="testmode-row" id="proxy1Row">
              <span class="testmode-label">Proxy1</span>
              <span class="testmode-indicator proxy-off" id="proxy1Indicator">OFF</span>
            </div>
            <div class="testmode-row" id="proxy2Row">
              <span class="testmode-label">Proxy2</span>
              <span class="testmode-indicator proxy-off" id="proxy2Indicator">OFF</span>
            </div>
          </div>
          <div class="btn-row" style="margin-top:24px;">
            <button type="button" class="btn" id="testModeBackBtn">Back</button>
            <button type="submit" class="btn" id="testModeSaveBtn">Save Settings</button>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tabWiFi">
        <form id="wifiFormMain" autocomplete="off">
          <div class="fields-flex">
            <div class="input-group">
              <label for="ssid-main">WiFi Name:</label>
              <input type="text" id="ssid-main" name="ssid" required>
            </div>
            <div class="input-group">
              <label for="password-main">WiFi Password:</label>
              <input type="password" id="password-main" name="password" required>
            </div>
          </div>
          <div class="btn-row">
            <button type="submit" class="btn">SAVE</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      let lastBlockCurrentP1Value = undefined;
      let userBlockCurrentP1Value = undefined;
      let latestSettingsPayload = { p1: null, p2: null, xtra: null };
      let p1AutoCalibrating = false;
      let p2AutoCalibrating = false;

      // Blockage Current logic for Pump1
      const blockageManual = document.getElementById('blockageManual');
      const blockageAuto = document.getElementById('blockageAuto');
      const blockageManualRow = document.getElementById('blockageManualRow');
      const blockageAutoRow = document.getElementById('blockageAutoRow');
      const blockageManualValue = document.getElementById('blockageManualValue');
      const blockageAutoValue = document.getElementById('blockageAutoValue');

      // Blockage Current logic for Pump2
      const pump2BlockageManual = document.getElementById('pump2BlockageManual');
      const pump2BlockageAuto = document.getElementById('pump2BlockageAuto');
      const pump2BlockageManualRow = document.getElementById('pump2BlockageManualRow');
      const pump2BlockageAutoRow = document.getElementById('pump2BlockageAutoRow');
      const pump2BlockageManualValue = document.getElementById('pump2BlockageManualValue');
      const pump2BlockageAutoValue = document.getElementById('pump2BlockageAutoValue');

      // Track user edits
      blockageManualValue.addEventListener('input', function() {
        userBlockCurrentP1Value = this.value;
      });

      // Auto calibration functions
      function startP1AutoCalibration() {
        if (client && client.connected && serial) {
          p1AutoCalibrating = true;
          client.publish(`a3/${serial}/test/pump1`, "currentAutoCalibrate");
          console.log("Started P1 auto calibration");
        }
      }

      function startP2AutoCalibration() {
        console.log("startP2AutoCalibration called");
        console.log("Client exists:", !!client);
        console.log("Client connected:", client && client.connected);
        console.log("Serial:", serial);
        
        if (client && client.connected && serial) {
          p2AutoCalibrating = true;
          const topic = `a3/${serial}/test/pump2`;
          const result = client.publish(topic, "currentAutoCalibrate");
          console.log("Published to topic:", topic);
          console.log("Publish result:", result);
          console.log("Started P2 auto calibration - p2AutoCalibrating set to:", p2AutoCalibrating);
        } else {
          console.log("Cannot start P2 auto calibration - requirements not met");
        }
      }

      // Time conversion functions
      function secondsToHMS(seconds) {
        const totalSeconds = parseInt(seconds);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const secs = totalSeconds % 60;
        
        return String(hours).padStart(2, '0') + ':' + 
               String(minutes).padStart(2, '0') + ':' + 
               String(secs).padStart(2, '0');
      }

      function secondsToMS(seconds) {
        const totalSeconds = parseInt(seconds);
        const minutes = Math.floor(totalSeconds / 60);
        const secs = totalSeconds % 60;
        
        return String(minutes).padStart(2, '0') + ':' + 
               String(secs).padStart(2, '0');
      }

      function msToSeconds(msString) {
        const parts = msString.split(':');
        if (parts.length !== 2) return 0;
        
        const minutes = parseInt(parts[0]) || 0;
        const seconds = parseInt(parts[1]) || 0;
        
        return (minutes * 60) + seconds;
      }

      function hmsToSeconds(hmsString) {
        const parts = hmsString.split(':');
        if (parts.length !== 3) return 0;
        
        const hours = parseInt(parts[0]) || 0;
        const minutes = parseInt(parts[1]) || 0;
        const seconds = parseInt(parts[2]) || 0;
        
        return (hours * 3600) + (minutes * 60) + seconds;
      }

      function validateHMSInput(input) {
        input.addEventListener('input', function() {
          let value = this.value.replace(/[^0-9:]/g, '');
          
          // Auto-format as user types
          if (value.length === 2 && !value.includes(':')) {
            value += ':';
          } else if (value.length === 5 && value.split(':').length === 2) {
            value += ':';
          }
          
          this.value = value;
        });

        input.addEventListener('blur', function() {
          let value = this.value;
          const parts = value.split(':');
          
          // Ensure we have 3 parts
          while (parts.length < 3) {
            parts.push('00');
          }
          
          // Validate and format each part
          const hours = Math.max(0, Math.min(99, parseInt(parts[0]) || 0));
          const minutes = Math.max(0, Math.min(59, parseInt(parts[1]) || 0));
          const seconds = Math.max(0, Math.min(59, parseInt(parts[2]) || 0));
          
          this.value = String(hours).padStart(2, '0') + ':' + 
                       String(minutes).padStart(2, '0') + ':' + 
                       String(seconds).padStart(2, '0');
        });
      }

      function validateMSInput(input) {
        input.addEventListener('input', function() {
          let value = this.value.replace(/[^0-9:]/g, '');
          
          // Auto-format as user types
          if (value.length === 2 && !value.includes(':')) {
            value += ':';
          }
          
          this.value = value;
        });

        input.addEventListener('blur', function() {
          let value = this.value;
          const parts = value.split(':');
          
          // Ensure we have 2 parts
          while (parts.length < 2) {
            parts.push('00');
          }
          
          // Validate and format each part
          const minutes = Math.max(0, Math.min(999, parseInt(parts[0]) || 0));
          const seconds = Math.max(0, Math.min(59, parseInt(parts[1]) || 0));
          
          this.value = String(minutes).padStart(2, '0') + ':' + 
                       String(seconds).padStart(2, '0');
        });
      }

      // Apply validation to inputs
      validateHMSInput(document.getElementById('pauseTime'));
      validateHMSInput(document.getElementById('pump2PauseTime'));
      validateMSInput(document.getElementById('timeCyclesValue'));
      validateMSInput(document.getElementById('pump2TimeCyclesValue'));

      function updateBlockageRows() {
        const autoLabel = document.querySelector('label[for="blockageAutoValue"]');
        
        if (blockageManual.checked) {
          blockageManualRow.style.display = '';
          blockageAutoRow.style.display = 'none';
          if (userBlockCurrentP1Value !== undefined && userBlockCurrentP1Value !== '') {
            blockageManualValue.value = userBlockCurrentP1Value;
          } else if (lastBlockCurrentP1Value !== undefined && lastBlockCurrentP1Value !== null && lastBlockCurrentP1Value !== '') {
            blockageManualValue.value = lastBlockCurrentP1Value;
          } else {
            blockageManualValue.value = '';
            blockageManualValue.placeholder = 'Enter motor current';
          }
        } else if (blockageAuto.checked) {
          blockageManualRow.style.display = 'none';
          blockageAutoRow.style.display = '';
          if (autoLabel) {
            autoLabel.innerHTML = '<strong>Auto Test</strong>';
          }
          if (!p1AutoCalibrating) {
            blockageAutoValue.value = 'Pump Starting';
            // Start auto calibration when auto is selected
            startP1AutoCalibration();
          }
        } else {
          blockageManualRow.style.display = 'none';
          blockageAutoRow.style.display = 'none';
          p1AutoCalibrating = false;
        }
      }

      function updatePump2BlockageRows() {
        console.log("updatePump2BlockageRows called");
        const pump2AutoLabel = document.querySelector('label[for="pump2BlockageAutoValue"]');
        
        if (pump2BlockageManual.checked) {
          console.log("Pump2 Manual checked");
          pump2BlockageManualRow.style.display = '';
          pump2BlockageAutoRow.style.display = 'none';
        } else if (pump2BlockageAuto.checked) {
          console.log("Pump2 Auto checked");
          pump2BlockageManualRow.style.display = 'none';
          pump2BlockageAutoRow.style.display = '';
          if (pump2AutoLabel) {
            pump2AutoLabel.innerHTML = '<strong>Auto Test</strong>';
          }
          if (!p2AutoCalibrating) {
            console.log("p2AutoCalibrating is false, starting calibration");
            pump2BlockageAutoValue.value = 'Pump Starting';
            startP2AutoCalibration();
          } else {
            console.log("p2AutoCalibrating is already true, skipping");
          }
        } else {
          console.log("Neither pump2 manual nor auto checked");
          pump2BlockageManualRow.style.display = 'none';
          pump2BlockageAutoRow.style.display = 'none';
          p2AutoCalibrating = false;
        }
      }

      blockageManual.addEventListener('change', updateBlockageRows);
      blockageAuto.addEventListener('change', updateBlockageRows);
      pump2BlockageManual.addEventListener('change', updatePump2BlockageRows);
      pump2BlockageAuto.addEventListener('change', updatePump2BlockageRows);

      // Dynamic label updates for Time/Cycles
      function updateTimeCyclesLabel() {
        const timeCyclesSelect = document.getElementById('timeCyclesSelect');
        const timeCyclesValueLabel = document.getElementById('timeCyclesValueLabel');
        const timeCyclesValue = document.getElementById('timeCyclesValue');
        
        if (timeCyclesSelect.value === 'TIME') {
          timeCyclesValueLabel.innerHTML = '<strong>Pump ON Time</strong>';
          timeCyclesValue.placeholder = '00:00';
        } else if (timeCyclesSelect.value === 'CYCLE') {
          timeCyclesValueLabel.innerHTML = '<strong>Pump ON Cycles</strong>';
          timeCyclesValue.placeholder = 'Enter cycles';
        }
      }

      function updatePump2TimeCyclesLabel() {
        const pump2TimeCyclesSelect = document.getElementById('pump2TimeCyclesSelect');
        const pump2TimeCyclesValueLabel = document.getElementById('pump2TimeCyclesValueLabel');
        const pump2TimeCyclesValue = document.getElementById('pump2TimeCyclesValue');
        
        if (pump2TimeCyclesSelect.value === 'TIME') {
          pump2TimeCyclesValueLabel.innerHTML = '<strong>Pump ON Time</strong>';
          pump2TimeCyclesValue.placeholder = '00:00';
        } else if (pump2TimeCyclesSelect.value === 'CYCLE') {
          pump2TimeCyclesValueLabel.innerHTML = '<strong>Pump ON Cycles</strong>';
          pump2TimeCyclesValue.placeholder = 'Enter cycles';
        }
      }

      document.getElementById('timeCyclesSelect').addEventListener('change', updateTimeCyclesLabel);
      document.getElementById('pump2TimeCyclesSelect').addEventListener('change', updatePump2TimeCyclesLabel);

      // Tab switching logic
      const tabMainBtn = document.getElementById('tabMainBtn');
      const tabLiveBtn = document.getElementById('tabLiveBtn');
      const tabSettingsBtn = document.getElementById('tabSettingsBtn');
      const tabWiFiBtn = document.getElementById('tabWiFiBtn');
      const tabMain = document.getElementById('tabMain');
      const tabLive = document.getElementById('tabLive');
      const tabSettings = document.getElementById('tabSettings');
      const tabWiFi = document.getElementById('tabWiFi');

      function switchAwayFromSettings() {
        // Send pump off messages when switching away from settings tab
        const testModePanel = document.getElementById('testModePanel');
        if (testModePanel && testModePanel.style.display !== 'none') {
          sendPumpOffMessages();
        }
      }

      tabMainBtn.onclick = function() {
        switchAwayFromSettings(); // ADD this line
        tabMainBtn.classList.add('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabMain.classList.add('active');
        tabLive.classList.remove('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
      };
      tabLiveBtn.onclick = function() {
        switchAwayFromSettings(); // ADD this line
        tabLiveBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabLive.classList.add('active');
        tabMain.classList.remove('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
      };
      tabSettingsBtn.onclick = function() {
        tabSettingsBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabLiveBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabSettings.classList.add('active');
        tabMain.classList.remove('active');
        tabLive.classList.remove('active');
        tabWiFi.classList.remove('active');
        // Always re-query all three settings when opening the tab
        if (client && client.connected && typeof client.publish === "function") {
          const serial = getSerialFromURL();
          if (serial) {
            client.publish(`a3/${serial}/queryP1Settings`, serial);
            client.publish(`a3/${serial}/queryP2Settings`, serial);
            client.publish(`a3/${serial}/queryXtraSettings`, serial);
            showStatus("Requesting settings from device...");
          }
        }
      };
      tabWiFiBtn.onclick = function() {
        switchAwayFromSettings(); // ADD this line
        tabWiFiBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFi.classList.add('active');
        tabMain.classList.remove('active');
        tabLive.classList.remove('active');
        tabSettings.classList.remove('active');
      };

      // Show/hide logic for dwell time and options fields
      function setupShowHideCheckbox(triggerId, targetRowId) {
        const trigger = document.getElementById(triggerId);
        const target = document.getElementById(targetRowId);
        if (trigger && target) {
          trigger.addEventListener('change', function() {
            target.style.display = this.checked ? '' : 'none';
          });
        }
      }
      setupShowHideCheckbox('proxy1', 'dwellTime1Row');
      setupShowHideCheckbox('proxy2', 'dwellTime2Row');
      setupShowHideCheckbox('levelSense', 'levelSenseOptionsRow');
      setupShowHideCheckbox('extLamp', 'extLampOptionsRow');
      setupShowHideCheckbox('pump2', 'pump2SettingsGroup');
      setupShowHideCheckbox('pump2Proxy1', 'pump2DwellTime1Row');
      setupShowHideCheckbox('pump2Proxy2', 'pump2DwellTime2Row');
      setupShowHideCheckbox('pump2LevelSense', 'pump2LevelSenseOptionsRow');
      setupShowHideCheckbox('pump2ExtLamp', 'pump2ExtLampOptionsRow');

      document.getElementById('levelSenseOptions').addEventListener('change', function() {
        const noncRow = document.getElementById('levelNoncRow');
        if (this.value === 'LLO') {
          noncRow.style.display = '';
        } else {
          noncRow.style.display = 'none';
        }
      });

      document.getElementById('pump2LevelSenseOptions').addEventListener('change', function() {
        const noncRow = document.getElementById('pump2LevelNoncRow');
        if (this.value === 'LLO') {
          noncRow.style.display = '';
        } else {
          noncRow.style.display = 'none';
        }
      });

      // Test Mode logic
      const testModeBtn = document.getElementById('testModeBtn');
      const testModePanel = document.getElementById('testModePanel');
      const settingsForm = document.getElementById('settingsForm');
      const testModeBackBtn = document.getElementById('testModeBackBtn');
      const proxy1Row = document.getElementById('proxy1Row');
      const proxy2Row = document.getElementById('proxy2Row');

      function updateProxyRowsVisibility() {
        proxy1Row.style.display = document.getElementById('proxy1').checked ? '' : 'none';
        proxy2Row.style.display = document.getElementById('proxy2').checked ? '' : 'none';
      }

      testModeBtn.onclick = function() {
        settingsForm.style.display = 'none';
        testModePanel.style.display = '';
        updateProxyRowsVisibility();
        initializeTestModeButtons(); // ADD this line
      };
      testModeBackBtn.onclick = function() {
        sendPumpOffMessages(); // ADD this line
        testModePanel.style.display = 'none';
        settingsForm.style.display = '';
      };

      // ADD this new function
      function initializeTestModeButtons() {
        // Initialize pump1 button - red background, ON label
        const pump1TestBtn = document.getElementById('pump1TestBtn');
        if (pump1TestBtn) {
          pump1TestBtn.classList.add('pump-on');
          pump1TestBtn.classList.remove('pump-off');
          pump1TestBtn.textContent = "ON";
          pump1IsOn = false; // Pump is actually off when button shows ON
        }
        
        // Initialize proxy indicators - gray background, OFF label
        const proxy1Indicator = document.getElementById('proxy1Indicator');
        const proxy2Indicator = document.getElementById('proxy2Indicator');
        if (proxy1Indicator) {
          proxy1Indicator.classList.add('proxy-off');
          proxy1Indicator.classList.remove('proxy-on');
          proxy1Indicator.textContent = "OFF";
        }
        if (proxy2Indicator) {
          proxy2Indicator.classList.add('proxy-off');
          proxy2Indicator.classList.remove('proxy-on');
          proxy2Indicator.textContent = "OFF";
        }
      }

      // ADD this new function
      function sendPumpOffMessages() {
        if (client && client.connected && serial) {
          // Send OFF messages to both pumps
          client.publish(`a3/${serial}/test/pump1`, "off");
          client.publish(`a3/${serial}/test/pump2`, "off");
          console.log("Sent OFF messages to both pumps");
        }
      }

      // ADD handler for testModeSaveBtn if it exists
      const testModeSaveBtn = document.getElementById('testModeSaveBtn');
      if (testModeSaveBtn) {
        testModeSaveBtn.onclick = function() {
          sendPumpOffMessages();
          // Add your save settings logic here
          console.log("Save settings from test mode");
        };
      }

      // MQTT config
      const hivemqBrokerUrl = 'wss://bd58f8878eef4f5eb73ac65312b10130.s1.eu.hivemq.cloud:8884/mqtt';
      const hivemqUsername = 'a3Admin';
      const hivemqPassword = 'DontLetMeIn247';

      let client = null;
      let serial = null;
      let queryTimeout = null;

      function getSerialFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("serial");
      }

      function showStatus(msg, isError = false) {
        const status = document.getElementById("status-message");
        status.textContent = msg;
        status.className = "status-message" + (isError ? " error" : "");
      }

      function isChecked(val) {
        if (typeof val === "boolean") return val;
        if (typeof val === "string") return val.toUpperCase() === "YES" || val.toLowerCase() === "true";
        if (typeof val === "number") return val === 1;
        return false;
      }

      function applySettingsFromPayload(payloads) {
        console.log("applySettingsFromPayload called with:", payloads);
        try {
          const settingsP1 = payloads.p1 ? JSON.parse(payloads.p1) : {};
          const settingsP2 = payloads.p2 ? JSON.parse(payloads.p2) : {};
          const settingsXtra = payloads.xtra ? JSON.parse(payloads.xtra) : {};

          console.log("Parsed P1 settings:", settingsP1);
          console.log("Parsed P2 settings:", settingsP2);
          console.log("Parsed Xtra settings:", settingsXtra);

          // --- PUMP 1 SETTINGS ---
          if (settingsP1.modeP1) {
            const modeSelectP1 = document.getElementById('modeSelect');
            if (settingsP1.modeP1 === "PLS" || settingsP1.modeP1 === "SLS") {
              modeSelectP1.value = settingsP1.modeP1;
            }
          }

          if (settingsP1.pauseTimeP1 !== undefined) {
            const pauseTimeInput = document.getElementById('pauseTime');
            if (settingsP1.pauseTimeP1 !== null && settingsP1.pauseTimeP1 !== "") {
              pauseTimeInput.value = secondsToHMS(settingsP1.pauseTimeP1);
              pauseTimeInput.placeholder = "";
            } else {
              pauseTimeInput.value = "";
              pauseTimeInput.placeholder = "00:00:00";
            }
          }

          if (settingsP1.runModeP1 && (settingsP1.runModeP1 === "TIME" || settingsP1.runModeP1 === "CYCLES")) {
            document.getElementById('timeCyclesSelect').value = settingsP1.runModeP1;
            updateTimeCyclesLabel(); // Update label after setting the value
          }

          if (settingsP1.timeCyclesP1 !== undefined) {
            const timeCyclesValueInput = document.getElementById('timeCyclesValue');
            const timeCyclesSelect = document.getElementById('timeCyclesSelect');
            
            if (timeCyclesSelect.value === 'TIME') {
              // Display as MM:SS for time mode
              timeCyclesValueInput.value = secondsToMS(settingsP1.timeCyclesP1);
            } else {
              // Display as number for cycle mode
              timeCyclesValueInput.value = settingsP1.timeCyclesP1;
            }
          }

          if (settingsP1.proxy1P1 !== undefined) {
            document.getElementById('proxy1').checked = isChecked(settingsP1.proxy1P1);
            document.getElementById('dwellTime1Row').style.display = isChecked(settingsP1.proxy1P1) ? '' : 'none';
          }
          if (settingsP1.dwellTimeP1Px1 !== undefined)
            document.getElementById('dwellTime1').value = settingsP1.dwellTimeP1Px1;

          if (settingsP1.proxy2P1 !== undefined) {
            document.getElementById('proxy2').checked = isChecked(settingsP1.proxy2P1);
            document.getElementById('dwellTime2Row').style.display = isChecked(settingsP1.proxy2P1) ? '' : 'none';
          }
          if (settingsP1.dwellTimeP1Px2 !== undefined)
            document.getElementById('dwellTime2').value = settingsP1.dwellTimeP1Px2;

          if (settingsP1.levelP1 !== undefined) {
            document.getElementById('levelSense').checked = isChecked(settingsP1.levelP1);
            document.getElementById('levelSenseOptionsRow').style.display = isChecked(settingsP1.levelP1) ? '' : 'none';
          }
          if (settingsP1.levelTypeP1 !== undefined) {
            document.getElementById('levelSenseOptions').value = settingsP1.levelTypeP1;
            document.getElementById('levelNoncRow').style.display = (settingsP1.levelTypeP1 === "LLO") ? '' : 'none';
          }
          if (settingsP1.levelNoncP1 !== undefined)
            document.getElementById('levelNonc').value = settingsP1.levelNoncP1;

          // --- PUMP 2 SETTINGS ---
          if (settingsP2.pump2InUse !== undefined) {
            document.getElementById('pump2').checked = isChecked(settingsP2.pump2InUse);
            document.getElementById('pump2SettingsGroup').style.display = isChecked(settingsP2.pump2InUse) ? '' : 'none';
          }

          if (settingsP2.modeP2 !== undefined)
            document.getElementById('pump2Mode').value = settingsP2.modeP2;

          if (settingsP2.pauseTimeP2 !== undefined) {
            const pump2PauseTimeInput = document.getElementById('pump2PauseTime');
            if (settingsP2.pauseTimeP2 !== null && settingsP2.pauseTimeP2 !== "") {
              pump2PauseTimeInput.value = secondsToHMS(settingsP2.pauseTimeP2);
              pump2PauseTimeInput.placeholder = "";
            } else {
              pump2PauseTimeInput.value = "";
              pump2PauseTimeInput.placeholder = "00:00:00";
            }
          }

          if (settingsP2.runModeP2 && (settingsP2.runModeP2 === "TIME" || settingsP2.runModeP2 === "CYCLES")) {
            document.getElementById('pump2TimeCyclesSelect').value = settingsP2.runModeP2;
            updatePump2TimeCyclesLabel(); // Update label after setting the value
          }
          
          if (settingsP2.timeCyclesP2 !== undefined) {
            const pump2TimeCyclesValueInput = document.getElementById('pump2TimeCyclesValue');
            const pump2TimeCyclesSelect = document.getElementById('pump2TimeCyclesSelect');
            
            if (pump2TimeCyclesSelect.value === 'TIME') {
              // Display as MM:SS for time mode
              pump2TimeCyclesValueInput.value = secondsToMS(settingsP2.timeCyclesP2);
            } else {
              // Display as number for cycle mode
              pump2TimeCyclesValueInput.value = settingsP2.timeCyclesP2;
            }
          }

          if (settingsP2.proxy1P2 !== undefined) {
            document.getElementById('pump2Proxy1').checked = isChecked(settingsP2.proxy1P2);
            document.getElementById('pump2DwellTime1Row').style.display = isChecked(settingsP2.proxy1P2) ? '' : 'none';
          }
          if (settingsP2.dwellTimeP2Px1 !== undefined)
            document.getElementById('pump2DwellTime1').value = settingsP2.dwellTimeP2Px1;

          if (settingsP2.proxy2P2 !== undefined) {
            document.getElementById('pump2Proxy2').checked = isChecked(settingsP2.proxy2P2);
            document.getElementById('pump2DwellTime2Row').style.display = isChecked(settingsP2.proxy2P2) ? '' : 'none';
          }
          if (settingsP2.dwellTimeP2Px2 !== undefined)
            document.getElementById('pump2DwellTime2').value = settingsP2.dwellTimeP2Px2;

          if (settingsP2.levelP2 !== undefined) {
            document.getElementById('pump2LevelSense').checked = isChecked(settingsP2.levelP2);
            document.getElementById('pump2LevelSenseOptionsRow').style.display = isChecked(settingsP2.levelP2) ? '' : 'none';
          }
          if (settingsP2.levelTypeP2 !== undefined) {
            document.getElementById('pump2LevelSenseOptions').value = settingsP2.levelTypeP2;
            document.getElementById('pump2LevelNoncRow').style.display = (settingsP2.levelTypeP2 === "LLO") ? '' : 'none';
          }
          if (settingsP2.levelNoncP2 !== undefined)
            document.getElementById('pump2LevelNonc').value = settingsP2.levelNoncP2;

          // --- EXTRA SETTINGS ---
          if (settingsXtra.extLampInUse !== undefined) {
            document.getElementById('extLamp').checked = isChecked(settingsXtra.extLampInUse);
            document.getElementById('extLampOptionsRow').style.display = isChecked(settingsXtra.extLampInUse) ? '' : 'none';
          }
          if (settingsXtra.extLampType !== undefined)
            document.getElementById('extLampOptions').value = settingsXtra.extLampType;

          // --- BLOCKAGE CURRENT ---
          if (settingsXtra.blockCurrentP1 !== undefined && settingsXtra.blockCurrentP1 !== null && settingsXtra.blockCurrentP1 !== '') {
            lastBlockCurrentP1Value = settingsXtra.blockCurrentP1;
            userBlockCurrentP1Value = undefined; // Reset user value on new payload
          } else {
            lastBlockCurrentP1Value = undefined;
            userBlockCurrentP1Value = undefined;
          }
          updateBlockageRows();

          if (settingsXtra.blockCurrentP2 !== undefined && settingsXtra.blockCurrentP2 !== null) {
            pump2BlockageManualValue.value = settingsXtra.blockCurrentP2;
          } else {
            pump2BlockageManualValue.value = '';
          }
          updatePump2BlockageRows();

        } catch (e) {
          showStatus("Failed to parse settings from device.", true);
          console.error("applySettingsFromPayload error:", e);
        }
      }

      function connectMQTTAndQuery() {
        serial = getSerialFromURL();
        if (!serial) {
          showStatus("No serial number provided in URL.", true);
          return;
        }
        document.getElementById("serial-number").textContent = serial;
        showStatus("Connecting to device...", false);

        client = mqtt.connect(hivemqBrokerUrl, {
          clientId: 'webClient-' + Math.random().toString(16).substr(2, 8),
          username: hivemqUsername,
          password: hivemqPassword,
          clean: true,
          connectTimeout: 4000,
          reconnectPeriod: 2000,
        });

        client.on('connect', function() {
          showStatus("Connected. Querying device...");
          const responseTopic = `a3/${serial}/serialResponse`;
          const P1testResponseTopic = `a3/${serial}/test/pump1`;
          const P2testResponseTopic = `a3/${serial}/test/pump2`;
          const P1prox1TestTopic = `a3/${serial}/test/proxy1`;
          const P1prox2TestTopic = `a3/${serial}/test/proxy2`;
          const P1settingsReplyTopic = `a3/${serial}/P1settingsReply`;
          const P2settingsReplyTopic = `a3/${serial}/P2settingsReply`;
          const xtraSettingsReplyTopic = `a3/${serial}/xtraSettingsReply`;

          // Subscribe to all topics first
          client.subscribe(responseTopic);
          client.subscribe(P1testResponseTopic);
          client.subscribe(P2testResponseTopic);
          client.subscribe(P1prox1TestTopic);
          client.subscribe(P1prox2TestTopic);
          client.subscribe(P1settingsReplyTopic);
          client.subscribe(P2settingsReplyTopic);
          client.subscribe(xtraSettingsReplyTopic);

          // Query serial first
          client.publish(`a3/${serial}/querySerial`, "mainQuery");

          queryTimeout = setTimeout(() => {
            showStatus("No response from device. Please check connection and try again.", true);
          }, 10000);
        });

        client.on('message', function(topic, message) {
          console.log("MQTT message received:", topic, message.toString());
          
          // ...existing handlers for serialResponse, P1settingsReply, etc...

          if (topic === `a3/${serial}/test/pump1`) {
            const btn = document.getElementById('pump1TestBtn');
            const payload = message.toString();
            
            // Handle pump test button states - FIXED LOGIC
            if (btn) {
              if (payload === "running") {
                btn.classList.remove('pump-on');
                btn.classList.add('pump-off');
                btn.textContent = "OFF";
                pump1IsOn = true;
              } else if (payload === "stopped") {
                btn.classList.add('pump-on');
                btn.classList.remove('pump-off');
                btn.textContent = "ON";
                pump1IsOn = false;
              }
            }
            
            // Handle auto calibration responses
            if (p1AutoCalibrating) {
              if (payload === "startingTest") {
                blockageAutoValue.value = 'Pump running';
                console.log("P1 auto calibration: pump running");
              } else if (!isNaN(parseFloat(payload))) {
                // Received a numeric value - this is the calibrated current
                blockageAutoValue.value = payload;
                p1AutoCalibrating = false;
                console.log("P1 auto calibration complete: " + payload);
              }
            }
          }

          if (topic === `a3/${serial}/test/pump2`) {
            const payload = message.toString();
            console.log("Received pump2 test message:", payload);
            console.log("p2AutoCalibrating state:", p2AutoCalibrating);
            
            // Handle auto calibration responses for pump2
            if (p2AutoCalibrating) {
              console.log("Processing pump2 auto calibration message:", payload);
              if (payload === "startingTest") {
                pump2BlockageAutoValue.value = 'Pump running';
                console.log("P2 auto calibration: pump running");
              } else if (!isNaN(parseFloat(payload))) {
                // Received a numeric value - this is the calibrated current
                pump2BlockageAutoValue.value = payload;
                p2AutoCalibrating = false;
                console.log("P2 auto calibration complete: " + payload);
              }
            } else {
              console.log("Received pump2 message but not in auto calibration mode");
            }
          }

          // ADD THESE NEW PROXY HANDLERS
          if (topic === `a3/${serial}/test/proxy1`) {
            const ind = document.getElementById('proxy1Indicator');
            if (!ind) return;
            const payload = message.toString();
            console.log("Received proxy1 message:", payload);
            if (payload === "on") {
              ind.classList.remove('proxy-off');
              ind.classList.add('proxy-on');
              ind.textContent = "ON";
            } else if (payload === "off") {
              ind.classList.remove('proxy-on');
              ind.classList.add('proxy-off');
              ind.textContent = "OFF";
            }
          }

          if (topic === `a3/${serial}/test/proxy2`) {
            const ind = document.getElementById('proxy2Indicator');
            if (!ind) return;
            const payload = message.toString();
            console.log("Received proxy2 message:", payload);
            if (payload === "on") {
              ind.classList.remove('proxy-off');
              ind.classList.add('proxy-on');
              ind.textContent = "ON";
            } else if (payload === "off") {
              ind.classList.remove('proxy-on');
              ind.classList.add('proxy-off');
              ind.textContent = "OFF";
            }
          }
        });

        client.on('error', function() {
          showStatus("MQTT connection error.", true);
        });
      }

      document.getElementById("backBtn").onclick = function() {
        window.location.href = "index.html";
      };
      connectMQTTAndQuery();
    </script>
  </body>
</html>