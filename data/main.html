<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>A3 Setup</title>
  <script>
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = '/style.css?v=' + new Date().getTime();
    document.head.appendChild(link);
  </script>
  <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
</head>
<body>
  <div class="header-box">
    <h1>A3 Setup</h1>
    <div class="status-container">
      <div id="status-message" class="status-message"></div>
    </div>
  </div>

  <div class="tabs">
    <button id="tab-main" class="tab-button active">Main</button>
    <button id="tab-live" class="tab-button">Live</button>
    <button id="tab-settings" class="tab-button">Settings</button>
    <button id="tab-wifi" class="tab-button">WiFi</button>
  </div>

  <div class="content main-content">
    <!-- Main Tab Content -->
    <div id="main-tab" class="tab-content active">
      <div class="info-section">
        <h2>Device Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <label>Serial Number:</label>
            <span id="serial-number">Loading...</span>
          </div>
          <div class="info-item">
            <label>Version:</label>
            <span id="ver-string">Loading...</span>
          </div>
        </div>
      </div>

      <div class="control-section">
        <h2>Pump Control</h2>
        <div class="button-grid">
          <button id="pump1TestBtn" class="pump-btn pump-off">Pump 1: OFF</button>
          <button id="pump2TestBtn" class="pump-btn pump-off">Pump 2: OFF</button>
        </div>
      </div>

      <div class="sensor-section">
        <h2>Sensor Status</h2>
        <div class="sensor-grid">
          <div class="sensor-item">
            <label>Proxy 1:</label>
            <span id="proxy1Indicator" class="proxy-indicator proxy-off">OFF</span>
          </div>
          <div class="sensor-item">
            <label>Proxy 2:</label>
            <span id="proxy2Indicator" class="proxy-indicator proxy-off">OFF</span>
          </div>
          <div class="sensor-item">
            <label>Pump2 Proxy 1:</label>
            <span id="pump2Proxy1Indicator" class="proxy-indicator proxy-off">OFF</span>
          </div>
          <div class="sensor-item">
            <label>Pump2 Proxy 2:</label>
            <span id="pump2Proxy2Indicator" class="proxy-indicator proxy-off">OFF</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Live Tab Content -->
    <div id="live-tab" class="tab-content">
      <div class="live-section">
        <h2>Live Data</h2>
        <div class="live-grid">
          <div class="live-item">
            <label>Pump 1 Current:</label>
            <span id="pump1Current">-- mA</span>
          </div>
          <div class="live-item">
            <label>Pump 2 Current:</label>
            <span id="pump2Current">-- mA</span>
          </div>
          <div class="live-item">
            <label>System Status:</label>
            <span id="systemStatus">--</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab Content -->
    <div id="settings-tab" class="tab-content">
      <div class="settings-section">
        <h2>Pump 1 Settings</h2>
        
        <div class="setting-row">
          <label for="modeSelect">Mode:</label>
          <select id="modeSelect">
            <option value="PLS">Pulse</option>
            <option value="CON">Continuous</option>
          </select>
        </div>

        <div class="setting-row">
          <label for="pauseTime">Pause Time:</label>
          <input type="text" id="pauseTime" placeholder="HH:MM:SS">
        </div>

        <div class="setting-row">
          <label for="timeCyclesSelect">Run Mode:</label>
          <select id="timeCyclesSelect">
            <option value="TIME">Time</option>
            <option value="CYCLE">Cycles</option>
          </select>
        </div>

        <div class="setting-row">
          <label for="timeCyclesValue" id="timeCyclesLabel">Time/Cycles:</label>
          <input type="text" id="timeCyclesValue" placeholder="Value">
        </div>

        <div class="setting-row">
          <label>
            <input type="checkbox" id="proxy1"> Proxy 1
          </label>
        </div>

        <div class="setting-row" id="dwellTime1Row" style="display: none;">
          <label for="dwellTime1">Dwell Time 1:</label>
          <input type="number" id="dwellTime1" min="0" max="255">
        </div>

        <div class="setting-row">
          <label>
            <input type="checkbox" id="proxy2"> Proxy 2
          </label>
        </div>

        <div class="setting-row" id="dwellTime2Row" style="display: none;">
          <label for="dwellTime2">Dwell Time 2:</label>
          <input type="number" id="dwellTime2" min="0" max="255">
        </div>

        <div class="setting-row">
          <label>
            <input type="checkbox" id="levelSense"> Level Sense
          </label>
        </div>

        <div class="setting-row">
          <label for="levelSenseOptions">Level Sense Type:</label>
          <select id="levelSenseOptions">
            <option value="HEF">High Empty Full</option>
            <option value="LEF">Low Empty Full</option>
          </select>
        </div>

        <div class="setting-row">
          <label for="levelNonc">Level Non-Critical:</label>
          <select id="levelNonc">
            <option value="NO">No</option>
            <option value="YES">Yes</option>
          </select>
        </div>

        <!-- Pump 2 Settings -->
        <div class="setting-row">
          <label>
            <input type="checkbox" id="pump2"> Pump 2
          </label>
        </div>

        <div id="pump2SettingsGroup" style="display: none;">
          <h2>Pump 2 Settings</h2>
          
          <div class="setting-row">
            <label for="pump2Mode">Mode:</label>
            <select id="pump2Mode">
              <option value="PLS">Pulse</option>
              <option value="CON">Continuous</option>
            </select>
          </div>

          <div class="setting-row">
            <label for="pump2PauseTime">Pause Time:</label>
            <input type="text" id="pump2PauseTime" placeholder="HH:MM:SS">
          </div>

          <div class="setting-row">
            <label for="pump2TimeCyclesSelect">Run Mode:</label>
            <select id="pump2TimeCyclesSelect">
              <option value="TIME">Time</option>
              <option value="CYCLE">Cycles</option>
            </select>
          </div>

          <div class="setting-row">
            <label for="pump2TimeCyclesValue" id="pump2TimeCyclesLabel">Time/Cycles:</label>
            <input type="text" id="pump2TimeCyclesValue" placeholder="Value">
          </div>

          <div class="setting-row">
            <label>
              <input type="checkbox" id="pump2Proxy1"> Proxy 1
            </label>
          </div>

          <div class="setting-row" id="pump2DwellTime1Row" style="display: none;">
            <label for="pump2DwellTime1">Dwell Time 1:</label>
            <input type="number" id="pump2DwellTime1" min="0" max="255">
          </div>

          <div class="setting-row">
            <label>
              <input type="checkbox" id="pump2Proxy2"> Proxy 2
            </label>
          </div>

          <div class="setting-row" id="pump2DwellTime2Row" style="display: none;">
            <label for="pump2DwellTime2">Dwell Time 2:</label>
            <input type="number" id="pump2DwellTime2" min="0" max="255">
          </div>

          <div class="setting-row">
            <label>
              <input type="checkbox" id="pump2LevelSense"> Level Sense
            </label>
          </div>

          <div class="setting-row">
            <label for="pump2LevelSenseOptions">Level Sense Type:</label>
            <select id="pump2LevelSenseOptions">
              <option value="HEF">High Empty Full</option>
              <option value="LEF">Low Empty Full</option>
            </select>
          </div>

          <div class="setting-row">
            <label for="pump2LevelNonc">Level Non-Critical:</label>
            <select id="pump2LevelNonc">
              <option value="NO">No</option>
              <option value="YES">Yes</option>
            </select>
          </div>

          <!-- Pump 2 Blockage Detection -->
          <div class="setting-row">
            <label>Pump 2 Blockage Detection:</label>
            <div class="radio-group">
              <label>
                <input type="radio" name="pump2Blockage" id="pump2BlockageManual" value="manual"> Manual
              </label>
              <label>
                <input type="radio" name="pump2Blockage" id="pump2BlockageAuto" value="auto"> Auto Calibrate
              </label>
            </div>
          </div>

          <div class="setting-row">
            <label for="pump2BlockageManualValue">Manual Value (mA):</label>
            <input type="number" id="pump2BlockageManualValue" min="0" max="5000">
          </div>

          <div class="setting-row">
            <label for="pump2BlockageAutoValue">Auto Value:</label>
            <input type="text" id="pump2BlockageAutoValue" readonly>
            <button id="pump2AutoCalibrateBtn">Auto Calibrate</button>
          </div>
        </div>

        <!-- Extra Settings -->
        <h2>Extra Settings</h2>

        <div class="setting-row">
          <label>
            <input type="checkbox" id="extLamp"> External Lamp
          </label>
        </div>

        <div class="setting-row">
          <label for="extLampOptions">Lamp Type:</label>
          <select id="extLampOptions">
            <option value="RGB">RGB</option>
            <option value="WHITE">White</option>
          </select>
        </div>

        <!-- Blockage Detection -->
        <div class="setting-row">
          <label>Pump 1 Blockage Detection:</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="blockage" id="blockageManual" value="manual"> Manual
            </label>
            <label>
              <input type="radio" name="blockage" id="blockageAuto" value="auto"> Auto Calibrate
            </label>
          </div>
        </div>

        <div class="setting-row">
          <label for="blockageManualValue">Manual Value (mA):</label>
          <input type="number" id="blockageManualValue" min="0" max="5000">
        </div>

        <div class="setting-row">
          <label for="blockageAutoValue">Auto Value:</label>
          <input type="text" id="blockageAutoValue" readonly>
          <button id="autoCalibrateBtn">Auto Calibrate</button>
        </div>

        <div class="button-row">
          <button id="saveSettingsBtn" class="save-btn">Save Settings</button>
        </div>
      </div>
    </div>

    <!-- WiFi Tab Content -->
    <div id="wifi-tab" class="tab-content">
      <div class="wifi-section">
        <h2>WiFi Configuration</h2>
        <div class="setting-row">
          <label for="wifiSSID">SSID:</label>
          <input type="text" id="wifiSSID" placeholder="Network Name">
        </div>
        <div class="setting-row">
          <label for="wifiPassword">Password:</label>
          <input type="password" id="wifiPassword" placeholder="Network Password">
        </div>
        <div class="button-row">
          <button id="saveWiFiBtn" class="save-btn">Save WiFi Settings</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // MQTT connection variables
    const hivemqBrokerUrl = 'wss://broker.hivemq.com:8884/mqtt';
    const hivemqUsername = '';
    const hivemqPassword = '';
    let client = null;
    let serial = null;
    let queryTimeout = null;
    let isAlreadyConnected = false;
    let deviceSerial = null;
    let deviceVersion = null;
    let latestSettingsPayload = { p1: null, p2: null, xtra: null };
    let pump1IsOn = false;
    let pump2IsOn = false;
    let p1AutoCalibrating = false;
    let p2AutoCalibrating = false;

    // Tab elements
    const tabMainBtn = document.getElementById('tab-main');
    const tabLiveBtn = document.getElementById('tab-live');
    const tabSettingsBtn = document.getElementById('tab-settings');
    const tabWiFiBtn = document.getElementById('tab-wifi');
    const tabMain = document.getElementById('main-tab');
    const tabLive = document.getElementById('live-tab');
    const tabSettings = document.getElementById('settings-tab');
    const tabWiFi = document.getElementById('wifi-tab');

    // Utility functions
    function getSerialFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('serial');
    }

    function showStatus(message, isError = false) {
      const statusElement = document.getElementById('status-message');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = isError ? 'status-message error' : 'status-message';
      }
    }

    function secondsToHMS(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function secondsToMS(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function HMSToSeconds(hms) {
      const parts = hms.split(':');
      if (parts.length === 3) {
        return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
      }
      return 0;
    }

    function MSToSeconds(ms) {
      const parts = ms.split(':');
      if (parts.length === 2) {
        return parseInt(parts[0]) * 60 + parseInt(parts[1]);
      }
      return 0;
    }

    // Tab switching functions
    function switchAwayFromSettings() {
      // Any cleanup when leaving settings tab
    }

    function updateTimeCyclesLabel() {
      const select = document.getElementById('timeCyclesSelect');
      const label = document.getElementById('timeCyclesLabel');
      label.textContent = select.value === 'TIME' ? 'Time (MM:SS):' : 'Cycles:';
    }

    function updatePump2TimeCyclesLabel() {
      const select = document.getElementById('pump2TimeCyclesSelect');
      const label = document.getElementById('pump2TimeCyclesLabel');
      label.textContent = select.value === 'TIME' ? 'Time (MM:SS):' : 'Cycles:';
    }

    function setupShowHideCheckbox(checkboxId, targetId) {
      const checkbox = document.getElementById(checkboxId);
      const target = document.getElementById(targetId);
      
      if (!checkbox || !target) return;
      
      function updateVisibility() {
        target.style.display = checkbox.checked ? '' : 'none';
      }
      
      updateVisibility();
      checkbox.addEventListener('change', updateVisibility);
    }

    // MQTT connection and query function
    function connectMQTTAndQuery(forceSettingsQuery = false) {
      // If we already have connection and device info, and we're not forcing settings query, just restore display
      if (isAlreadyConnected && client && client.connected && deviceSerial && deviceVersion && !forceSettingsQuery) {
        document.getElementById("serial-number").textContent = deviceSerial;
        document.getElementById("ver-string").textContent = deviceVersion;
        showStatus("");
        return;
      }
      
      // Try URL first, then localStorage, then fail
      serial = getSerialFromURL();
      if (!serial) {
        serial = localStorage.getItem('deviceSerial');
      }
      if (!serial) {
        showStatus("No serial number provided in URL.", true);
        return;
      }
      
      showStatus("Connecting to device...", false);

      client = mqtt.connect(hivemqBrokerUrl, {
        clientId: 'webClient-' + Math.random().toString(16).substr(2, 8),
        username: hivemqUsername,
        password: hivemqPassword,
        clean: true,
        connectTimeout: 4000,
        reconnectPeriod: 2000,
      });

      client.on('connect', function() {
        isAlreadyConnected = true;
        showStatus("Connected. Querying device...");
        const responseTopic = `a3/${serial}/serialResponse`;
        const P1testResponseTopic = `a3/${serial}/test/pump1`;
        const P2testResponseTopic = `a3/${serial}/test/pump2`;
        const P1prox1TestTopic = `a3/${serial}/test/p1proxy1`;
        const P1prox2TestTopic = `a3/${serial}/test/p1proxy2`;
        const P2prox1TestTopic = `a3/${serial}/test/p2proxy1`;
        const P2prox2TestTopic = `a3/${serial}/test/p2proxy2`;
        const P1settingsReplyTopic = `a3/${serial}/P1settingsReply`;
        const P2settingsReplyTopic = `a3/${serial}/P2settingsReply`;
        const xtraSettingsReplyTopic = `a3/${serial}/xtraSettingsReply`;

        // Subscribe to all topics first
        client.subscribe(responseTopic);
        client.subscribe(P1testResponseTopic);
        client.subscribe(P2testResponseTopic);
        client.subscribe(P1prox1TestTopic);
        client.subscribe(P1prox2TestTopic);
        client.subscribe(P2prox1TestTopic);
        client.subscribe(P2prox2TestTopic);
        client.subscribe(P1settingsReplyTopic);
        client.subscribe(P2settingsReplyTopic);
        client.subscribe(xtraSettingsReplyTopic);

        // Query for serial first if we don't have device info
        if (!deviceSerial || !deviceVersion) {
          client.publish(`a3/${serial}/querySerial`, "mainQuery");
        } else if (forceSettingsQuery) {
          // We have device info, just query settings
          latestSettingsPayload = { p1: null, p2: null, xtra: null };
          client.publish(`a3/${serial}/queryP1Settings`, serial);
          client.publish(`a3/${serial}/queryP2Settings`, serial);
          client.publish(`a3/${serial}/queryXtraSettings`, serial);
        }

        queryTimeout = setTimeout(() => {
          showStatus("No response from device. Please check connection and try again.", true);
        }, 10000);
      });

      client.on('message', function(topic, message) {
        console.log("MQTT message received:", topic, message.toString());
        
        // Serial response handler
        if (topic === `a3/${serial}/serialResponse`) {
          try {
            const payload = JSON.parse(message.toString());
            if (payload.serial) {
              deviceSerial = payload.serial;
              localStorage.setItem('deviceSerial', deviceSerial);
              document.getElementById("serial-number").textContent = payload.serial;
            }
            if (payload.version) {
              deviceVersion = payload.version;
              localStorage.setItem('deviceVersion', deviceVersion);
              document.getElementById("ver-string").textContent = payload.version;
            }
            
            clearTimeout(queryTimeout);

            // If we're forcing settings query, now request all three settings
            if (forceSettingsQuery) {
              showStatus("Querying device for settings...", false);
              
              latestSettingsPayload = { p1: null, p2: null, xtra: null };
              client.publish(`a3/${serial}/queryP1Settings`, serial);
              client.publish(`a3/${serial}/queryP2Settings`, serial);
              client.publish(`a3/${serial}/queryXtraSettings`, serial);
              
              queryTimeout = setTimeout(() => {
                showStatus("Failed to load device settings. Device may be offline.", true);
              }, 10000);
            } else {
              showStatus("");
            }

          } catch (e) {
            showStatus("Error parsing device response.", true);
          }
        }

        // P1 settings response handler
        if (topic === `a3/${serial}/P1settingsReply`) {
          latestSettingsPayload.p1 = message.toString();
          if (latestSettingsPayload.p1 && latestSettingsPayload.p2 && latestSettingsPayload.xtra) {
            if (window.preloadingForSettingsTab) {
              clearTimeout(window.preloadTimeout);
              applySettingsFromPayload(latestSettingsPayload);
              showSettingsTabAfterPreload();
            } else {
              applySettingsFromPayload(latestSettingsPayload);
              showStatus("Settings loaded from device.");
              clearTimeout(queryTimeout);
            }
          }
        }

        // P2 settings response handler
        if (topic === `a3/${serial}/P2settingsReply`) {
          latestSettingsPayload.p2 = message.toString();
          if (latestSettingsPayload.p1 && latestSettingsPayload.p2 && latestSettingsPayload.xtra) {
            if (window.preloadingForSettingsTab) {
              clearTimeout(window.preloadTimeout);
              applySettingsFromPayload(latestSettingsPayload);
              showSettingsTabAfterPreload();
            } else {
              applySettingsFromPayload(latestSettingsPayload);
              showStatus("Settings loaded from device.");
              clearTimeout(queryTimeout);
            }
          }
        }

        // Xtra settings response handler
        if (topic === `a3/${serial}/xtraSettingsReply`) {
          latestSettingsPayload.xtra = message.toString();
          if (latestSettingsPayload.p1 && latestSettingsPayload.p2 && latestSettingsPayload.xtra) {
            if (window.preloadingForSettingsTab) {
              clearTimeout(window.preloadTimeout);
              applySettingsFromPayload(latestSettingsPayload);
              showSettingsTabAfterPreload();
            } else {
              applySettingsFromPayload(latestSettingsPayload);
              showStatus("Settings loaded from device.");
              clearTimeout(queryTimeout);
            }
          }
        }

        // Pump1 test handler
        if (topic === `a3/${serial}/test/pump1`) {
          const btn = document.getElementById('pump1TestBtn');
          const payload = message.toString();
          
          if (btn) {
            if (payload === "running") {
              btn.classList.add('pump-on');
              btn.classList.remove('pump-off');
              btn.textContent = "Pump 1: ON";
              pump1IsOn = true;
            } else if (payload === "stopped") {
              btn.classList.remove('pump-on');
              btn.classList.add('pump-off');
              btn.textContent = "Pump 1: OFF";
              pump1IsOn = false;
            }
          }
          
          if (p1AutoCalibrating) {
            if (payload === "startingTest") {
              document.getElementById('blockageAutoValue').value = 'Pump running';
              console.log("P1 auto calibration: pump running");
            } else if (!isNaN(parseFloat(payload))) {
              document.getElementById('blockageAutoValue').value = payload;
              p1AutoCalibrating = false;
              console.log("P1 auto calibration complete: " + payload);
            }
          }
        }

        // Pump2 test handler
        if (topic === `a3/${serial}/test/pump2`) {
          const btn = document.getElementById('pump2TestBtn');
          const payload = message.toString();
          
          if (btn) {
            if (payload === "running") {
              btn.classList.add('pump-on');
              btn.classList.remove('pump-off');
              btn.textContent = "Pump 2: ON";
              pump2IsOn = true;
            } else if (payload === "stopped") {
              btn.classList.remove('pump-on');
              btn.classList.add('pump-off');
              btn.textContent = "Pump 2: OFF";
              pump2IsOn = false;
            }
          }
          
          if (p2AutoCalibrating) {
            console.log("Processing pump2 auto calibration message:", payload);
            if (payload === "startingTest") {
              document.getElementById('pump2BlockageAutoValue').value = 'Pump running';
              console.log("P2 auto calibration: pump running");
            } else if (!isNaN(parseFloat(payload))) {
              document.getElementById('pump2BlockageAutoValue').value = payload;
              p2AutoCalibrating = false;
              console.log("P2 auto calibration complete: " + payload);
            }
          }
        }

        // Proxy handlers
        if (topic === `a3/${serial}/test/p1proxy1`) {
          const ind = document.getElementById('proxy1Indicator');
          if (!ind) return;
          const payload = message.toString();
          if (payload === "on") {
            ind.classList.remove('proxy-off');
            ind.classList.add('proxy-on');
            ind.textContent = "ON";
          } else if (payload === "off") {
            ind.classList.remove('proxy-on');
            ind.classList.add('proxy-off');
            ind.textContent = "OFF";
          }
        }

        if (topic === `a3/${serial}/test/p1proxy2`) {
          const ind = document.getElementById('proxy2Indicator');
          if (!ind) return;
          const payload = message.toString();
          if (payload === "on") {
            ind.classList.remove('proxy-off');
            ind.classList.add('proxy-on');
            ind.textContent = "ON";
          } else if (payload === "off") {
            ind.classList.remove('proxy-on');
            ind.classList.add('proxy-off');
            ind.textContent = "OFF";
          }
        }

        if (topic === `a3/${serial}/test/p2proxy1`) {
          const ind = document.getElementById('pump2Proxy1Indicator');
          if (!ind) return;
          const payload = message.toString();
          if (payload === "on") {
            ind.classList.remove('proxy-off');
            ind.classList.add('proxy-on');
            ind.textContent = "ON";
          } else if (payload === "off") {
            ind.classList.remove('proxy-on');
            ind.classList.add('proxy-off');
            ind.textContent = "OFF";
          }
        }

        if (topic === `a3/${serial}/test/p2proxy2`) {
          const ind = document.getElementById('pump2Proxy2Indicator');
          if (!ind) return;
          const payload = message.toString();
          if (payload === "on") {
            ind.classList.remove('proxy-off');
            ind.classList.add('proxy-on');
            ind.textContent = "ON";
          } else if (payload === "off") {
            ind.classList.remove('proxy-on');
            ind.classList.add('proxy-off');
            ind.textContent = "OFF";
          }
        }
      });

      client.on('error', function() {
        showStatus("MQTT connection error.", true);
      });
    }

    // Settings application function
    function applySettingsFromPayload(payloads) {
      console.log("applySettingsFromPayload called with:", payloads);
      
      try {
        const settingsP1 = payloads.p1 ? JSON.parse(payloads.p1) : {};
        const settingsP2 = payloads.p2 ? JSON.parse(payloads.p2) : {};
        const settingsXtra = payloads.xtra ? JSON.parse(payloads.xtra) : {};

        console.log("Parsed P1 settings:", settingsP1);
        console.log("Parsed P2 settings:", settingsP2);
        console.log("Parsed Xtra settings:", settingsXtra);

        // Apply P1 settings
        if (settingsP1.modeP1) {
          document.getElementById('modeSelect').value = settingsP1.modeP1;
        }
        
        if (settingsP1.pauseTimeP1 !== undefined) {
          document.getElementById('pauseTime').value = secondsToHMS(settingsP1.pauseTimeP1);
        }
        
        if (settingsP1.runModeP1) {
          document.getElementById('timeCyclesSelect').value = settingsP1.runModeP1;
        }
        
        if (settingsP1.timeCyclesP1 !== undefined) {
          const timeCyclesValue = settingsP1.runModeP1 === 'TIME' ? 
            secondsToMS(settingsP1.timeCyclesP1) : 
            settingsP1.timeCyclesP1.toString();
          document.getElementById('timeCyclesValue').value = timeCyclesValue;
        }
        
        if (settingsP1.proxy1P1 !== undefined) {
          document.getElementById('proxy1').checked = settingsP1.proxy1P1 === "YES";
        }
        
        if (settingsP1.proxy2P1 !== undefined) {
          document.getElementById('proxy2').checked = settingsP1.proxy2P1 === "YES";
        }
        
        if (settingsP1.dwellTimeP1Px1 !== undefined) {
          document.getElementById('dwellTime1').value = settingsP1.dwellTimeP1Px1.toString();
        }
        
        if (settingsP1.dwellTimeP1Px2 !== undefined) {
          document.getElementById('dwellTime2').value = settingsP1.dwellTimeP1Px2.toString();
        }
        
        if (settingsP1.levelP1 !== undefined) {
          document.getElementById('levelSense').checked = settingsP1.levelP1 === "YES";
        }
        
        if (settingsP1.levelTypeP1) {
          document.getElementById('levelSenseOptions').value = settingsP1.levelTypeP1;
        }
        
        if (settingsP1.levelNoncP1) {
          document.getElementById('levelNonc').value = settingsP1.levelNoncP1;
        }

        // Apply P2 settings
        if (settingsP2.pump2InUse !== undefined) {
          document.getElementById('pump2').checked = settingsP2.pump2InUse === "YES";
        }
        
        if (settingsP2.modeP2) {
          document.getElementById('pump2Mode').value = settingsP2.modeP2;
        }
        
        if (settingsP2.pauseTimeP2 !== undefined) {
          document.getElementById('pump2PauseTime').value = secondsToHMS(settingsP2.pauseTimeP2);
        }
        
        if (settingsP2.runModeP2) {
          document.getElementById('pump2TimeCyclesSelect').value = settingsP2.runModeP2;
        }
        
        if (settingsP2.timeCyclesP2 !== undefined) {
          const pump2TimeCyclesValue = settingsP2.runModeP2 === 'TIME' ? 
            secondsToMS(settingsP2.timeCyclesP2) : 
            settingsP2.timeCyclesP2.toString();
          document.getElementById('pump2TimeCyclesValue').value = pump2TimeCyclesValue;
        }
        
        if (settingsP2.proxy1P2 !== undefined) {
          document.getElementById('pump2Proxy1').checked = settingsP2.proxy1P2 === "YES";
        }
        
        if (settingsP2.proxy2P2 !== undefined) {
          document.getElementById('pump2Proxy2').checked = settingsP2.proxy2P2 === "YES";
        }
        
        if (settingsP2.dwellTimeP2Px1 !== undefined) {
          document.getElementById('pump2DwellTime1').value = settingsP2.dwellTimeP2Px1.toString();
        }
        
        if (settingsP2.dwellTimeP2Px2 !== undefined) {
          document.getElementById('pump2DwellTime2').value = settingsP2.dwellTimeP2Px2.toString();
        }
        
        if (settingsP2.levelP2 !== undefined) {
          document.getElementById('pump2LevelSense').checked = settingsP2.levelP2 === "YES";
        }
        
        if (settingsP2.levelTypeP2) {
          document.getElementById('pump2LevelSenseOptions').value = settingsP2.levelTypeP2;
        }
        
        if (settingsP2.levelNoncP2) {
          document.getElementById('pump2LevelNonc').value = settingsP2.levelNoncP2;
        }

        // Apply Xtra settings
        if (settingsXtra.extLampInUse !== undefined) {
          document.getElementById('extLamp').checked = settingsXtra.extLampInUse === "YES";
        }
        
        if (settingsXtra.extLampType) {
          document.getElementById('extLampOptions').value = settingsXtra.extLampType;
        }
        
        if (settingsXtra.blockCurrentP1 !== undefined) {
          document.getElementById('blockageManualValue').value = settingsXtra.blockCurrentP1.toString();
          document.getElementById('blockageManual').checked = true;
        }
        
        if (settingsXtra.blockCurrentP2 !== undefined) {
          document.getElementById('pump2BlockageManualValue').value = settingsXtra.blockCurrentP2.toString();
          document.getElementById('pump2BlockageManual').checked = true;
        }

        // Apply visibility logic
        const pump2Checked = document.getElementById('pump2').checked;
        const pump2SettingsGroup = document.getElementById('pump2SettingsGroup');
        if (pump2SettingsGroup) {
          pump2SettingsGroup.style.display = pump2Checked ? '' : 'none';
        }

        // Apply other visibility rules
        const proxy1Checked = document.getElementById('proxy1').checked;
        const proxy2Checked = document.getElementById('proxy2').checked;
        document.getElementById('dwellTime1Row').style.display = proxy1Checked ? '' : 'none';
        document.getElementById('dwellTime2Row').style.display = proxy2Checked ? '' : 'none';

        if (pump2Checked) {
          const pump2Proxy1Checked = document.getElementById('pump2Proxy1').checked;
          const pump2Proxy2Checked = document.getElementById('pump2Proxy2').checked;
          document.getElementById('pump2DwellTime1Row').style.display = pump2Proxy1Checked ? '' : 'none';
          document.getElementById('pump2DwellTime2Row').style.display = pump2Proxy2Checked ? '' : 'none';
        }

        updateTimeCyclesLabel();
        updatePump2TimeCyclesLabel();

      } catch (e) {
        console.error("applySettingsFromPayload error:", e);
        showStatus("Failed to parse settings from device.", true);
      }
    }

    // Settings compilation functions
    function compileP1Settings() {
      const p1Settings = {
        modeP1: document.getElementById('modeSelect').value,
        pauseTimeP1: HMSToSeconds(document.getElementById('pauseTime').value || "00:00:10"),
        runModeP1: document.getElementById('timeCyclesSelect').value,
        proxy1P1: document.getElementById('proxy1').checked ? "YES" : "NO",
        proxy2P1: document.getElementById('proxy2').checked ? "YES" : "NO",
        dwellTimeP1Px1: parseInt(document.getElementById('dwellTime1').value) || 15,
        dwellTimeP1Px2: parseInt(document.getElementById('dwellTime2').value) || 10,
        levelP1: document.getElementById('levelSense').checked ? "YES" : "NO",
        levelTypeP1: document.getElementById('levelSenseOptions').value,
        levelNoncP1: document.getElementById('levelNonc').value
      };

      const timeCyclesValue = document.getElementById('timeCyclesValue').value;
      if (p1Settings.runModeP1 === 'TIME') {
        p1Settings.timeCyclesP1 = MSToSeconds(timeCyclesValue || "00:15");
      } else {
        p1Settings.timeCyclesP1 = parseInt(timeCyclesValue) || 10;
      }

      return JSON.stringify(p1Settings);
    }

    function compileP2Settings() {
      const p2Settings = {
        pump2InUse: document.getElementById('pump2').checked ? "YES" : "NO"
      };
      
      if (document.getElementById('pump2').checked) {
        p2Settings.modeP2 = document.getElementById('pump2Mode').value;
        p2Settings.pauseTimeP2 = HMSToSeconds(document.getElementById('pump2PauseTime').value || "00:00:10");
        p2Settings.runModeP2 = document.getElementById('pump2TimeCyclesSelect').value;
        p2Settings.proxy1P2 = document.getElementById('pump2Proxy1').checked ? "YES" : "NO";
        p2Settings.proxy2P2 = document.getElementById('pump2Proxy2').checked ? "YES" : "NO";
        p2Settings.dwellTimeP2Px1 = parseInt(document.getElementById('pump2DwellTime1').value) || 10;
        p2Settings.dwellTimeP2Px2 = parseInt(document.getElementById('pump2DwellTime2').value) || 10;
        p2Settings.levelP2 = document.getElementById('pump2LevelSense').checked ? "YES" : "NO";
        p2Settings.levelTypeP2 = document.getElementById('pump2LevelSenseOptions').value;
        p2Settings.levelNoncP2 = document.getElementById('pump2LevelNonc').value;

        const pump2TimeCyclesValue = document.getElementById('pump2TimeCyclesValue').value;
        if (p2Settings.runModeP2 === 'TIME') {
          p2Settings.timeCyclesP2 = MSToSeconds(pump2TimeCyclesValue || "00:05");
        } else {
          p2Settings.timeCyclesP2 = parseInt(pump2TimeCyclesValue) || 5;
        }
      }
      
      return JSON.stringify(p2Settings);
    }

    function compileXtraSettings() {
      const xtraSettings = {
        extLampInUse: document.getElementById('extLamp').checked ? "YES" : "NO"
      };
      
      if (document.getElementById('extLamp').checked) {
        xtraSettings.extLampType = document.getElementById('extLampOptions').value;
      }
      
      if (document.getElementById('blockageManual').checked && document.getElementById('blockageManualValue').value) {
        xtraSettings.blockCurrentP1 = parseFloat(document.getElementById('blockageManualValue').value) || 0;
      } else if (document.getElementById('blockageAuto').checked && document.getElementById('blockageAutoValue').value) {
        xtraSettings.blockCurrentP1 = parseFloat(document.getElementById('blockageAutoValue').value) || 0;
      }
      
      if (document.getElementById('pump2').checked) {
        if (document.getElementById('pump2BlockageManual').checked && document.getElementById('pump2BlockageManualValue').value) {
          xtraSettings.blockCurrentP2 = parseFloat(document.getElementById('pump2BlockageManualValue').value) || 0;
        } else if (document.getElementById('pump2BlockageAuto').checked && document.getElementById('pump2BlockageAutoValue').value) {
          xtraSettings.blockCurrentP2 = parseFloat(document.getElementById('pump2BlockageAutoValue').value) || 0;
        }
      }
      
      return JSON.stringify(xtraSettings);
    }

    // Pre-loading functions for Settings tab
    function preloadSettingsForTab() {
      const timeout = setTimeout(() => {
        showStatus("Failed to load settings. Showing with defaults.", true);
        showSettingsTabAfterPreload();
      }, 8000);
      
      window.preloadTimeout = timeout;
      
      if (client && client.connected && serial) {
        latestSettingsPayload = { p1: null, p2: null, xtra: null };
        client.publish(`a3/${serial}/queryP1Settings`, serial);
        client.publish(`a3/${serial}/queryP2Settings`, serial);
        client.publish(`a3/${serial}/queryXtraSettings`, serial);
      } else {
        clearTimeout(timeout);
        showSettingsTabAfterPreload();
      }
    }

    function showSettingsTabAfterPreload() {
      window.preloadingForSettingsTab = false;
      
      switchAwayFromSettings();
      tabMainBtn.classList.remove('active');
      tabLiveBtn.classList.remove('active');
      tabSettingsBtn.classList.add('active');
      tabWiFiBtn.classList.remove('active');
      tabMain.classList.remove('active');
      tabLive.classList.remove('active');
      tabSettings.classList.add('active');
      tabWiFi.classList.remove('active');

      setupShowHideCheckbox('pump2', 'pump2SettingsGroup');
      showStatus("Settings tab loaded.", false);
    }

    // Event listeners
    window.addEventListener('load', function() {
      connectMQTTAndQuery();
    });

    // Tab event listeners
    tabMainBtn.onclick = function() {
      switchAwayFromSettings();
      tabMainBtn.classList.add('active');
      tabLiveBtn.classList.remove('active');
      tabSettingsBtn.classList.remove('active');
      tabWiFiBtn.classList.remove('active');
      tabMain.classList.add('active');
      tabLive.classList.remove('active');
      tabSettings.classList.remove('active');
      tabWiFi.classList.remove('active');
    };

    tabLiveBtn.onclick = function() {
      switchAwayFromSettings();
      tabMainBtn.classList.remove('active');
      tabLiveBtn.classList.add('active');
      tabSettingsBtn.classList.remove('active');
      tabWiFiBtn.classList.remove('active');
      tabMain.classList.remove('active');
      tabLive.classList.add('active');
      tabSettings.classList.remove('active');
      tabWiFi.classList.remove('active');
    };

    // MODIFIED: Settings tab click handler with pre-loading
    tabSettingsBtn.onclick = function() {
      showStatus("Loading device settings...", false);
      window.preloadingForSettingsTab = true;
      preloadSettingsForTab();
    };

    tabWiFiBtn.onclick = function() {
      switchAwayFromSettings();
      tabMainBtn.classList.remove('active');
      tabLiveBtn.classList.remove('active');
      tabSettingsBtn.classList.remove('active');
      tabWiFiBtn.classList.add('active');
      tabMain.classList.remove('active');
      tabLive.classList.remove('active');
      tabSettings.classList.remove('active');
      tabWiFi.classList.add('active');
    };

    // Pump control event listeners
    document.getElementById('pump1TestBtn').onclick = function() {
      if (client && client.connected && serial) {
        const command = pump1IsOn ? 'stop' : 'start';
        client.publish(`a3/${serial}/test/pump1`, command);
      }
    };

    document.getElementById('pump2TestBtn').onclick = function() {
      if (client && client.connected && serial) {
        const command = pump2IsOn ? 'stop' : 'start';
        client.publish(`a3/${serial}/test/pump2`, command);
      }
    };

    // Auto calibration event listeners
    document.getElementById('autoCalibrateBtn').onclick = function() {
      if (client && client.connected && serial) {
        p1AutoCalibrating = true;
        document.getElementById('blockageAutoValue').value = 'Starting...';
        client.publish(`a3/${serial}/test/autoCalibration`, 'P1');
      }
    };

    document.getElementById('pump2AutoCalibrateBtn').onclick = function() {
      if (client && client.connected && serial) {
        p2AutoCalibrating = true;
        document.getElementById('pump2BlockageAutoValue').value = 'Starting...';
        client.publish(`a3/${serial}/test/autoCalibration`, 'P2');
      }
    };

    // Settings form event listeners
    document.getElementById('timeCyclesSelect').addEventListener('change', updateTimeCyclesLabel);
    document.getElementById('pump2TimeCyclesSelect').addEventListener('change', updatePump2TimeCyclesLabel);

    document.getElementById('proxy1').addEventListener('change', function() {
      document.getElementById('dwellTime1Row').style.display = this.checked ? '' : 'none';
    });

    document.getElementById('proxy2').addEventListener('change', function() {
      document.getElementById('dwellTime2Row').style.display = this.checked ? '' : 'none';
    });

    document.getElementById('pump2Proxy1').addEventListener('change', function() {
      document.getElementById('pump2DwellTime1Row').style.display = this.checked ? '' : 'none';
    });

    document.getElementById('pump2Proxy2').addEventListener('change', function() {
      document.getElementById('pump2DwellTime2Row').style.display = this.checked ? '' : 'none';
    });

    // Save settings event listener
    document.getElementById('saveSettingsBtn').onclick = function() {
      if (client && client.connected && serial) {
        showStatus("Saving settings...", false);
        
        const p1Settings = compileP1Settings();
        const p2Settings = compileP2Settings();
        const xtraSettings = compileXtraSettings();
        
        client.publish(`a3/${serial}/P1settings`, p1Settings);
        client.publish(`a3/${serial}/P2settings`, p2Settings);
        client.publish(`a3/${serial}/xtraSettings`, xtraSettings);
        
        setTimeout(() => {
          showStatus("Settings saved successfully.", false);
          // Switch back to main tab
          tabMainBtn.click();
        }, 1000);
      } else {
        showStatus("Not connected to device.", true);
      }
    };

    // Initialize labels
    updateTimeCyclesLabel();
    updatePump2TimeCyclesLabel();
  </script>
</body>
</html>