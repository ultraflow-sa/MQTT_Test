<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A3 Setup</title>
    <script>
      // Dynamically load the stylesheet with cache busting
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/style.css?v=' + new Date().getTime();
      document.head.appendChild(link);
    </script>
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
  </head>
  <body>
    <div class="header-box">
      <h1>A3 Setup</h1>
    </div>
    <div class="content main-content">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" id="tabMainBtn" type="button">Main</button>
        <button class="tab-btn" id="tabSettingsBtn" type="button">Settings</button>
        <button class="tab-btn" id="tabWiFiBtn" type="button">WiFi</button>
      </div>
      <!-- Tab Contents -->
      <div class="tab-content active" id="tabMain">
        <div class="info-row">
          <div>
            Serial: <span id="serial-number" class="info-value">...</span>
          </div>
          <div>
            Version: <span id="ver-string" class="info-value">...</span>
          </div>
        </div>
        <div id="status-message" class="status-message"></div>
        <div class="btn-row">
          <button class="btn" id="backBtn">CHANGE</button>
        </div>
      </div>
      <div class="tab-content" id="tabSettings">
        <div style="margin: 40px 0 20px 0; text-align: center;">
          <strong>Settings tab content goes here.</strong>
        </div>
        <!-- Add your settings form/fields here -->
      </div>
      <div class="tab-content" id="tabWiFi">
        <form id="wifiFormMain" autocomplete="off">
          <div class="fields-flex">
            <div class="input-group">
              <label for="ssid-main">WiFi Name:</label>
              <input type="text" id="ssid-main" name="ssid" required>
            </div>
            <div class="input-group">
              <label for="password-main">WiFi Password:</label>
              <input type="password" id="password-main" name="password" required>
            </div>
          </div>
          <div class="btn-row">
            <button type="submit" class="btn">SAVE</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      // Tab switching logic
      const tabMainBtn = document.getElementById('tabMainBtn');
      const tabSettingsBtn = document.getElementById('tabSettingsBtn');
      const tabWiFiBtn = document.getElementById('tabWiFiBtn');
      const tabMain = document.getElementById('tabMain');
      const tabSettings = document.getElementById('tabSettings');
      const tabWiFi = document.getElementById('tabWiFi');

      tabMainBtn.onclick = function() {
        tabMainBtn.classList.add('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabMain.classList.add('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
      };
      tabSettingsBtn.onclick = function() {
        tabSettingsBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabSettings.classList.add('active');
        tabMain.classList.remove('active');
        tabWiFi.classList.remove('active');
      };
      tabWiFiBtn.onclick = function() {
        tabWiFiBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFi.classList.add('active');
        tabMain.classList.remove('active');
        tabSettings.classList.remove('active');
      };

      // MQTT config
      const hivemqBrokerUrl = 'wss://bd58f8878eef4f5eb73ac65312b10130.s1.eu.hivemq.cloud:8884/mqtt';
      const hivemqUsername = 'a3Admin';
      const hivemqPassword = 'DontLetMeIn247';

      let client = null;
      let serial = null;
      let queryTimeout = null;

      // Get serial from URL
      function getSerialFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("serial");
      }

      function showStatus(msg, isError = false) {
        const status = document.getElementById("status-message");
        status.textContent = msg;
        status.className = "status-message" + (isError ? " error" : "");
      }

      function connectMQTTAndQuery() {
        serial = getSerialFromURL();
        if (!serial) {
          showStatus("No serial number provided in URL.", true);
          return;
        }
        document.getElementById("serial-number").textContent = serial;
        showStatus("Connecting to device...", false);

        client = mqtt.connect(hivemqBrokerUrl, {
          clientId: 'webClient-' + Math.random().toString(16).substr(2, 8),
          username: hivemqUsername,
          password: hivemqPassword,
          clean: true,
          connectTimeout: 4000,
          reconnectPeriod: 2000,
        });

        client.on('connect', function() {
          showStatus("Connected. Querying device...");
          const responseTopic = `a3/${serial}/serialResponse`;
          client.subscribe(responseTopic, function() {
            client.publish(`a3/${serial}/querySerial`, "mainQuery");
          });
          // Timeout if no response in 10 seconds
          queryTimeout = setTimeout(() => {
            showStatus("No response from device. Please check connection and try again.", true);
          }, 10000);
        });

        client.on('message', function(topic, message) {
          if (topic === `a3/${serial}/serialResponse`) {
            try {
              const payload = JSON.parse(message.toString());
              if (payload.serial && payload.version) {
                document.getElementById("serial-number").textContent = payload.serial;
                document.getElementById("ver-string").textContent = payload.version;
                showStatus(""); // Clear status message
                clearTimeout(queryTimeout);
              } else {
                showStatus("Invalid response from device.", true);
              }
            } catch (e) {
              showStatus("Error parsing device response.", true);
            }
          }
        });

        client.on('error', function() {
          showStatus("MQTT connection error.", true);
        });
      }

      // Button navigation
      document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("backBtn").onclick = function() {
          window.location.href = "index.html";
        };
        connectMQTTAndQuery();

        // WiFi form submit handler (for demonstration, prevent default and show alert)
        document.getElementById("wifiFormMain").onsubmit = function(e) {
          e.preventDefault();
          alert("WiFi settings saved (demo only).");
        };
      });

      // Responsive min-height adjustment for all pages
      function adjustMinHeight() {
        const vh = window.innerHeight;
        document.body.style.minHeight = vh + "px";
        const mainContent = document.querySelector('.main-content');
        if (mainContent) mainContent.style.minHeight = (vh - 60) + "px"; // 60px for header
      }
      window.addEventListener("resize", adjustMinHeight);
      window.addEventListener("DOMContentLoaded", adjustMinHeight);
    </script>
  </body>
</html>