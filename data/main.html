<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A3 Setup</title>
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/style.css?v=' + new Date().getTime();
      document.head.appendChild(link);
    </script>
    <style>
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
    </style>
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
  </head>
  <body>
    <div class="header-box">
      <h1>A3 Setup</h1>
    </div>
    <div class="content main-content">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" id="tabMainBtn" type="button">Main</button>
        <button class="tab-btn" id="tabLiveBtn" type="button">Live</button>
        <button class="tab-btn" id="tabSettingsBtn" type="button">Settings</button>
        <button class="tab-btn" id="tabWiFiBtn" type="button">WiFi</button>
      </div>
      <!-- Tab Contents -->
      <div class="tab-content active" id="tabMain">
        <div class="info-row">
          <div>
            Serial: <span id="serial-number" class="info-value">...</span>
          </div>
          <div>
            Version: <span id="ver-string" class="info-value">...</span>
          </div>
        </div>
        <div id="status-message" class="status-message"></div>
        <div class="btn-row">
          <button class="btn" id="backBtn">CHANGE</button>
        </div>
      </div>
      <div class="tab-content" id="tabLive">
        <div id="livePanel">
          <div class="live-panel-container panel-container">
            <!-- Pump1 Section -->
            <div class="live-pump-section pump-section">
              <!-- Pump1 Button Container -->
              <div class="live-pump-header pump-header">
                <span class="live-pump-title pump-title">Pump1</span>
                <button type="button" class="btn live-run-btn pump-btn pump-btn-stopped" id="pump1LiveBtn">RUN</button>
              </div>
              
              <!-- Pump1 Status Rows -->
              <div class="live-row control-row" id="livePump1PauseRow">
                <span class="live-label control-label">Pause Time</span>
                <span class="live-value control-value" id="livePump1PauseValue">00:00:00</span>
              </div>
              <div class="live-row control-row" id="livePump1CyclesRow">
                <span class="live-label control-label">Time/Cycles</span>
                <span class="live-value control-value" id="livePump1CyclesValue">00:00</span>
              </div>
              
              <!-- Pump1 Indicators Container -->
              <div class="indicators-container" id="livePump1IndicatorsContainer">
                <div class="indicator-group" id="livePump1Proxy1Row" style="display:none;">
                  <span class="indicator-label">Proxy1</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump1Proxy1"></span>
                </div>
                <div class="indicator-group" id="livePump1Proxy2Row" style="display:none;">
                  <span class="indicator-label">Proxy2</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump1Proxy2"></span>
                </div>
                <div class="indicator-group" id="livePump1LevelRow" style="display:none;">
                  <span class="indicator-label">Level</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump1Level"></span>
                </div>
                <div class="indicator-group" id="livePump1ExtLampRow" style="display:none;">
                  <span class="indicator-label">Sys Fault</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump1ExtLamp"></span>
                </div>
              </div>
            </div>
            
            <!-- Pump Section Separator -->
            <div class="pump-separator"></div>
            
            <!-- Pump2 Section -->
            <div class="live-pump-section pump-section" id="livePump2Section" style="display:none;">
              <!-- Pump2 Button Container -->
              <div class="live-pump-header pump-header">
                <span class="live-pump-title pump-title">Pump2</span>
                <button type="button" class="btn live-run-btn pump-btn pump-btn-stopped" id="pump2LiveBtn">RUN</button>
              </div>
              
              <!-- Pump2 Status Rows -->
              <div class="live-row control-row" id="livePump2PauseRow">
                <span class="live-label control-label">Pause Time</span>
                <span class="live-value control-value" id="livePump2PauseValue">00:00:00</span>
              </div>
              <div class="live-row control-row" id="livePump2CyclesRow">
                <span class="live-label control-label">Time/Cycles</span>
                <span class="live-value control-value" id="livePump2CyclesValue">00:00</span>
              </div>
              
              <!-- Pump2 Indicators Container -->
              <div class="indicators-container" id="livePump2IndicatorsContainer">
                <div class="indicator-group" id="livePump2Proxy1Row" style="display:none;">
                  <span class="indicator-label">Proxy1</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump2Proxy1"></span>
                </div>
                <div class="indicator-group" id="livePump2Proxy2Row" style="display:none;">
                  <span class="indicator-label">Proxy2</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump2Proxy2"></span>
                </div>
                <div class="indicator-group" id="livePump2LevelRow" style="display:none;">
                  <span class="indicator-label">Level</span>
                  <span class="live-indicator lamp-indicator lamp-off" id="livePump2Level"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tabSettings">
        <form id="settingsForm" autocomplete="off">
          <div class="settings-group" id="settingsFields">
            <!-- Mode -->
            <div class="settings-row">
              <label for="modeSelect"><strong>Mode</strong></label>
              <select id="modeSelect" name="mode">
                <option value="PLS">PLS</option>
                <option value="SLS">SLS</option>
              </select>
            </div>
            <!-- Pause Time -->
            <div class="settings-row">
              <label for="pauseTime"><strong>Pause Time</strong></label>
              <input type="text" id="pauseTime" name="pauseTime" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
            </div>
            <!-- Time/Cycles -->
            <div class="settings-row">
              <label for="timeCyclesSelect"><strong>Time/Cycles</strong></label>
              <select id="timeCyclesSelect" name="timeCycles">
                <option value="TIME">Time</option>
                <option value="CYCLE">Cycles</option>
              </select>
            </div>
            <!-- Time/Cycles Value -->
            <div class="settings-row" id="timeCyclesValueRow">
              <label for="timeCyclesValue" id="timeCyclesValueLabel"><strong>Pump ON Time</strong></label>
              <input type="text" id="timeCyclesValue" name="timeCyclesValue" placeholder="00:00">
            </div>
            <!-- Proxy1 -->
            <div class="settings-row">
              <label for="proxy1"><strong>Proxy1</strong></label>
              <input type="checkbox" id="proxy1" name="proxy1">
            </div>
            <!-- Dwell Time (Proxy1) -->
            <div class="settings-row" id="dwellTime1Row" style="display:none;">
              <label for="dwellTime1"><strong>Dwell Time</strong></label>
              <input type="text" id="dwellTime1" name="dwellTime1" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
            </div>
            <!-- Proxy2 -->
            <div class="settings-row">
              <label for="proxy2"><strong>Proxy2</strong></label>
              <input type="checkbox" id="proxy2" name="proxy2">
            </div>
            <div class="settings-row" id="dwellTime2Row" style="display:none;">
              <label for="dwellTime2"><strong>Dwell Time</strong></label>
              <input type="text" id="dwellTime2" name="dwellTime2" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
            </div>
            <!-- Level Sense -->
            <div class="settings-row">
              <label for="levelSense"><strong>Level Sense</strong></label>
              <input type="checkbox" id="levelSense" name="levelSense">
            </div>
            <div class="settings-row" id="levelSenseOptionsRow" style="display:none;">
              <label for="levelSenseOptions"><strong>Level Sense Mode</strong></label>
              <select id="levelSenseOptions" name="levelSenseOptions">
                <option value="HEF">Hall Sense</option>
                <option value="PULE">Pulse Empty</option>
                <option value="PULF">Pulse Full</option>
                <option value="LLO">Steady</option>
              </select>
            </div>
            <div class="settings-row" id="levelNoncRow" style="display:none;">
              <label for="levelNonc"><strong>Type</strong></label>
              <select id="levelNonc" name="levelNonc">
                <option value="NO">NO</option>
                <option value="NC">NC</option>
              </select>
            </div>
            <!-- Ext Lamp -->
            <div class="settings-row">
              <label for="extLamp"><strong>Sys Fault</strong></label>
              <input type="checkbox" id="extLamp" name="extLamp">
            </div>
            <div class="settings-row" id="extLampOptionsRow" style="display:none;">
              <label for="extLampOptions"><strong>Lamp Mode</strong></label>
              <select id="extLampOptions" name="extLampOptions">
                <option value="RGB">RGB</option>
                <option value="STE">Steady</option>
                <option value="FLA">Flash</option>
              </select>
            </div>
            <!-- Blockage Current -->
            <div class="settings-row">
              <div style="display: flex; flex-direction: column; width: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px;">
                  <label><strong>Blockage Current</strong></label>
                  <button type="button" class="btn blockage-test-btn" id="blockageTestBtn">Test Pump</button>
                </div>
                <div style="text-align: center; width: 100%;">
                  <input type="text" id="blockageCurrentValue" name="blockageCurrentValue" placeholder="Enter motor current" style="width: 200px;">
                </div>
              </div>
            </div>
            <!-- Pump2 -->
            <div class="settings-row">
              <label for="pump2"><strong>Pump2</strong></label>
              <input type="checkbox" id="pump2" name="pump2">
            </div>
            <div id="pump2SettingsGroup" style="display:none;">
              <div class="settings-row">
                <label for="pump2Mode"><strong>Mode</strong></label>
                <select id="pump2Mode" name="pump2Mode">
                  <option value="PLS">PLS</option>
                  <option value="SLS">SLS</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2PauseTime"><strong>Pause Time</strong></label>
                <input type="text" id="pump2PauseTime" name="pump2PauseTime" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
              </div>
              <div class="settings-row">
                <label for="pump2TimeCyclesSelect"><strong>Time/Cycles</strong></label>
                <select id="pump2TimeCyclesSelect" name="pump2TimeCycles">
                  <option value="TIME">Time</option>
                  <option value="CYCLE">Cycles</option>
                </select>
              </div>
              <div class="settings-row" id="pump2TimeCyclesValueRow">
                <label for="pump2TimeCyclesValue" id="pump2TimeCyclesValueLabel"><strong>Pump ON Time</strong></label>
                <input type="text" id="pump2TimeCyclesValue" name="pump2TimeCyclesValue" placeholder="00:00">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy1"><strong>Proxy1</strong></label>
                <input type="checkbox" id="pump2Proxy1" name="pump2Proxy1">
              </div>
              <div class="settings-row" id="pump2DwellTime1Row" style="display:none;">
                <label for="pump2DwellTime1"><strong>Dwell Time</strong></label>
                <input type="text" id="pump2DwellTime1" name="pump2DwellTime1" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy2"><strong>Proxy2</strong></label>
                <input type="checkbox" id="pump2Proxy2" name="pump2Proxy2">
              </div>
              <div class="settings-row" id="pump2DwellTime2Row" style="display:none;">
                <label for="pump2DwellTime2"><strong>Dwell Time</strong></label>
                <input type="text" id="pump2DwellTime2" name="pump2DwellTime2" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
              </div>
              <div class="settings-row">
                <label for="pump2LevelSense"><strong>Level Sense</strong></label>
                <input type="checkbox" id="pump2LevelSense" name="pump2LevelSense">
              </div>
              <div class="settings-row" id="pump2LevelSenseOptionsRow" style="display:none;">
                <label for="pump2LevelSenseOptions"><strong>Level Sense Mode</strong></label>
                <select id="pump2LevelSenseOptions" name="pump2LevelSenseOptions">
                  <option value="HEF">Hall Sense</option>
                  <option value="PULE">Pulse Empty</option>
                  <option value="PULF">Pulse Full</option>
                  <option value="LLO">Steady</option>
                </select>
              </div>
              <div class="settings-row" id="pump2LevelNoncRow" style="display:none;">
                <label for="pump2LevelNonc"><strong>Type</strong></label>
                <select id="pump2LevelNonc" name="pump2LevelNonc">
                  <option value="NO">NO</option>
                  <option value="NC">NC</option>
                </select>
              </div>
              <div class="settings-row">
                <div style="display: flex; flex-direction: column; width: 100%;">
                  <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px;">
                    <label><strong>Blockage Current</strong></label>
                    <button type="button" class="btn blockage-test-btn" id="pump2BlockageTestBtn">Test Pump</button>
                  </div>
                  <div style="text-align: center; width: 100%;">
                    <input type="text" id="pump2BlockageCurrentValue" name="pump2BlockageCurrentValue" placeholder="Enter motor current" style="width: 200px;">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="btn-row" id="testModeBtnRow" style="margin-bottom:10px;">
            <button type="button" class="btn" id="testModeBtn">Test</button>
            <button type="submit" class="btn" id="saveSettingsBtn">Save Settings</button>
          </div>
        </form>
        <!-- Test Mode UI (hidden by default) -->
        <div id="testModePanel" style="display:none;">
          <div class="testmode-panel-container panel-container">
            <!-- Pump1 Section -->
            <div class="pump-control-section">
              <div class="testmode-row control-row">
                <span class="testmode-label control-label">Pump1</span>
                <button type="button" class="btn testmode-pump-btn pump-btn pump-off" id="pump1TestBtn">ON</button>
              </div>
              
              <!-- Pump1 Indicators Container -->
              <div class="indicators-container" id="testPump1IndicatorsContainer">
                <div class="indicator-group" id="proxy1Row">
                  <span class="indicator-label">Proxy1</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="proxy1Indicator"></span>
                </div>
                <div class="indicator-group" id="proxy2Row">
                  <span class="indicator-label">Proxy2</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="proxy2Indicator"></span>
                </div>
                <div class="indicator-group" id="pump1LevelRow" style="display:none;">
                  <span class="indicator-label">Level</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="pump1LevelIndicator"></span>
                </div>
                <div class="indicator-group" id="extLampRow" style="display:none;">
                  <span class="indicator-label">Sys Fault</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="extLampIndicator"></span>
                </div>
              </div>
            </div>
            
            <!-- Pump Section Separator -->
            <div class="pump-separator"></div>
            
            <!-- Pump2 Section -->
            <div class="pump-control-section" id="pump2TestSection" style="display:none;">
              <div class="testmode-row control-row" id="pump2TestRow">
                <span class="testmode-label control-label">Pump2</span>
                <button type="button" class="btn testmode-pump-btn pump-btn pump-off" id="pump2TestBtn">ON</button>
              </div>
              
              <!-- Pump2 Indicators Container -->
              <div class="indicators-container" id="testPump2IndicatorsContainer">
                <div class="indicator-group" id="pump2Proxy1Row" style="display:none;">
                  <span class="indicator-label">Proxy1</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="pump2Proxy1Indicator"></span>
                </div>
                <div class="indicator-group" id="pump2Proxy2Row" style="display:none;">
                  <span class="indicator-label">Proxy2</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="pump2Proxy2Indicator"></span>
                </div>
                <div class="indicator-group" id="pump2LevelRow" style="display:none;">
                  <span class="indicator-label">Level</span>
                  <span class="testmode-indicator lamp-indicator lamp-off" id="pump2LevelIndicator"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="btn-row" style="margin-top:24px;">
            <button type="button" class="btn" id="testModeBackBtn">Back</button>
            <button type="submit" class="btn" id="testModeSaveBtn">Save Settings</button>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tabWiFi">
        <form id="wifiFormMain" autocomplete="off">
          <div class="fields-flex">
            <div class="input-group">
              <label for="ssid-main">WiFi Name:</label>
              <input type="text" id="ssid-main" name="ssid" required>
            </div>
            <div class="input-group">
              <label for="password-main">WiFi Password:</label>
              <input type="password" id="password-main" name="password" required>
            </div>
          </div>
          <div class="btn-row">
            <button type="submit" class="btn">SAVE</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      let latestSettingsPayload = { p1: null, p2: null, xtra: null };
      let p1AutoCalibrating = false;
      let p2AutoCalibrating = false;
      let isAlreadyConnected = false;
      let settingsPreloaded = false;
      let preloadingInProgress = false;
      let preloadStep = 0; // 0 = not started, 1 = P1, 2 = P2, 3 = Xtra, 4 = complete

      // Blockage Current logic for Pump1 and Pump2
      const blockageCurrentValue = document.getElementById('blockageCurrentValue');
      const pump2BlockageCurrentValue = document.getElementById('pump2BlockageCurrentValue');
      const blockageTestBtn = document.getElementById('blockageTestBtn');
      const pump2BlockageTestBtn = document.getElementById('pump2BlockageTestBtn');

      // Track pump state for correct MQTT payload
      let pump1IsOn = false;
      let pump2IsOn = false; // ADD this line

      // Add pump1 test button click handler
      const pump1TestBtn = document.getElementById('pump1TestBtn');
      if (pump1TestBtn) {
        pump1TestBtn.onclick = function() {
          if (client && client.connected && serial) {
            const payload = pump1IsOn ? "off" : "on";
            client.publish(`a3/${serial}/test/pump1`, payload);
            console.log(`Published test command for Pump1: ${payload}`);
          }
        };
      }

      // ADD pump2 test button click handler
      const pump2TestBtn = document.getElementById('pump2TestBtn');
      if (pump2TestBtn) {
        pump2TestBtn.onclick = function() {
          if (client && client.connected && serial) {
            const payload = pump2IsOn ? "off" : "on";
            client.publish(`a3/${serial}/test/pump2`, payload);
            console.log(`Published test command for Pump2: ${payload}`);
          }
        };
      }

      // Blockage test button handlers
      if (blockageTestBtn) {
        blockageTestBtn.onclick = function() {
          if (client && client.connected && serial) {
            p1AutoCalibrating = true;
            blockageCurrentValue.value = 'Pump Starting';
            client.publish(`a3/${serial}/test/pump1`, "currentAutoCalibrate");
            console.log("Started P1 blockage current test");
          }
        };
      }

      if (pump2BlockageTestBtn) {
        pump2BlockageTestBtn.onclick = function() {
          if (client && client.connected && serial) {
            p2AutoCalibrating = true;
            pump2BlockageCurrentValue.value = 'Pump Starting';
            client.publish(`a3/${serial}/test/pump2`, "currentAutoCalibrate");
            console.log("Started P2 blockage current test");
          }
        };
      }

      // Auto calibration functions
      function startP1AutoCalibration() {
        if (client && client.connected && serial) {
          p1AutoCalibrating = true;
          client.publish(`a3/${serial}/test/pump1`, "currentAutoCalibrate");
          console.log("Started P1 auto calibration");
        }
      }

      function startP2AutoCalibration() {
        if (client && client.connected && serial) {
          p2AutoCalibrating = true;
          const topic = `a3/${serial}/test/pump2`;
          const result = client.publish(topic, "currentAutoCalibrate");
          console.log("Started P2 auto calibration - p2AutoCalibrating set to:", p2AutoCalibrating);
        } else {
          console.log("Cannot start P2 auto calibration - requirements not met");
        }
      }

      // Time conversion functions
      function secondsToHMS(seconds) {
        const totalSeconds = parseInt(seconds);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const secs = totalSeconds % 60;
        
        return String(hours).padStart(2, '0') + ':' + 
               String(minutes).padStart(2, '0') + ':' + 
               String(secs).padStart(2, '0');
      }

      function secondsToMS(seconds) {
        const totalSeconds = parseInt(seconds);
        const minutes = Math.floor(totalSeconds / 60);
        const secs = totalSeconds % 60;
        
        return String(minutes).padStart(2, '0') + ':' + 
               String(secs).padStart(2, '0');
      }

      function msToSeconds(msString) {
        const parts = msString.split(':');
        if (parts.length !== 2) return 0;
        
        const minutes = parseInt(parts[0]) || 0;
        const seconds = parseInt(parts[1]) || 0;
        
        return (minutes * 60) + seconds;
      }

      function hmsToSeconds(hmsString) {
        const parts = hmsString.split(':');
        if (parts.length !== 3) return 0;
        
        const hours = parseInt(parts[0]) || 0;
        const minutes = parseInt(parts[1]) || 0;
        const seconds = parseInt(parts[2]) || 0;
        
        return (hours * 3600) + (minutes * 60) + seconds;
      }

      function validateHMSInput(input) {
        input.addEventListener('input', function() {
          let value = this.value.replace(/[^0-9:]/g, '');
          
          // Auto-format as user types
          if (value.length === 2 && !value.includes(':')) {
            value += ':';
          } else if (value.length === 5 && value.split(':').length === 2) {
            value += ':';
          }
          
          this.value = value;
        });

        input.addEventListener('blur', function() {
          let value = this.value;
          const parts = value.split(':');
          
          // Ensure we have 3 parts
          while (parts.length < 3) {
            parts.push('00');
          }
          
          // Validate and format each part
          const hours = Math.max(0, Math.min(99, parseInt(parts[0]) || 0));
          const minutes = Math.max(0, Math.min(59, parseInt(parts[1]) || 0));
          const seconds = Math.max(0, Math.min(59, parseInt(parts[2]) || 0));
          
          this.value = String(hours).padStart(2, '0') + ':' + 
                       String(minutes).padStart(2, '0') + ':' + 
                       String(seconds).padStart(2, '0');
        });
      }

      function validateMSInput(input) {
        input.addEventListener('input', function() {
          // Check if this input is for cycles mode
          const isCycleMode = this.id === 'timeCyclesValue' && 
            document.getElementById('timeCyclesSelect').value === 'CYCLE';
          const isPump2CycleMode = this.id === 'pump2TimeCyclesValue' && 
            document.getElementById('pump2TimeCyclesSelect').value === 'CYCLE';
          
          if (isCycleMode || isPump2CycleMode) {
            // For cycles mode, only allow integers
            let value = this.value.replace(/[^0-9]/g, '');
            this.value = value;
          } else {
            // For time mode, use existing MM:SS formatting
            let value = this.value.replace(/[^0-9:]/g, '');
            if (value.length === 2 && !value.includes(':')) {
              value += ':';
            }
            this.value = value;
          }
        });

        input.addEventListener('blur', function() {
          const isCycleMode = this.id === 'timeCyclesValue' && 
            document.getElementById('timeCyclesSelect').value === 'CYCLE';
          const isPump2CycleMode = this.id === 'pump2TimeCyclesValue' && 
            document.getElementById('pump2TimeCyclesSelect').value === 'CYCLE';
          
          if (isCycleMode || isPump2CycleMode) {
            // For cycles mode, ensure it's a valid integer
            const cycles = parseInt(this.value) || 0;
            this.value = cycles.toString();
          } else {
            // For time mode, use existing MM:SS formatting
            let value = this.value;
            const parts = value.split(':');
            
            while (parts.length < 2) {
              parts.push('00');
            }
            
            const minutes = Math.max(0, Math.min(999, parseInt(parts[0]) || 0));
            const seconds = Math.max(0, Math.min(59, parseInt(parts[1]) || 0));
            
            this.value = String(minutes).padStart(2, '0') + ':' + 
                        String(seconds).padStart(2, '0');
          }
        });
      }

      // Apply validation to inputs
      validateHMSInput(document.getElementById('pauseTime'));
      validateHMSInput(document.getElementById('pump2PauseTime'));
      validateMSInput(document.getElementById('timeCyclesValue'));
      validateMSInput(document.getElementById('pump2TimeCyclesValue'));
      validateHMSInput(document.getElementById('dwellTime1'));
      validateHMSInput(document.getElementById('dwellTime2'));
      validateHMSInput(document.getElementById('pump2DwellTime1'));
      validateHMSInput(document.getElementById('pump2DwellTime2'));

      // Dynamic label updates for Time/Cycles
      function updateTimeCyclesLabel() {
        const timeCyclesSelect = document.getElementById('timeCyclesSelect');
        const timeCyclesValueLabel = document.getElementById('timeCyclesValueLabel');
        const timeCyclesValue = document.getElementById('timeCyclesValue');
        
        // Don't apply conversion during settings loading
        if (window.isLoadingSettings) return;
        
        if (timeCyclesSelect.value === 'TIME') {
          timeCyclesValueLabel.innerHTML = '<strong>Pump ON Time</strong>';
          timeCyclesValue.placeholder = 'Enter Time';
          
          // Clear the value when switching to TIME mode
          timeCyclesValue.value = '00:00';
        } else if (timeCyclesSelect.value === 'CYCLE') {
          timeCyclesValueLabel.innerHTML = '<strong>Pump ON Cycles</strong>';
          timeCyclesValue.placeholder = 'Enter Cycles';
          
          // Clear the value when switching to CYCLE mode
          timeCyclesValue.value = '0';
        }
      }

      function updatePump2TimeCyclesLabel() {
        const pump2TimeCyclesSelect = document.getElementById('pump2TimeCyclesSelect');
        const pump2TimeCyclesValueLabel = document.getElementById('pump2TimeCyclesValueLabel');
        const pump2TimeCyclesValue = document.getElementById('pump2TimeCyclesValue');
        
        // Don't apply conversion during settings loading
        if (window.isLoadingSettings) return;
        
        if (pump2TimeCyclesSelect.value === 'TIME') {
          pump2TimeCyclesValueLabel.innerHTML = '<strong>Pump ON Time</strong>';
          pump2TimeCyclesValue.placeholder = 'Enter Time';
          
          // Clear the value when switching to TIME mode
          pump2TimeCyclesValue.value = '00:00';
        } else if (pump2TimeCyclesSelect.value === 'CYCLE') {
          pump2TimeCyclesValueLabel.innerHTML = '<strong>Pump ON Cycles</strong>';
          pump2TimeCyclesValue.placeholder = 'Enter Cycles';
          
          // Clear the value when switching to CYCLE mode
          pump2TimeCyclesValue.value = '0';
        }
      }

      document.getElementById('timeCyclesSelect').addEventListener('change', updateTimeCyclesLabel);
      document.getElementById('pump2TimeCyclesSelect').addEventListener('change', updatePump2TimeCyclesLabel);

      // Tab switching logic
      const tabMainBtn = document.getElementById('tabMainBtn');
      const tabLiveBtn = document.getElementById('tabLiveBtn');
      const tabSettingsBtn = document.getElementById('tabSettingsBtn');
      const tabWiFiBtn = document.getElementById('tabWiFiBtn');
      const tabMain = document.getElementById('tabMain');
      const tabLive = document.getElementById('tabLive');
      const tabSettings = document.getElementById('tabSettings');
      const tabWiFi = document.getElementById('tabWiFi');

      function switchAwayFromSettings() {
        // Send pump off messages when switching away from settings tab
        const testModePanel = document.getElementById('testModePanel');
        if (testModePanel && testModePanel.style.display !== 'none') {
          sendPumpOffMessages();
        }
      }

      // Add these variables at the top to store device info
      let deviceSerial = null;
      let deviceVersion = null;
      // Live button states
      let pump1LiveRunning = false;
      let pump2LiveRunning = false;
      let pump1LiveBtn = null;
      let pump2LiveBtn = null;

      // Update the main tab click handler
      tabMainBtn.onclick = function() {
        switchAwayFromSettings();
        tabMainBtn.classList.add('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabMain.classList.add('active');
        tabLive.classList.remove('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
        
        // Only show status if settings aren't already preloaded
        if (settingsPreloaded) {
          showStatus("Device connected and ready");
        } else {
          showStatus("");
        }
      };
    
      tabLiveBtn.onclick = function() {
        // Query settings FIRST, before making tab active
        querySettingsForTab('Live');

        switchAwayFromSettings();
        tabLiveBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabLive.classList.add('active');
        tabMain.classList.remove('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
      };

      // Update the Settings tab click handler
      tabSettingsBtn.onclick = function() {
        // Query settings FIRST, before making tab active
        querySettingsForTab('Settings');

        switchAwayFromSettings();
        tabMainBtn.classList.remove('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.add('active');
        tabWiFiBtn.classList.remove('active');
        tabMain.classList.remove('active');
        tabLive.classList.remove('active');
        tabSettings.classList.add('active');
        tabWiFi.classList.remove('active');
      };

      tabWiFiBtn.onclick = function() {
        switchAwayFromSettings(); // ADD this line
        tabWiFiBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFi.classList.add('active');
        tabMain.classList.remove('active');
        tabLive.classList.remove('active');
        tabSettings.classList.remove('active');
      };

      if (pump1LiveBtn) {
        pump1LiveBtn.onclick = function() {
          if (client && client.connected && serial) {
            const command = pump1LiveRunning ? "stop" : "start";
            client.publish(`a3/${serial}/live/pump1`, command);
            console.log(`Published live command for Pump1: ${command}`);
          }
        };
      }

      if (pump2LiveBtn) {
        pump2LiveBtn.onclick = function() {
          if (client && client.connected && serial) {
            const command = pump2LiveRunning ? "stop" : "start";
            client.publish(`a3/${serial}/live/pump2`, command);
            console.log(`Published live command for Pump2: ${command}`);
          }
        };
      }

      // Show/hide logic for dwell time and options fields
      function setupShowHideCheckbox(triggerId, targetRowId) {
        const trigger = document.getElementById(triggerId);
        const target = document.getElementById(targetRowId);
        if (trigger && target) {
          trigger.addEventListener('change', function() {
            target.style.display = this.checked ? '' : 'none';
          });
        }
      }

      function preloadSettings() {
      if (preloadingInProgress) {
        console.log("Preloading already in progress, skipping");
        return;
      }
      
      if (!client || !client.connected) {
        console.log("Not connected, cannot preload settings");
        return;
      }
      
      if (!serial) {
        serial = deviceSerial || getSerialFromURL() || localStorage.getItem('deviceSerial');
      }
      
      if (!serial) {
        showStatus("No device serial available for settings preload", true);
        return;
      }
      
      console.log("Starting sequential settings preload...");
      showStatus("Loading device settings...", false);
      
      // ALWAYS clear any existing timeout first
      if (queryTimeout) {
        console.log("Clearing existing timeout before starting preload");
        clearTimeout(queryTimeout);
        queryTimeout = null;
      }

      // Reset settings payload and flags
      latestSettingsPayload = { p1: null, p2: null, xtra: null };
      settingsPreloaded = false;
      preloadingInProgress = true;
      preloadStep = 1;
      
      queryTimeout = setTimeout(() => {
        console.log("Settings preload timeout - resetting");
        preloadingInProgress = false;
        preloadStep = 0;
        queryTimeout = null;
        showStatus("Settings preload timeout - device may not be responding", true);
      }, 15000); // 15 second timeout for the entire process
      
      // Start with P1 settings
      console.log("Querying P1 settings...");
      client.publish(`a3/${serial}/queryP1Settings`, serial);
    }

      function initializeLiveMode() {
        console.log("Initializing Live Mode display");
        
        // Set initial button states - RED background with RUN label (pump is stopped)
        const pump1LiveBtn = document.getElementById('pump1LiveBtn');
        const pump2LiveBtn = document.getElementById('pump2LiveBtn');
        
        if (pump1LiveBtn) {
          pump1LiveBtn.classList.remove('pump-btn-running');
          pump1LiveBtn.classList.add('pump-btn-stopped');
          pump1LiveBtn.textContent = "RUN";
          // CLICK HANDLER
          pump1LiveBtn.onclick = function() {
            if (client && client.connected && serial) {
              const command = pump1LiveRunning ? "stop" : "start";
              client.publish(`a3/${serial}/live/pump1`, command);
              console.log(`Published live command for Pump1: ${command}`);
            }
          };
        }
        if (pump2LiveBtn) {
          pump2LiveBtn.classList.remove('pump-btn-running');
          pump2LiveBtn.classList.add('pump-btn-stopped');
          pump2LiveBtn.textContent = "RUN";
          // CLICK HANDLER
          pump2LiveBtn.onclick = function() {
            if (client && client.connected && serial) {
              const command = pump2LiveRunning ? "stop" : "start";
              client.publish(`a3/${serial}/live/pump2`, command);
              console.log(`Published live command for Pump2: ${command}`);
            }
          };
        }
        
        // Update live display based on current settings
        updateLiveDisplay();
      }

      function updateHallEffectIndicator(indicator, payload, checkHallEffect, pumpNumber) {
        console.log(`DEBUG: updateHallEffectIndicator called with:`, {
          indicatorId: indicator ? indicator.id : 'null',
          payload: payload,
          checkHallEffect: checkHallEffect,
          pumpNumber: pumpNumber
        });
        
        if (!indicator) {
          console.log('DEBUG: No indicator element found');
          return;
        }
        
        // Get the level type for the appropriate pump
        let levelType = '';
        if (pumpNumber === 1) {
          levelType = document.getElementById('levelSenseOptions') ? document.getElementById('levelSenseOptions').value : '';
        } else if (pumpNumber === 2) {
          levelType = document.getElementById('pump2LevelSenseOptions') ? document.getElementById('pump2LevelSenseOptions').value : '';
        }

        console.log(`DEBUG: Level type for pump ${pumpNumber}: ${levelType}, payload: ${payload}`);

        // Apply Hall Effect logic when level type is HEF
        if (levelType === 'HEF') {
          console.log(`DEBUG: Processing HEF sensor for pump ${pumpNumber}`);
          // This is a Hall Effect sensor - expect percentage values
          indicator.classList.add('hall-effect');
          
          // Remove all level classes first
          indicator.classList.remove('lamp-off', 'lamp-on', 'level-low', 'level-medium', 'level-high');
          
          // Parse percentage from payload
          const percentage = parseFloat(payload);
          
          if (!isNaN(percentage)) {
            indicator.textContent = Math.round(percentage) + '%';
            
            // Apply color coding based on percentage
            if (percentage < 10) {
              indicator.classList.add('level-low');
              console.log(`DEBUG: Applied level-low class for ${percentage}%`);
            } else if (percentage >= 10 && percentage <= 50) {
              indicator.classList.add('level-medium');
              console.log(`DEBUG: Applied level-medium class for ${percentage}%`);
            } else {
              indicator.classList.add('level-high');
              console.log(`DEBUG: Applied level-high class for ${percentage}%`);
            }
          } else {
            // Invalid percentage, show as low level
            indicator.textContent = '0%';
            indicator.classList.add('level-low');
            console.log(`DEBUG: Invalid percentage, showing 0%`);
          }
        } else {
          console.log(`DEBUG: Processing non-HEF sensor for pump ${pumpNumber}`);
          // Regular on/off indicator (non-HEF level types)
          indicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high');
          indicator.textContent = ''; // No text for regular indicators
          
          if (payload === "on") {
            indicator.classList.remove('lamp-off');
            indicator.classList.add('lamp-on');
            console.log(`DEBUG: Set indicator to ON`);
          } else if (payload === "off") {
            indicator.classList.remove('lamp-on');
            indicator.classList.add('lamp-off');
            console.log(`DEBUG: Set indicator to OFF`);
          }
        }
      }

      // Update the updateLiveDisplay function to initialize Hall Effect indicators
      function updateLiveDisplay() {
        console.log("Updating Live Mode display based on settings");
        
        // Get current settings for Time/Cycles mode
        const pump1TimeCyclesMode = document.getElementById('timeCyclesSelect') ? 
          document.getElementById('timeCyclesSelect').value : 'TIME';
        const pump2TimeCyclesMode = document.getElementById('pump2TimeCyclesSelect') ? 
          document.getElementById('pump2TimeCyclesSelect').value : 'TIME';
        
        // Update Pump1 Time/Cycles label based on settings
        const pump1CyclesRow = document.getElementById('livePump1CyclesRow');
        if (pump1CyclesRow) {
          const pump1CyclesLabel = pump1CyclesRow.querySelector('.control-label');
          if (pump1CyclesLabel) {
            if (pump1TimeCyclesMode === 'TIME') {
              pump1CyclesLabel.textContent = 'Pump ON Time';
              console.log("DEBUG: Updated Pump1 cycles label to 'Pump ON Time'");
            } else if (pump1TimeCyclesMode === 'CYCLE') {
              pump1CyclesLabel.textContent = 'Pump ON Cycles';
              console.log("DEBUG: Updated Pump1 cycles label to 'Pump ON Cycles'");
            }
          }
        }

        // Show/hide pump2 section based on settings
        const pump2Enabled = document.getElementById('pump2') && document.getElementById('pump2').checked;
        const livePump2Section = document.getElementById('livePump2Section');
        if (livePump2Section) {
          livePump2Section.style.display = pump2Enabled ? '' : 'none';
        }
        
        if (pump2Enabled) {
          const pump2CyclesRow = document.getElementById('livePump2CyclesRow');
          if (pump2CyclesRow) {
            const pump2CyclesLabel = pump2CyclesRow.querySelector('.control-label');
            if (pump2CyclesLabel) {
              if (pump2TimeCyclesMode === 'TIME') {
                pump2CyclesLabel.textContent = 'Pump ON Time';
                console.log("DEBUG: Updated Pump2 cycles label to 'Pump ON Time'");
              } else if (pump2TimeCyclesMode === 'CYCLE') {
                pump2CyclesLabel.textContent = 'Pump ON Cycles';
                console.log("DEBUG: Updated Pump2 cycles label to 'Pump ON Cycles'");
              }
            }
          }
        }
  
        // Show/hide pump1 rows based on settings
        const proxy1Enabled = document.getElementById('proxy1') && document.getElementById('proxy1').checked;
        const proxy2Enabled = document.getElementById('proxy2') && document.getElementById('proxy2').checked;
        const levelEnabled = document.getElementById('levelSense') && document.getElementById('levelSense').checked;
        const extLampEnabled = document.getElementById('extLamp') && document.getElementById('extLamp').checked;
        
        document.getElementById('livePump1Proxy1Row').style.display = proxy1Enabled ? '' : 'none';
        document.getElementById('livePump1Proxy2Row').style.display = proxy2Enabled ? '' : 'none';
        document.getElementById('livePump1LevelRow').style.display = levelEnabled ? '' : 'none';
        document.getElementById('livePump1ExtLampRow').style.display = extLampEnabled ? '' : 'none';

        // Initialize pump1 level indicator based on level type
        if (levelEnabled) {
          const levelType = document.getElementById('levelSenseOptions') ? document.getElementById('levelSenseOptions').value : '';
          const pump1LevelIndicator = document.getElementById('livePump1Level');
          if (pump1LevelIndicator) {
            if (levelType === 'HEF') {
              pump1LevelIndicator.classList.add('hall-effect');
              pump1LevelIndicator.classList.remove('lamp-off', 'lamp-on', 'level-medium', 'level-high');
              pump1LevelIndicator.classList.add('level-low'); // This should be red for 0%
              pump1LevelIndicator.textContent = '0%';
            } else {
              pump1LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high');
              pump1LevelIndicator.classList.add('lamp-off');
              pump1LevelIndicator.classList.remove('lamp-on');
              pump1LevelIndicator.textContent = '';
            }
          }
        }

        // Update pump2 if enabled
        if (pump2Enabled) {
          const pump2Proxy1Enabled = document.getElementById('pump2Proxy1') && document.getElementById('pump2Proxy1').checked;
          const pump2Proxy2Enabled = document.getElementById('pump2Proxy2') && document.getElementById('pump2Proxy2').checked;
          const pump2LevelEnabled = document.getElementById('pump2LevelSense') && document.getElementById('pump2LevelSense').checked;
          
          document.getElementById('livePump2Proxy1Row').style.display = pump2Proxy1Enabled ? '' : 'none';
          document.getElementById('livePump2Proxy2Row').style.display = pump2Proxy2Enabled ? '' : 'none';
          document.getElementById('livePump2LevelRow').style.display = pump2LevelEnabled ? '' : 'none';
          
          // Initialize pump2 level indicator based on level type
          if (pump2LevelEnabled) {
            const pump2LevelType = document.getElementById('pump2LevelSenseOptions') ? document.getElementById('pump2LevelSenseOptions').value : '';
            const pump2LevelIndicator = document.getElementById('livePump2Level');
            if (pump2LevelIndicator) {
              if (pump2LevelType === 'HEF') {
                pump2LevelIndicator.classList.add('hall-effect');
                pump2LevelIndicator.classList.remove('lamp-off', 'lamp-on', 'level-medium', 'level-high');
                pump2LevelIndicator.classList.add('level-low'); // This should be red for 0%
                pump2LevelIndicator.textContent = '0%';
              } else {
                pump2LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high');
                pump2LevelIndicator.classList.add('lamp-off');
                pump2LevelIndicator.classList.remove('lamp-on');
                pump2LevelIndicator.textContent = '';
              }
            }
          }
        }
        
        // Load values from settings into display fields
        const pauseTime = document.getElementById('pauseTime');
        if (pauseTime && pauseTime.value) {
          document.getElementById('livePump1PauseValue').textContent = pauseTime.value;
        }
        
        const timeCyclesValue = document.getElementById('timeCyclesValue');
        if (timeCyclesValue && timeCyclesValue.value) {
          document.getElementById('livePump1CyclesValue').textContent = timeCyclesValue.value;
        }
        
        if (pump2Enabled) {
          const pump2PauseTime = document.getElementById('pump2PauseTime');
          if (pump2PauseTime && pump2PauseTime.value) {
            document.getElementById('livePump2PauseValue').textContent = pump2PauseTime.value;
          }
          
          const pump2TimeCyclesValue = document.getElementById('pump2TimeCyclesValue');
          if (pump2TimeCyclesValue && pump2TimeCyclesValue.value) {
            document.getElementById('livePump2CyclesValue').textContent = pump2TimeCyclesValue.value;
          }
        }
      }
      
      setupShowHideCheckbox('proxy1', 'dwellTime1Row');
      setupShowHideCheckbox('proxy2', 'dwellTime2Row');
      setupShowHideCheckbox('levelSense', 'levelSenseOptionsRow');
      setupShowHideCheckbox('extLamp', 'extLampOptionsRow');
      setupShowHideCheckbox('pump2Proxy1', 'pump2DwellTime1Row');
      setupShowHideCheckbox('pump2Proxy2', 'pump2DwellTime2Row');
      setupShowHideCheckbox('pump2LevelSense', 'pump2LevelSenseOptionsRow');
      
      document.getElementById('levelSenseOptions').addEventListener('change', function() {
        const noncRow = document.getElementById('levelNoncRow');
        if (this.value === 'LLO') {
          noncRow.style.display = '';
        } else {
          noncRow.style.display = 'none';
        }
      });

      document.getElementById('pump2LevelSenseOptions').addEventListener('change', function() {
        const noncRow = document.getElementById('pump2LevelNoncRow');
        if (this.value === 'LLO') {
          noncRow.style.display = '';
        } else {
          noncRow.style.display = 'none';
        }
      });

      // Test Mode logic
      const testModeBtn = document.getElementById('testModeBtn');
      const testModePanel = document.getElementById('testModePanel');
      const settingsForm = document.getElementById('settingsForm');
      const testModeBackBtn = document.getElementById('testModeBackBtn');
      const proxy1Row = document.getElementById('proxy1Row');
      const proxy2Row = document.getElementById('proxy2Row');

      function updateProxyRowsVisibility() {
        proxy1Row.style.display = document.getElementById('proxy1').checked ? '' : 'none';
        proxy2Row.style.display = document.getElementById('proxy2').checked ? '' : 'none';
        const pump1LevelRow = document.getElementById('pump1LevelRow');
        const pump2LevelRow = document.getElementById('pump2LevelRow');
        const pump1LevelEnabled = document.getElementById('levelSense').checked;
        const pump2LevelEnabled = document.getElementById('pump2LevelSense').checked;
        const extLampRow = document.getElementById('extLampRow');
        const extLampEnabled = document.getElementById('extLamp').checked;
        extLampRow.style.display = extLampEnabled ? '' : 'none';
        pump1LevelRow.style.display = pump1LevelEnabled ? '' : 'none';
        
        // Update pump2 section visibility
        const pump2TestSection = document.getElementById('pump2TestSection');
        const pump2InUse = document.getElementById('pump2').checked;
        pump2TestSection.style.display = pump2InUse ? '' : 'none';
        
        // Update pump2 proxy visibility logic
        const pump2Proxy1Row = document.getElementById('pump2Proxy1Row');
        const pump2Proxy2Row = document.getElementById('pump2Proxy2Row');
        const pump2Proxy1Enabled = document.getElementById('pump2Proxy1').checked;
        const pump2Proxy2Enabled = document.getElementById('pump2Proxy2').checked;
        
        pump2Proxy1Row.style.display = (pump2InUse && pump2Proxy1Enabled) ? '' : 'none';
        pump2Proxy2Row.style.display = (pump2InUse && pump2Proxy2Enabled) ? '' : 'none';
        pump2LevelRow.style.display = (pump2InUse && pump2LevelEnabled) ? '' : 'none';
      }

      testModeBtn.onclick = function() {
        settingsForm.style.display = 'none';
        testModePanel.style.display = '';
        updateProxyRowsVisibility();
        initializeTestModeButtons(); 
      };
      testModeBackBtn.onclick = function() {
        sendPumpOffMessages();
        testModePanel.style.display = 'none';
        settingsForm.style.display = '';
      };

      // UPDATE the initializeTestModeButtons function - Remove labels from indicators
      function initializeTestModeButtons() {
        // Initialize pump1 button - RED background, ON label (pump is stopped initially)
        const pump1TestBtn = document.getElementById('pump1TestBtn');
        if (pump1TestBtn) {
          pump1TestBtn.classList.remove('pump-on');   // Remove green
          pump1TestBtn.classList.add('pump-off');     // Add red
          pump1TestBtn.textContent = "RUN";
          pump1IsOn = false; // Pump is actually off when button shows ON
        }
        
        // Initialize pump2 button - RED background, ON label (pump is stopped initially)
        const pump2TestBtn = document.getElementById('pump2TestBtn');
        if (pump2TestBtn) {
          pump2TestBtn.classList.remove('pump-on');   // Remove green
          pump2TestBtn.classList.add('pump-off');     // Add red
          pump2TestBtn.textContent = "RUN";
          pump2IsOn = false; // Pump is actually off when button shows ON
        }
        
        // Initialize proxy indicators - gray background, NO LABEL
        const proxy1Indicator = document.getElementById('proxy1Indicator');
        const proxy2Indicator = document.getElementById('proxy2Indicator');
        const pump2Proxy1Indicator = document.getElementById('pump2Proxy1Indicator');
        const pump2Proxy2Indicator = document.getElementById('pump2Proxy2Indicator');
        
        if (proxy1Indicator) {
          proxy1Indicator.classList.add('lamp-off');
          proxy1Indicator.classList.remove('lamp-on');
          proxy1Indicator.textContent = ""; // Remove label
        }
        if (proxy2Indicator) {
          proxy2Indicator.classList.add('lamp-off');
          proxy2Indicator.classList.remove('lamp-on');
          proxy2Indicator.textContent = ""; // Remove label
        }
        if (pump2Proxy1Indicator) {
          pump2Proxy1Indicator.classList.add('lamp-off');
          pump2Proxy1Indicator.classList.remove('lamp-on');
          pump2Proxy1Indicator.textContent = ""; // Remove label
        }
        if (pump2Proxy2Indicator) {
          pump2Proxy2Indicator.classList.add('lamp-off');
          pump2Proxy2Indicator.classList.remove('lamp-on');
          pump2Proxy2Indicator.textContent = ""; // Remove label
        }
        
        // Level sense indicators initialization - Handle Hall Effect properly
        const pump1LevelIndicator = document.getElementById('pump1LevelIndicator');
        const pump2LevelIndicator = document.getElementById('pump2LevelIndicator');
        
        // Initialize pump1 level indicator based on level type
        const levelSenseChecked = document.getElementById('levelSense').checked;
        if (levelSenseChecked) {
          const levelType = document.getElementById('levelSenseOptions') ? document.getElementById('levelSenseOptions').value : '';
          if (pump1LevelIndicator) {
            if (levelType === 'HEF') {
              pump1LevelIndicator.classList.add('hall-effect');
              pump1LevelIndicator.classList.remove('lamp-off', 'lamp-on', 'level-medium', 'level-high');
              pump1LevelIndicator.classList.add('level-low'); // This should be red for 0%
              pump1LevelIndicator.textContent = '0%';
            } else {
              pump1LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high');
              pump1LevelIndicator.classList.add('lamp-off');
              pump1LevelIndicator.classList.remove('lamp-on');
              pump1LevelIndicator.textContent = '';
            }
          }
        } else {
          if (pump1LevelIndicator) {
            pump1LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high', 'lamp-on');
            pump1LevelIndicator.classList.add('lamp-off');
            pump1LevelIndicator.textContent = '';
          }
        }
        
        // Initialize pump2 level indicator if pump2 is enabled
        const pump2Checked = document.getElementById('pump2').checked;
        if (pump2Checked) {
          const pump2LevelSenseChecked = document.getElementById('pump2LevelSense').checked;
          if (pump2LevelSenseChecked) {
            const pump2LevelType = document.getElementById('pump2LevelSenseOptions') ? document.getElementById('pump2LevelSenseOptions').value : '';
            if (pump2LevelIndicator) {
              if (pump2LevelType === 'HEF') {
                pump2LevelIndicator.classList.add('hall-effect');
                pump2LevelIndicator.classList.remove('lamp-off', 'lamp-on', 'level-medium', 'level-high');
                pump2LevelIndicator.classList.add('level-low'); // This should be red for 0%
                pump2LevelIndicator.textContent = '0%';
              } else {
                pump2LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high');
                pump2LevelIndicator.classList.add('lamp-off');
                pump2LevelIndicator.classList.remove('lamp-on');
                pump2LevelIndicator.textContent = '';
              }
            }
          } else {
            if (pump2LevelIndicator) {
              pump2LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high', 'lamp-on');
              pump2LevelIndicator.classList.add('lamp-off');
              pump2LevelIndicator.textContent = '';
            }
          }
        } else {
          if (pump2LevelIndicator) {
            pump2LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high', 'lamp-on');
            pump2LevelIndicator.classList.add('lamp-off');
            pump2LevelIndicator.textContent = '';
          }
        }
        
        // External lamp indicator initialization - NO LABEL
        const extLampIndicator = document.getElementById('extLampIndicator');
        if (extLampIndicator) {
          extLampIndicator.classList.add('lamp-off');
          extLampIndicator.classList.remove('lamp-on');
          extLampIndicator.textContent = ""; // Remove label
        }
      }

      // UPDATE the sendPumpOffMessages function
      function sendPumpOffMessages() {
        if (client && client.connected && serial) {
          // Send OFF messages to both pumps
          client.publish(`a3/${serial}/test/pump1`, "off");
          client.publish(`a3/${serial}/test/pump2`, "off");
          console.log("Sent OFF messages to both pumps");
        }
      }

      // MQTT config
      const hivemqBrokerUrl = 'wss://bd58f8878eef4f5eb73ac65312b10130.s1.eu.hivemq.cloud:8884/mqtt';
      const hivemqUsername = 'a3Admin';
      const hivemqPassword = 'DontLetMeIn247';

      let client = null;
      let serial = null;
      let queryTimeout = null;

      function getSerialFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("serial");
      }

      function showStatus(msg, isError = false) {
        const status = document.getElementById("status-message");
        status.textContent = msg;
        status.className = "status-message" + (isError ? " error" : "");
      }

      function applySettingsFromPayload(payloads) {
        console.log("applySettingsFromPayload called with:", payloads);
        
        // ALWAYS clear any active timeout when settings are being applied
        if (queryTimeout) {
          console.log("Settings being applied, clearing any active timeout");
          clearTimeout(queryTimeout);
          queryTimeout = null;
        }

        window.isLoadingSettings = true;
        
        let pump2ShouldBeVisible = false;
        
        try {
          const settingsP1 = payloads.p1 ? JSON.parse(payloads.p1) : {};
          const settingsP2 = payloads.p2 ? JSON.parse(payloads.p2) : {};
          const settingsXtra = payloads.xtra ? JSON.parse(payloads.xtra) : {};

          console.log("Parsed P1 settings:", settingsP1);
          console.log("Parsed P2 settings:", settingsP2);
          console.log("Parsed Xtra settings:", settingsXtra);

          // Apply P1 settings
          if (settingsP1.modeP1) {
            document.getElementById('modeSelect').value = settingsP1.modeP1;
          }
          
          if (settingsP1.pauseTimeP1 !== undefined) {
            document.getElementById('pauseTime').value = secondsToHMS(settingsP1.pauseTimeP1);
          }
          
          if (settingsP1.runModeP1) {
            document.getElementById('timeCyclesSelect').value = settingsP1.runModeP1;
          }
          
          if (settingsP1.timeCyclesP1 !== undefined) {
            const timeCyclesValue = settingsP1.runModeP1 === 'TIME' ? 
              secondsToMS(settingsP1.timeCyclesP1) : 
              settingsP1.timeCyclesP1.toString();
            document.getElementById('timeCyclesValue').value = timeCyclesValue;
          }
          
//          if (settingsP1.runModeP1) {
//            updateTimeCyclesLabel();
//          }

          if (settingsP1.proxy1P1 !== undefined) {
            const proxy1Checkbox = document.getElementById('proxy1');
            const shouldBeChecked = settingsP1.proxy1P1 === "YES";
            proxy1Checkbox.checked = shouldBeChecked;
          }
          
          if (settingsP1.proxy2P1 !== undefined) {
            const proxy2Checkbox = document.getElementById('proxy2');
            const shouldBeChecked = settingsP1.proxy2P1 === "YES";
            proxy2Checkbox.checked = shouldBeChecked;
          }
          
          if (settingsP1.dwellTimeP1Px1 !== undefined) {
            document.getElementById('dwellTime1').value = secondsToHMS(settingsP1.dwellTimeP1Px1);
          }

          if (settingsP1.dwellTimeP1Px2 !== undefined) {
            document.getElementById('dwellTime2').value = secondsToHMS(settingsP1.dwellTimeP1Px2);
          }

          if (settingsP1.levelP1 !== undefined) {
            const levelSenseCheckbox = document.getElementById('levelSense');
            const shouldBeChecked = settingsP1.levelP1 === "YES";
            levelSenseCheckbox.checked = shouldBeChecked;
          }
          
          if (settingsP1.levelTypeP1) {
            document.getElementById('levelSenseOptions').value = settingsP1.levelTypeP1;
          }
          
          if (settingsP1.levelNoncP1) {
            document.getElementById('levelNonc').value = settingsP1.levelNoncP1;
          }

          // Apply P2 settings
          if (settingsP2.pump2InUse !== undefined) {
            const pump2Checkbox = document.getElementById('pump2');
            const shouldBeChecked = settingsP2.pump2InUse === "YES";
            pump2Checkbox.checked = shouldBeChecked;
            pump2ShouldBeVisible = shouldBeChecked; 
          }
          
          if (settingsP2.modeP2) {
            document.getElementById('pump2Mode').value = settingsP2.modeP2;
          }
          
          if (settingsP2.pauseTimeP2 !== undefined) {
            document.getElementById('pump2PauseTime').value = secondsToHMS(settingsP2.pauseTimeP2);
          }
          
          if (settingsP2.runModeP2) {
            document.getElementById('pump2TimeCyclesSelect').value = settingsP2.runModeP2;
          }
          
          if (settingsP2.timeCyclesP2 !== undefined) {
            const pump2TimeCyclesValue = settingsP2.runModeP2 === 'TIME' ? 
              secondsToMS(settingsP2.timeCyclesP2) : 
              settingsP2.timeCyclesP2.toString();
            document.getElementById('pump2TimeCyclesValue').value = pump2TimeCyclesValue;
          }
          
//          if (settingsP2.runModeP2) {
//            updatePump2TimeCyclesLabel();
//          } 

          if (settingsP2.proxy1P2 !== undefined) {
            const pump2Proxy1Checkbox = document.getElementById('pump2Proxy1');
            const shouldBeChecked = settingsP2.proxy1P2 === "YES";
            pump2Proxy1Checkbox.checked = shouldBeChecked;
          }
          
          if (settingsP2.proxy2P2 !== undefined) {
            const pump2Proxy2Checkbox = document.getElementById('pump2Proxy2');
            const shouldBeChecked = settingsP2.proxy2P2 === "YES";
            pump2Proxy2Checkbox.checked = shouldBeChecked;
          }
          
          if (settingsP2.dwellTimeP2Px1 !== undefined) {
            document.getElementById('pump2DwellTime1').value = secondsToHMS(settingsP2.dwellTimeP2Px1);
          }

          if (settingsP2.dwellTimeP2Px2 !== undefined) {
            document.getElementById('pump2DwellTime2').value = secondsToHMS(settingsP2.dwellTimeP2Px2);
          }

          if (settingsP2.levelP2 !== undefined) {
            const pump2LevelSenseCheckbox = document.getElementById('pump2LevelSense');
            const shouldBeChecked = settingsP2.levelP2 === "YES";
            pump2LevelSenseCheckbox.checked = shouldBeChecked;
          }
          
          if (settingsP2.levelTypeP2) {
            document.getElementById('pump2LevelSenseOptions').value = settingsP2.levelTypeP2;
          }
          
          if (settingsP2.levelNoncP2) {
            document.getElementById('pump2LevelNonc').value = settingsP2.levelNoncP2;
          }

          // Apply Xtra settings
          if (settingsXtra.extLampInUse !== undefined) {
            const extLampCheckbox = document.getElementById('extLamp');
            const shouldBeChecked = settingsXtra.extLampInUse === "YES";
            extLampCheckbox.checked = shouldBeChecked;
          }
          
          if (settingsXtra.extLampType) {
            document.getElementById('extLampOptions').value = settingsXtra.extLampType;
          }
          
          if (settingsXtra.blockCurrentP1 !== undefined) {
            document.getElementById('blockageCurrentValue').value = settingsXtra.blockCurrentP1.toString();
          }
          
          if (settingsXtra.blockCurrentP2 !== undefined) {
            document.getElementById('pump2BlockageCurrentValue').value = settingsXtra.blockCurrentP2.toString();
          }

          const pump2SettingsGroup = document.getElementById('pump2SettingsGroup');
          if (pump2SettingsGroup) {
            pump2SettingsGroup.style.display = pump2ShouldBeVisible ? '' : 'none';
          }

          setTimeout(() => {
            applyVisibilityOnlyForLoadedSettings();
            
            setTimeout(() => {
              window.isLoadingSettings = false;

              if (settingsP1.runModeP1) {
                updateTimeCyclesLabel();
              }
              
              if (settingsP2.runModeP2) {
                updatePump2TimeCyclesLabel();
              }

              // Handle both Settings and Live tabs
              if (window.isLoadingForLive) {
                window.isLoadingForLive = false;
                initializeLiveMode();
                showStatus("Live mode ready", false);
                console.log("Live mode initialized with loaded settings");
              } else {
                showStatus("Settings loaded from device.");
                console.log("Settings loading complete, TIME/CYCLES logic re-enabled");
              }
            }, 300);
            
          }, 50);

        } catch (e) {
          window.isLoadingSettings = false;
          window.isLoadingForLive = false;
          showStatus("Failed to parse settings from device.", true);
          console.error("applySettingsFromPayload error:", e);
        }
      }

      function connectMQTTAndQuery(forceSettingsQuery = false) {
        if (isAlreadyConnected && client && client.connected && deviceSerial && deviceVersion && !forceSettingsQuery) {
          document.getElementById("serial-number").textContent = deviceSerial;
          document.getElementById("ver-string").textContent = deviceVersion;
          //showStatus("");
          return;
        }
        
        serial = getSerialFromURL();
        if (!serial) {
          serial = localStorage.getItem('deviceSerial');
        }
        if (!serial) {
          showStatus("No serial number provided in URL.", true);
          return;
        }
        
        if (!forceSettingsQuery) {
          showStatus("Connecting to device...", false);
        } 

        if (isAlreadyConnected && client && client.connected && forceSettingsQuery) {
          showStatus("Querying device for settings...", false);
          
          // Reset and start sequential preloading
          settingsPreloaded = false;
          preloadSettings();
          console.log("Settings queries sent to device");
          return;
        }

        client = mqtt.connect(hivemqBrokerUrl, {
          clientId: 'webClient-' + Math.random().toString(16).substr(2, 8),
          username: hivemqUsername,
          password: hivemqPassword,
          clean: true,
          connectTimeout: 4000,
          reconnectPeriod: 2000,
        });

        client.on('connect', function() {
          isAlreadyConnected = true;
          showStatus("Connected. Querying device...");

          // CLEAR any existing timeout when we successfully connect
          if (queryTimeout) {
            console.log("Clearing timeout on MQTT connect");
            clearTimeout(queryTimeout);
            queryTimeout = null;
          }

          const responseTopic = `a3/${serial}/serialResponse`;
          const P1testResponseTopic = `a3/${serial}/test/pump1`;
          const P2testResponseTopic = `a3/${serial}/test/pump2`;
          const P1prox1TestTopic = `a3/${serial}/test/p1proxy1`;
          const P1prox2TestTopic = `a3/${serial}/test/p1proxy2`;
          const P2prox1TestTopic = `a3/${serial}/test/p2proxy1`;
          const P2prox2TestTopic = `a3/${serial}/test/p2proxy2`;
          const P1settingsReplyTopic = `a3/${serial}/P1settingsReply`;
          const P2settingsReplyTopic = `a3/${serial}/P2settingsReply`;
          const xtraSettingsReplyTopic = `a3/${serial}/xtraSettingsReply`;
          const P1liveStatusTopic = `a3/${serial}/live/pump1`;
          const P2liveStatusTopic = `a3/${serial}/live/pump2`;
          const P1levelTestTopic = `a3/${serial}/test/p1level`;
          const P2levelTestTopic = `a3/${serial}/test/p2level`;
          const extlampTestTopic = `a3/${serial}/test/extlamp`;

          // Subscribe to all topics first
          client.subscribe(responseTopic);
          client.subscribe(P1testResponseTopic);
          client.subscribe(P2testResponseTopic);
          client.subscribe(P1prox1TestTopic);
          client.subscribe(P1prox2TestTopic);
          client.subscribe(P2prox1TestTopic);
          client.subscribe(P2prox2TestTopic);
          client.subscribe(P1settingsReplyTopic);
          client.subscribe(P2settingsReplyTopic);
          client.subscribe(xtraSettingsReplyTopic);
          client.subscribe(P1liveStatusTopic);
          client.subscribe(P2liveStatusTopic);
          client.subscribe(P1levelTestTopic);
          client.subscribe(P2levelTestTopic);
          client.subscribe(extlampTestTopic);

          // Query serial first
          client.publish(`a3/${serial}/querySerial`, "mainQuery");

          // Set a NEW timeout specifically for the serial query
          queryTimeout = setTimeout(() => {
            console.log("Serial query timeout triggered");
            queryTimeout = null;
            showStatus("No response from device. Please check connection and try again.", true);
          }, 10000);
        });

        client.on('message', function(topic, message) {
          console.log("MQTT message received:", topic, message.toString());
          
          if (topic === `a3/${serial}/serialResponse`) {
            try {
              const payload = JSON.parse(message.toString());
              if (payload.serial) {
                deviceSerial = payload.serial;
                localStorage.setItem('deviceSerial', deviceSerial);
                document.getElementById("serial-number").textContent = payload.serial;
              }
              if (payload.version) {
                deviceVersion = payload.version;
                localStorage.setItem('deviceVersion', deviceVersion);
                document.getElementById("ver-string").textContent = payload.version;
              }

              // IMMEDIATELY clear the serial query timeout
              if (queryTimeout) {
                console.log("Serial response received, clearing serial query timeout");
                clearTimeout(queryTimeout);
                queryTimeout = null;
              }

              console.log("Got device info, now starting settings preload...");
              setTimeout(() => {
                preloadSettings();
              }, 100); // Small delay to ensure everything is ready

            } catch (e) {
              showStatus("Error parsing device response.", true);
            }
          }

          // P1 settings response handler
          if (topic === `a3/${serial}/P1settingsReply`) {
            latestSettingsPayload.p1 = message.toString();
            console.log("Received P1 settings");
            
            if (preloadingInProgress && preloadStep === 1) {
              // P1 received, now query P2
              preloadStep = 2;
              console.log("Querying P2 settings...");
              client.publish(`a3/${serial}/queryP2Settings`, serial);
            } else if (!preloadingInProgress) {
              // This is a tab-specific load, check if we have all settings
              if (latestSettingsPayload.p1 && latestSettingsPayload.p2 && latestSettingsPayload.xtra) {
                if (queryTimeout) {
                  clearTimeout(queryTimeout);
                  queryTimeout = null;
                }
                applySettingsFromPayload(latestSettingsPayload);
              }
            }
          }

          // P2 settings response handler - UPDATED for sequential loading
          if (topic === `a3/${serial}/P2settingsReply`) {
            latestSettingsPayload.p2 = message.toString();
            console.log("Received P2 settings");
            
            if (preloadingInProgress && preloadStep === 2) {
              // P2 received, now query Xtra
              preloadStep = 3;
              console.log("Querying Xtra settings...");
              client.publish(`a3/${serial}/queryXtraSettings`, serial);
            } else if (!preloadingInProgress) {
              // This is a tab-specific load, check if we have all settings
              if (latestSettingsPayload.p1 && latestSettingsPayload.p2 && latestSettingsPayload.xtra) {
                if (queryTimeout) {
                  clearTimeout(queryTimeout);
                  queryTimeout = null;
                }
                applySettingsFromPayload(latestSettingsPayload);
              }
            }
          }

          // Xtra settings response handler - UPDATED for sequential loading
          if (topic === `a3/${serial}/xtraSettingsReply`) {
            latestSettingsPayload.xtra = message.toString();
            console.log("Received Xtra settings");
            
            if (preloadingInProgress && preloadStep === 3) {
              // All settings received during preload
              preloadStep = 4;
              preloadingInProgress = false;
              settingsPreloaded = true;
              
              // IMMEDIATELY clear the preload timeout
              if (queryTimeout) {
                console.log("Settings preload complete, clearing preload timeout");
                clearTimeout(queryTimeout);
                queryTimeout = null;
              }

              console.log("Settings preload complete!");
              showStatus("Device connected and ready");
            } else if (!preloadingInProgress) {
              // This is a tab-specific load, check if we have all settings
              if (latestSettingsPayload.p1 && latestSettingsPayload.p2 && latestSettingsPayload.xtra) {
                if (queryTimeout) {
                  clearTimeout(queryTimeout);
                  queryTimeout = null;
                }
                applySettingsFromPayload(latestSettingsPayload);
              }
            }
          }

          // Pump1 test handler - CORRECT LOGIC
          if (topic === `a3/${serial}/test/pump1`) {
            const btn = document.getElementById('pump1TestBtn');
            const payload = message.toString();
            
            if (btn) {
              if (payload === "running") {
                // Pump is running: GREEN background, OFF label
                btn.classList.remove('pump-off');  // Remove red
                btn.classList.add('pump-on');      // Add green
                btn.textContent = "STOP";
                pump1IsOn = true;
              } else if (payload === "stopped") {
                // Pump is stopped: RED background, ON label
                btn.classList.remove('pump-on');   // Remove green
                btn.classList.add('pump-off');     // Add red
                btn.textContent = "RUN";
                pump1IsOn = false;
              }
            }
            
            // Handle auto calibration responses (unchanged)
            if (p1AutoCalibrating) {
              if (payload === "startingTest") {
                blockageCurrentValue.value = 'Pump running';
                console.log("P1 auto calibration: pump running");
              } else if (!isNaN(parseFloat(payload))) {
                blockageCurrentValue.value = payload;
                p1AutoCalibrating = false;
                console.log("P1 auto calibration complete: " + payload);
              }
            }
          }

          // Pump2 test handler - CORRECT LOGIC
          if (topic === `a3/${serial}/test/pump2`) {
            const btn = document.getElementById('pump2TestBtn');
            const payload = message.toString();
            
            if (btn) {
              if (payload === "running") {
                // Pump is running: GREEN background, OFF label
                btn.classList.remove('pump-off');  // Remove red
                btn.classList.add('pump-on');      // Add green
                btn.textContent = "STOP";
                pump2IsOn = true;
              } else if (payload === "stopped") {
                // Pump is stopped: RED background, ON label
                btn.classList.remove('pump-on');   // Remove green
                btn.classList.add('pump-off');     // Add red
                btn.textContent = "RUN";
                pump2IsOn = false;
              }
            }
            
            // Handle auto calibration responses for pump2 (unchanged)
            if (p2AutoCalibrating) {
              console.log("Processing pump2 auto calibration message:", payload);
              if (payload === "startingTest") {
                pump2BlockageCurrentValue.value = 'Pump running';
                console.log("P2 auto calibration: pump running");
              } else if (!isNaN(parseFloat(payload))) {
                pump2BlockageCurrentValue.value = payload;
                p2AutoCalibrating = false;
                console.log("P2 auto calibration complete: " + payload);
              }
            }
          }

          // Proxy1 handler - UPDATED TOPIC - NO LABELS
          if (topic === `a3/${serial}/test/p1proxy1`) {
            const testInd = document.getElementById('proxy1Indicator');
            const liveInd = document.getElementById('livePump1Proxy1');
            const payload = message.toString();
            console.log("Received p1proxy1 message:", payload);
            
            // Update both test and live indicators
            [testInd, liveInd].forEach(ind => {
              if (ind) {
                if (payload === "on") {
                  ind.classList.remove('lamp-off');
                  ind.classList.add('lamp-on');
                } else if (payload === "off") {
                  ind.classList.remove('lamp-on');
                  ind.classList.add('lamp-off');
                }
              }
            });
          }

          // Proxy2 handler - UPDATED TOPIC - NO LABELS
          if (topic === `a3/${serial}/test/p1proxy2`) {
            const testInd = document.getElementById('proxy2Indicator');
            const liveInd = document.getElementById('livePump1Proxy2');
            const payload = message.toString();
            console.log("Received p1proxy2 message:", payload);
            
            // Update both test and live indicators
            [testInd, liveInd].forEach(ind => {
              if (ind) {
                if (payload === "on") {
                  ind.classList.remove('lamp-off');
                  ind.classList.add('lamp-on');
                } else if (payload === "off") {
                  ind.classList.remove('lamp-on');
                  ind.classList.add('lamp-off');
                }
              }
            });
          }

          // Level sense handlers - UPDATED for Hall Effect support
          if (topic === `a3/${serial}/test/p1level`) {
            const testInd = document.getElementById('pump1LevelIndicator');
            const liveInd = document.getElementById('livePump1Level');
            const payload = message.toString();
            console.log("DEBUG: Received p1level message:", payload);
            console.log("DEBUG: Test indicator element:", testInd ? testInd.id : 'not found');
            console.log("DEBUG: Live indicator element:", liveInd ? liveInd.id : 'not found');
            
            // Update BOTH test mode and live mode indicators the same way
            updateHallEffectIndicator(testInd, payload, true, 1);
            updateHallEffectIndicator(liveInd, payload, true, 1);
          }

          if (topic === `a3/${serial}/test/p2level`) {
            const testInd = document.getElementById('pump2LevelIndicator');
            const liveInd = document.getElementById('livePump2Level');
            const payload = message.toString();
            console.log("DEBUG: Received p2level message:", payload);
            console.log("DEBUG: Test indicator element:", testInd ? testInd.id : 'not found');
            console.log("DEBUG: Live indicator element:", liveInd ? liveInd.id : 'not found');
           
            // Update BOTH test mode and live mode indicators the same way
            updateHallEffectIndicator(testInd, payload, true, 2);
            updateHallEffectIndicator(liveInd, payload, true, 2);
          }

          // ADD Pump2 Proxy1 handler - NO LABELS
          if (topic === `a3/${serial}/test/p2proxy1`) {
            const testInd = document.getElementById('pump2Proxy1Indicator');
            const liveInd = document.getElementById('livePump2Proxy1');
            const payload = message.toString();
            console.log("Received p2proxy1 message:", payload);
            
            // Update both test and live indicators
            [testInd, liveInd].forEach(ind => {
              if (ind) {
                if (payload === "on") {
                  ind.classList.remove('lamp-off');
                  ind.classList.add('lamp-on');
                } else if (payload === "off") {
                  ind.classList.remove('lamp-on');
                  ind.classList.add('lamp-off');
                }
              }
            });
          }

          // ADD Pump2 Proxy2 handler - NO LABELS
          if (topic === `a3/${serial}/test/p2proxy2`) {
            const testInd = document.getElementById('pump2Proxy2Indicator');
            const liveInd = document.getElementById('livePump2Proxy2');
            const payload = message.toString();
            console.log("Received p2proxy2 message:", payload);
            
            // Update both test and live indicators
            [testInd, liveInd].forEach(ind => {
              if (ind) {
                if (payload === "on") {
                  ind.classList.remove('lamp-off');
                  ind.classList.add('lamp-on');
                } else if (payload === "off") {
                  ind.classList.remove('lamp-on');
                  ind.classList.add('lamp-off');
                }
              }
            });
          }
          
          if (topic === `a3/${serial}/test/extlamp`) {
            const ind = document.getElementById('extLampIndicator');
            const liveInd = document.getElementById('livePump1ExtLamp');
            const payload = message.toString();
            console.log("Received extlamp message:", payload);
            
            // Update test mode indicator - FIXED
            if (ind) {
              if (payload === "on") {
                ind.classList.remove('lamp-off');
                ind.classList.add('lamp-on');
              } else if (payload === "off") {
                ind.classList.remove('lamp-on');
                ind.classList.add('lamp-off');
              }
            }
            
            // Update live mode indicator
            if (liveInd) {
              if (payload === "on") {
                liveInd.classList.remove('lamp-off');
                liveInd.classList.add('lamp-on');
              } else if (payload === "off") {
                liveInd.classList.remove('lamp-on');
                liveInd.classList.add('lamp-off');
              }
            }
          }
          if (topic === `a3/${serial}/live/pump1`) {
            const payload = message.toString();
            const pump1LiveBtn = document.getElementById('pump1LiveBtn');
            
            if (pump1LiveBtn) {
              if (payload === "running") {
                pump1LiveBtn.classList.remove('pump-btn-stopped');
                pump1LiveBtn.classList.add('pump-btn-running');
                pump1LiveBtn.textContent = "STOP";
                pump1LiveRunning = true;
              } else if (payload === "stopped") {
                pump1LiveBtn.classList.remove('pump-btn-running');
                pump1LiveBtn.classList.add('pump-btn-stopped');
                pump1LiveBtn.textContent = "RUN";
                pump1LiveRunning = false;
              }
            }
          }
          
          if (topic === `a3/${serial}/live/pump2`) {
            const payload = message.toString();
            const pump2LiveBtn = document.getElementById('pump2LiveBtn');
            
            if (pump2LiveBtn) {
              if (payload === "running") {
                pump2LiveBtn.classList.remove('pump-btn-stopped');
                pump2LiveBtn.classList.add('pump-btn-running');
                pump2LiveBtn.textContent = "STOP";
                pump2LiveRunning = true;
              } else if (payload === "stopped") {
                pump2LiveBtn.classList.remove('pump-btn-running');
                pump2LiveBtn.classList.add('pump-btn-stopped');
                pump2LiveBtn.textContent = "RUN";
                pump2LiveRunning = false;
              }
            }
          }

          // External lamp handler - ADD this inside the existing message handler
          if (topic === `a3/${serial}/test/extlamp`) {
            const testInd = document.getElementById('extLampIndicator');
            const liveInd = document.getElementById('livePump1ExtLamp');
            const payload = message.toString();
            console.log("Received extlamp message:", payload);
            
            // Update both test and live mode external lamp indicators
            [testInd, liveInd].forEach(ind => {
              if (ind) {
                if (payload === "on") {
                  ind.classList.remove('lamp-off');
                  ind.classList.add('lamp-on');
                } else if (payload === "off") {
                  ind.classList.remove('lamp-on');
                  ind.classList.add('lamp-off');
                }
              }
            });
          }
        });

        client.on('error', function(error) {
          console.log("MQTT error:", error);
          if (queryTimeout) {
            console.log("MQTT error occurred, clearing timeout");
            clearTimeout(queryTimeout);
            queryTimeout = null;
          }
          showStatus("MQTT connection error.", true);
        });
    


        client.on('close', function() {
          console.log("MQTT connection closed");
          if (queryTimeout) {
            console.log("MQTT connection closed, clearing timeout");
            clearTimeout(queryTimeout);
            queryTimeout = null;
          }
        });
      }

      document.getElementById("backBtn").onclick = function() {
        window.location.href = "index.html";
      };
      
      connectMQTTAndQuery();
      
function saveSettings() {
  // Now proceed with the actual save functionality
  const validationErrors = validateAllFields();
  
  if (validationErrors.length > 0) {
    const errorMessage = "Please fill in the following required fields:\n\n" + validationErrors.join("\n");
    alert(errorMessage);
    return;
  }
  
  // All fields are valid, compile and send MQTT messages
  try {
    const p1Settings = compileP1Settings();
    const p2Settings = compileP2Settings();
    const xtraSettings = compileXtraSettings();
    
    if (client && client.connected && serial) {
      // FIXED: Send to the new save topic names
      client.publish(`a3/${serial}/P1settingsSave`, p1Settings, {qos: 1, retain: false});
      client.publish(`a3/${serial}/P2settingsSave`, p2Settings, {qos: 1, retain: false});
      client.publish(`a3/${serial}/xtraSettingsSave`, xtraSettings, {qos: 1, retain: false});
      
      console.log("Sent P1 settings:", p1Settings);
      console.log("Sent P2 settings:", p2Settings);
      console.log("Sent Xtra settings:", xtraSettings);
      
      // Reset preloaded flag so settings get refreshed
      settingsPreloaded = false;
      
      // NEW: Wait a bit then refresh preloaded settings
      setTimeout(() => {
        console.log("Refreshing preloaded settings after save...");
        preloadSettings();
        
        setTimeout(() => {
          tabMainBtn.click();
          showStatus("Settings saved successfully!", false);
        }, 1000);
      }, 500);
       
      const testModePanel = document.getElementById('testModePanel');
      if (testModePanel && testModePanel.style.display !== 'none') {
        sendPumpOffMessages();
        testModePanel.style.display = 'none';
        document.getElementById('settingsForm').style.display = '';
      }
      
    } else {
      alert("Error: Not connected to device. Cannot save settings.");
    }
    
  } catch (error) {
    console.error("Error compiling settings:", error);
    alert("Error saving settings: " + error.message);
  }
}

// Validate all visible fields
function validateAllFields() {
  const errors = [];
  
  // Check main mode fields - FIX ELEMENT IDS
  if (!document.getElementById('modeSelect').value) {
    errors.push("• Main Mode (Pump1)");
  }
  
  if (!document.getElementById('pauseTime').value) {
    errors.push("• Pause Time (Pump1)");
  }
  
  if (!document.getElementById('timeCyclesSelect').value) {
    errors.push("• Time/Cycles Mode (Pump1)");
  }
  
  if (!document.getElementById('timeCyclesValue').value) {
    errors.push("• Time/Cycles Value (Pump1)");
  }
  
  // Check proxy fields if they are enabled and visible
  if (document.getElementById('proxy1').checked) {
    if (!document.getElementById('dwellTime1').value) {
      errors.push("• Dwell Time 1 (Pump1)");
    }
  }
  
  if (document.getElementById('proxy2').checked) {
    if (!document.getElementById('dwellTime2').value) {
      errors.push("• Dwell Time 2 (Pump1)");
    }
  }
  
  // Check level sense fields if enabled
  if (document.getElementById('levelSense').checked) {
    if (!document.getElementById('levelSenseOptions').value) {
      errors.push("• Level Sense Type (Pump1)");
    }
    
    // Check level nonc if LLO is selected
    if (document.getElementById('levelSenseOptions').value === 'LLO') {
      if (!document.getElementById('levelNonc').value) {
        errors.push("• Level N/O or N/C (Pump1)");
      }
    }
  }
  
  // Check blockage current field
  if (!document.getElementById('blockageCurrentValue').value) {
    errors.push("• Blockage Current (Pump1)");
  }
  
  // Check Pump2 fields if Pump2 is enabled
  if (document.getElementById('pump2').checked) {
    if (!document.getElementById('pump2Mode').value) { // FIX ELEMENT ID
      errors.push("• Main Mode (Pump2)");
    }
    
    if (!document.getElementById('pump2PauseTime').value) {
      errors.push("• Pause Time (Pump2)");
    }
    
    if (!document.getElementById('pump2TimeCyclesSelect').value) {
      errors.push("• Time/Cycles Mode (Pump2)");
    }
    
    if (!document.getElementById('pump2TimeCyclesValue').value) {
      errors.push("• Time/Cycles Value (Pump2)");
    }
    
    // Check pump2 proxy fields if enabled
    if (document.getElementById('pump2Proxy1').checked) {
      if (!document.getElementById('pump2DwellTime1').value) {
        errors.push("• Dwell Time 1 (Pump2)");
      }
    }
    
    if (document.getElementById('pump2Proxy2').checked) {
      if (!document.getElementById('pump2DwellTime2').value) {
        errors.push("• Dwell Time 2 (Pump2)");
      }
    }
    
    // Check pump2 level sense fields if enabled
    if (document.getElementById('pump2LevelSense').checked) {
      if (!document.getElementById('pump2LevelSenseOptions').value) {
        errors.push("• Level Sense Type (Pump2)");
      }
      
      if (document.getElementById('pump2LevelSenseOptions').value === 'LLO') {
        if (!document.getElementById('pump2LevelNonc').value) {
          errors.push("• Level N/O or N/C (Pump2)");
        }
      }
    }
    
    // Check pump2 blockage current
    if (!document.getElementById('pump2BlockageCurrentValue').value) {
      errors.push("• Blockage Current (Pump2)");
    }
  }
  
  // Check external lamp fields if enabled
  if (document.getElementById('extLamp').checked) {
    if (!document.getElementById('extLampOptions').value) {
      errors.push("• Lamp Type");
    }
  }
  
  return errors;
}

// Compile P1 settings in the same format as received from ESP32
function compileP1Settings() {
  const p1Settings = {
    modeP1: document.getElementById('modeSelect').value, 
    pauseTimeP1: hmsToSeconds(document.getElementById('pauseTime').value) || 0,
    runModeP1: document.getElementById('timeCyclesSelect').value,
    proxy1P1: document.getElementById('proxy1').checked ? "YES" : "NO",
    proxy2P1: document.getElementById('proxy2').checked ? "YES" : "NO",
    levelP1: document.getElementById('levelSense').checked ? "YES" : "NO"
  };
  
  // Handle time/cycles value conversion
  const timeCyclesValue = document.getElementById('timeCyclesValue').value;
  if (document.getElementById('timeCyclesSelect').value === 'TIME') {
    p1Settings.timeCyclesP1 = msToSeconds(timeCyclesValue);
  } else {
    p1Settings.timeCyclesP1 = parseInt(timeCyclesValue) || 0;
  }
  
  // Add proxy dwell times if proxies are enabled
  if (document.getElementById('proxy1').checked) {
    p1Settings.dwellTimeP1Px1 = hmsToSeconds(document.getElementById('dwellTime1').value) || 0;
  }
  
  if (document.getElementById('proxy2').checked) {
    p1Settings.dwellTimeP1Px2 = hmsToSeconds(document.getElementById('dwellTime2').value) || 0;
  }
  
  // Add level sense settings if enabled
  if (document.getElementById('levelSense').checked) {
    p1Settings.levelTypeP1 = document.getElementById('levelSenseOptions').value;
    
    if (document.getElementById('levelSenseOptions').value === 'LLO') {
      p1Settings.levelNoncP1 = document.getElementById('levelNonc').value;
    }
  }
  
  return JSON.stringify(p1Settings);
}

// Compile P2 settings in the same format as received from ESP32
function compileP2Settings() {
  const pump2InUse = document.getElementById('pump2').checked;
  
  const p2Settings = {
    pump2InUse: pump2InUse ? "YES" : "NO",
    modeP2: document.getElementById('pump2Mode').value,
    pauseTimeP2: hmsToSeconds(document.getElementById('pump2PauseTime').value) || 0,
    runModeP2: document.getElementById('pump2TimeCyclesSelect').value,
    proxy1P2: document.getElementById('pump2Proxy1').checked ? "YES" : "NO",
    proxy2P2: document.getElementById('pump2Proxy2').checked ? "YES" : "NO",
    levelP2: document.getElementById('pump2LevelSense').checked ? "YES" : "NO"
  };
  
  // Handle time/cycles value conversion
  const pump2TimeCyclesValue = document.getElementById('pump2TimeCyclesValue').value;
  if (document.getElementById('pump2TimeCyclesSelect').value === 'TIME') {
    p2Settings.timeCyclesP2 = msToSeconds(pump2TimeCyclesValue);
  } else {
    p2Settings.timeCyclesP2 = parseInt(pump2TimeCyclesValue) || 0;
  }
  
  // Add proxy dwell times if proxies are enabled
  if (document.getElementById('pump2Proxy1').checked) {
    p2Settings.dwellTimeP2Px1 = hmsToSeconds(document.getElementById('pump2DwellTime1').value) || 0;
  }
  
  if (document.getElementById('pump2Proxy2').checked) {
    p2Settings.dwellTimeP2Px2 = hmsToSeconds(document.getElementById('pump2DwellTime2').value) || 0;
  }
  
  // Add level sense settings if enabled
  if (document.getElementById('pump2LevelSense').checked) {
    p2Settings.levelTypeP2 = document.getElementById('pump2LevelSenseOptions').value;
    
    if (document.getElementById('pump2LevelSenseOptions').value === 'LLO') {
      p2Settings.levelNoncP2 = document.getElementById('pump2LevelNonc').value;
    }
  }
  
  return JSON.stringify(p2Settings);
}

// Compile extra settings in the same format as received from ESP32
function compileXtraSettings() {
  const xtraSettings = {
    extLampInUse: document.getElementById('extLamp').checked ? "YES" : "NO"  // FIXED: Changed field name
  };
  
  // Add lamp type if external lamp is enabled
  if (document.getElementById('extLamp').checked) {
    xtraSettings.extLampType = document.getElementById('extLampOptions').value;  // FIXED: Changed field name
  }
  
  // Add blockage current values
  if (document.getElementById('blockageCurrentValue').value) {
    const value = document.getElementById('blockageCurrentValue').value;
    // Only parse as float if it's a valid number, otherwise skip
    if (!isNaN(parseFloat(value))) {
      xtraSettings.blockCurrentP1 = parseFloat(value);
    }
  }
  
  // Add pump2 blockage current if pump2 is enabled
  if (document.getElementById('pump2').checked && document.getElementById('pump2BlockageCurrentValue').value) {
    const value = document.getElementById('pump2BlockageCurrentValue').value;
    // Only parse as float if it's a valid number, otherwise skip
    if (!isNaN(parseFloat(value))) {
      xtraSettings.blockCurrentP2 = parseFloat(value);
    }
  }
  
  return JSON.stringify(xtraSettings);
}

// Update the Save Settings button click handler
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
if (saveSettingsBtn) {
  saveSettingsBtn.onclick = saveSettings;
}

// Also update the test mode save button
const testModeSaveBtn = document.getElementById('testModeSaveBtn');
if (testModeSaveBtn) {
  testModeSaveBtn.onclick = saveSettings;
}

// Proxy dependency logic
document.getElementById('timeCyclesSelect').addEventListener('change', function() {
  updateTimeCyclesLabel();
  
  // Don't apply auto-logic during settings loading
  if (window.isLoadingSettings) return;
  
  // CYCLE mode: auto-select proxy1, show proxy2 (but don't select it)
  if (this.value === 'CYCLE') {
    document.getElementById('proxy1').checked = true;
    document.getElementById('dwellTime1Row').style.display = '';
    // Show proxy2 row since proxy1 is now enabled, but don't check it
    document.querySelector('[for="proxy2"]').parentElement.style.display = '';
  } 
  // TIME mode: clear proxy1, hide and clear proxy2
  else if (this.value === 'TIME') {
    document.getElementById('proxy1').checked = false;
    document.getElementById('dwellTime1Row').style.display = 'none';
    document.getElementById('proxy2').checked = false;
    document.getElementById('dwellTime2Row').style.display = 'none';
    document.querySelector('[for="proxy2"]').parentElement.style.display = 'none';
  }
});

document.getElementById('proxy1').addEventListener('change', function() {
  document.getElementById('dwellTime1Row').style.display = this.checked ? '' : 'none';
  
  // Don't apply auto-logic during settings loading
  if (window.isLoadingSettings) return;
  
  // If proxy1 unchecked, hide and uncheck proxy2
  if (!this.checked) {
    document.querySelector('[for="proxy2"]').parentElement.style.display = 'none';
    document.getElementById('proxy2').checked = false;
    document.getElementById('dwellTime2Row').style.display = 'none';
  } else {
    // If proxy1 checked, show proxy2 (but don't auto-select it)
    const proxy2Row = document.querySelector('[for="proxy2"]').parentElement;
    if (proxy2Row) {
      proxy2Row.style.display = '';
    }
  }
});

document.getElementById('pump2Proxy1').addEventListener('change', function() {
  document.getElementById('pump2DwellTime1Row').style.display = this.checked ? '' : 'none';
  
  // Don't apply auto-logic during settings loading
  if (window.isLoadingSettings) return;
  
  // If proxy1 unchecked, hide and uncheck proxy2
  if (!this.checked) {
    document.querySelector('[for="pump2Proxy2"]').parentElement.style.display = 'none';
    document.getElementById('pump2Proxy2').checked = false;
    document.getElementById('pump2DwellTime2Row').style.display = 'none';
  } else {
    // If proxy1 checked, show proxy2 (but don't auto-select it)
    const pump2Proxy2Row = document.querySelector('[for="pump2Proxy2"]').parentElement;
    if (pump2Proxy2Row) {
      pump2Proxy2Row.style.display = '';
    }
  }
});

document.getElementById('pump2TimeCyclesSelect').addEventListener('change', function() {
  updatePump2TimeCyclesLabel();
  
  // Don't apply auto-logic during settings loading
  if (window.isLoadingSettings) return;
  
  // CYCLE mode: auto-select proxy1, show proxy2 (but don't select it)
  if (this.value === 'CYCLE') {
    document.getElementById('pump2Proxy1').checked = true;
    document.getElementById('pump2DwellTime1Row').style.display = '';
    // Show proxy2 row since proxy1 is now enabled, but don't check it
    document.querySelector('[for="pump2Proxy2"]').parentElement.style.display = '';
  } 
  // TIME mode: clear proxy1, hide and clear proxy2
  else if (this.value === 'TIME') {
    document.getElementById('pump2Proxy1').checked = false;
    document.getElementById('pump2DwellTime1Row').style.display = 'none';
    document.getElementById('pump2Proxy2').checked = false;
    document.getElementById('pump2DwellTime2Row').style.display = 'none';
    document.querySelector('[for="pump2Proxy2"]').parentElement.style.display = 'none';
  }
});

function setupPump2VisibilityAfterLoad() {
  const checkbox = document.getElementById('pump2');
  const target = document.getElementById('pump2SettingsGroup');
  if (!checkbox || !target) return;
  
  function updateVisibility() {
    // Don't change visibility during settings loading
    if (window.isLoadingSettings) return;
    
    target.style.display = checkbox.checked ? '' : 'none';
  }
  
  // Set initial state based on current checkbox value
  target.style.display = checkbox.checked ? '' : 'none';
  
  // Remove any existing event listener to avoid duplicates
  checkbox.removeEventListener('change', updateVisibility);
  
  // Add the new event listener
  checkbox.addEventListener('change', updateVisibility);
}

document.getElementById('wifiFormMain').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const ssid = document.getElementById('ssid-main').value;
  const password = document.getElementById('password-main').value;
  
  if (client && client.connected && serial) {
    const wifiSettings = {
      ssid: ssid,
      password: password
    };
    
    client.publish(`a3/${serial}/wifiSettings`, JSON.stringify(wifiSettings));
    showStatus("WiFi settings saved!", false);
    
    // Clear the form
    document.getElementById('ssid-main').value = '';
    document.getElementById('password-main').value = '';
  } else {
    showStatus("Error: Not connected to device.", true);
  }
});

function applyVisibilityOnlyForLoadedSettings() {
  // Apply P1 visibility based on loaded settings
  const proxy1Checked = document.getElementById('proxy1').checked;
  const proxy2Checked = document.getElementById('proxy2').checked;
  const timeCyclesMode = document.getElementById('timeCyclesSelect').value;
  
  // Show/hide dwell time rows based on proxy states
  document.getElementById('dwellTime1Row').style.display = proxy1Checked ? '' : 'none';
  document.getElementById('dwellTime2Row').style.display = proxy2Checked ? '' : 'none';
  
  // Show/hide proxy2 based on TIME mode rules and proxy1 state
  const proxy2Row = document.querySelector('[for="proxy2"]').parentElement;
  if (proxy2Row) {
    if (timeCyclesMode === 'TIME' && !proxy1Checked) {
      proxy2Row.style.display = 'none';
    } else {
      proxy2Row.style.display = proxy1Checked ? '' : 'none';
    }
  }
  
  // Handle level sense visibility and nested options
  const levelSenseChecked = document.getElementById('levelSense').checked;
  document.getElementById('levelSenseOptionsRow').style.display = levelSenseChecked ? '' : 'none';
  
  // Handle level sense type dropdown (LLO option)
  if (levelSenseChecked) {
    const levelSenseType = document.getElementById('levelSenseOptions').value;
    document.getElementById('levelNoncRow').style.display = (levelSenseType === 'LLO') ? '' : 'none';
  } else {
    document.getElementById('levelNoncRow').style.display = 'none';
  }
  
  // Initialize pump1 level indicator based on level type
  if (levelSenseChecked) {
    const levelType = document.getElementById('levelSenseOptions') ? document.getElementById('levelSenseOptions').value : '';
    const pump1LevelIndicator = document.getElementById('pump1LevelIndicator');
    console.log("Initializing pump1 test level indicator with type:", levelType);
    if (pump1LevelIndicator) {
      if (levelType === 'HEF') {
        pump1LevelIndicator.classList.add('hall-effect');
        pump1LevelIndicator.classList.remove('lamp-off', 'lamp-on', 'level-medium', 'level-high');
        pump1LevelIndicator.classList.add('level-low'); // This should be red for 0%
        pump1LevelIndicator.textContent = '0%';
      } else {
        pump1LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high');
        pump1LevelIndicator.classList.add('lamp-off');
        pump1LevelIndicator.classList.remove('lamp-on');
        pump1LevelIndicator.textContent = '';
      }
    }
  } else {
    // Level sense disabled - ensure test indicator is off and has no hall effect styling
    const pump1LevelIndicator = document.getElementById('pump1LevelIndicator');
    if (pump1LevelIndicator) {
      pump1LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high', 'lamp-on');
      pump1LevelIndicator.classList.add('lamp-off');
      pump1LevelIndicator.textContent = '';
    }
  }
  
  // Handle external lamp visibility and nested options
  const extLampChecked = document.getElementById('extLamp').checked;
  document.getElementById('extLampOptionsRow').style.display = extLampChecked ? '' : 'none';
  
  // Handle pump2 settings group visibility - set it correctly based on loaded settings
  const pump2Checked = document.getElementById('pump2').checked;
  const pump2SettingsGroup = document.getElementById('pump2SettingsGroup');
  setupPump2VisibilityAfterLoad();
  
  // Apply P2 visibility if pump2 is enabled
  if (pump2Checked) {
    const pump2Proxy1Checked = document.getElementById('pump2Proxy1').checked;
    const pump2Proxy2Checked = document.getElementById('pump2Proxy2').checked;
    const pump2TimeCyclesMode = document.getElementById('pump2TimeCyclesSelect').value;
    
    // Show/hide pump2 dwell time rows
    document.getElementById('pump2DwellTime1Row').style.display = pump2Proxy1Checked ? '' : 'none';
    document.getElementById('pump2DwellTime2Row').style.display = pump2Proxy2Checked ? '' : 'none';
    
    // Show/hide pump2 proxy2 based on TIME mode rules and proxy1 state
    const pump2Proxy2Row = document.querySelector('[for="pump2Proxy2"]').parentElement;
    if (pump2Proxy2Row) {
      if (pump2TimeCyclesMode === 'TIME' && !pump2Proxy1Checked) {
        pump2Proxy2Row.style.display = 'none';
      } else {
        pump2Proxy2Row.style.display = pump2Proxy1Checked ? '' : 'none';
      }
    }
    
    // Handle pump2 level sense visibility and nested options
    const pump2LevelSenseChecked = document.getElementById('pump2LevelSense').checked;
    document.getElementById('pump2LevelSenseOptionsRow').style.display = pump2LevelSenseChecked ? '' : 'none';
    
    // Handle pump2 level sense type dropdown (LLO option)
    if (pump2LevelSenseChecked) {
      const pump2LevelSenseType = document.getElementById('pump2LevelSenseOptions').value;
      document.getElementById('pump2LevelNoncRow').style.display = (pump2LevelSenseType === 'LLO') ? '' : 'none';
    } else {
      document.getElementById('pump2LevelNoncRow').style.display = 'none';
    }
    // Initialize pump2 level indicator based on level type
    if (pump2LevelSenseChecked) {
      const pump2LevelType = document.getElementById('pump2LevelSenseOptions') ? document.getElementById('pump2LevelSenseOptions').value : '';
      const pump2LevelIndicator = document.getElementById('pump2LevelIndicator');
      console.log("Initializing pump2 test level indicator with type:", pump2LevelType);
      if (pump2LevelIndicator) {
        if (pump2LevelType === 'HEF') {
          pump2LevelIndicator.classList.add('hall-effect');
          pump2LevelIndicator.classList.remove('lamp-off', 'lamp-on', 'level-medium', 'level-high');
          pump2LevelIndicator.classList.add('level-low'); // This should be red for 0%
          pump2LevelIndicator.textContent = '0%';
        } else {
          pump2LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high');
          pump2LevelIndicator.classList.add('lamp-off');
          pump2LevelIndicator.classList.remove('lamp-on');
          pump2LevelIndicator.textContent = '';
        }
      }
    } else {
      // Level sense disabled - ensure test indicator is off and has no hall effect styling
      const pump2LevelIndicator = document.getElementById('pump2LevelIndicator');
      if (pump2LevelIndicator) {
        pump2LevelIndicator.classList.remove('hall-effect', 'level-low', 'level-medium', 'level-high', 'lamp-on');
        pump2LevelIndicator.classList.add('lamp-off');
        pump2LevelIndicator.textContent = '';
      }
    }
  }
  
  console.log("Visibility applied based on loaded settings");
}

function querySettingsForTab(tabName) {
  console.log(`Loading ${tabName} tab`);
  
  // Check if settings are already preloaded
  if (settingsPreloaded && latestSettingsPayload.p1 && latestSettingsPayload.p2 && latestSettingsPayload.xtra) {
    console.log(`Using preloaded settings for ${tabName} tab`);
    
    // Clear any existing timeout before using preloaded settings
    if (queryTimeout) {
      console.log("Using preloaded settings, clearing any existing timeout");
      clearTimeout(queryTimeout);
      queryTimeout = null;
    }
 
    // Set flag to indicate which tab we're loading for
    if (tabName === 'Live') {
      window.isLoadingForLive = true;
    } else {
      window.isLoadingForLive = false;
    }
    
    // Apply the preloaded settings immediately
    applySettingsFromPayload(latestSettingsPayload);
    return;
  }
  
  // Fallback: query settings if not preloaded
  console.log(`Settings not preloaded, querying device for ${tabName} tab`);
  
  // Show loading status
  showStatus(`Loading ${tabName} tab...`, false);
  
  // Set flag to indicate which tab we're loading for
  if (tabName === 'Live') {
    window.isLoadingForLive = true;
  } else {
    window.isLoadingForLive = false;
  }
  
  // Clear any existing timeout
  if (queryTimeout) {
    clearTimeout(queryTimeout);
  }
  
  // Reset the payload collector
  latestSettingsPayload = { p1: null, p2: null, xtra: null };
  
  // Set timeout for tab loading
  queryTimeout = setTimeout(() => {
    console.log(`${tabName} tab timeout triggered`);
    queryTimeout = null;
    if (window.isLoadingForLive) {
      window.isLoadingForLive = false;
      initializeLiveMode();
      showStatus("Live mode loaded (settings may be incomplete)", false);
    } else {
      showStatus("Device not communicating. Please check connection and try again.", true);
    }
  }, 10000);
  
  // Connect and query for settings (reuse existing function)
  connectMQTTAndQuery(true);
}

  const storedSerial = localStorage.getItem('deviceSerial');
  const storedVersion = localStorage.getItem('deviceVersion');

  if (storedSerial) {
    deviceSerial = storedSerial;
    document.getElementById("serial-number").textContent = deviceSerial;
  }
  if (storedVersion) {
    deviceVersion = storedVersion;
    document.getElementById("ver-string").textContent = deviceVersion;
  }

  // Always connect on page load to get device info and preload settings
  connectMQTTAndQuery();
    </script>
  </body>
</html>