<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A3 Setup</title>
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/style.css?v=' + new Date().getTime();
      document.head.appendChild(link);
    </script>
    <style>
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
    </style>
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
  </head>
  <body>
    <div class="header-box">
      <h1>A3 Setup</h1>
    </div>
    <div class="content main-content">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" id="tabMainBtn" type="button">Main</button>
        <button class="tab-btn" id="tabLiveBtn" type="button">Live</button>
        <button class="tab-btn" id="tabSettingsBtn" type="button">Settings</button>
        <button class="tab-btn" id="tabWiFiBtn" type="button">WiFi</button>
      </div>
      <!-- Tab Contents -->
      <div class="tab-content active" id="tabMain">
        <div class="info-row">
          <div>
            Serial: <span id="serial-number" class="info-value">...</span>
          </div>
          <div>
            Version: <span id="ver-string" class="info-value">...</span>
          </div>
        </div>
        <div id="status-message" class="status-message"></div>
        <div class="btn-row">
          <button class="btn" id="backBtn">CHANGE</button>
        </div>
      </div>
      <div class="tab-content" id="tabLive">
        <div style="margin: 40px 0 20px 0; text-align: center;">
          <strong>Live tab content goes here.</strong>
        </div>
      </div>
      <div class="tab-content" id="tabSettings">
        <form id="settingsForm" autocomplete="off">
          <div class="settings-group" id="settingsFields">
            <!-- Mode -->
            <div class="settings-row">
              <label for="modeSelect"><strong>Mode</strong></label>
              <select id="modeSelect" name="mode">
                <option value="PLS">PLS</option>
                <option value="SLS">SLS</option>
              </select>
            </div>
            <!-- Pause Time -->
            <div class="settings-row">
              <label for="pauseTime"><strong>Pause Time</strong></label>
              <input type="text" id="pauseTime" name="pauseTime" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
            </div>
            <!-- Time/Cycles -->
            <div class="settings-row">
              <label for="timeCyclesSelect"><strong>Time/Cycles</strong></label>
              <select id="timeCyclesSelect" name="timeCycles">
                <option value="TIME">Time</option>
                <option value="CYCLE">Cycles</option>
              </select>
            </div>
            <!-- Time/Cycles Value -->
            <div class="settings-row" id="timeCyclesValueRow">
              <label for="timeCyclesValue" id="timeCyclesValueLabel"><strong>Pump ON Time</strong></label>
              <input type="text" id="timeCyclesValue" name="timeCyclesValue" placeholder="00:00">
            </div>
            <!-- Proxy1 -->
            <div class="settings-row">
              <label for="proxy1"><strong>Proxy1</strong></label>
              <input type="checkbox" id="proxy1" name="proxy1">
            </div>
            <!-- Dwell Time (Proxy1) -->
            <div class="settings-row" id="dwellTime1Row" style="display:none;">
              <label for="dwellTime1"><strong>Dwell Time</strong></label>
              <input type="number" id="dwellTime1" name="dwellTime1" placeholder="Enter dwell time">
            </div>
            <!-- Proxy2 -->
            <div class="settings-row">
              <label for="proxy2"><strong>Proxy2</strong></label>
              <input type="checkbox" id="proxy2" name="proxy2">
            </div>
            <div class="settings-row" id="dwellTime2Row" style="display:none;">
              <label for="dwellTime2"><strong>Dwell Time Proxy2</strong></label>
              <input type="number" id="dwellTime2" name="dwellTime2" placeholder="Enter dwell time for Proxy2">
            </div>
            <!-- Level Sense -->
            <div class="settings-row">
              <label for="levelSense"><strong>Level Sense</strong></label>
              <input type="checkbox" id="levelSense" name="levelSense">
            </div>
            <div class="settings-row" id="levelSenseOptionsRow" style="display:none;">
              <label for="levelSenseOptions"><strong>Level Sense Mode</strong></label>
              <select id="levelSenseOptions" name="levelSenseOptions">
                <option value="HEF">Hall Sense</option>
                <option value="PULE">Pulse Empty</option>
                <option value="PULF">Pulse Full</option>
                <option value="LLO">Steady</option>
              </select>
            </div>
            <div class="settings-row" id="levelNoncRow" style="display:none;">
              <label for="levelNonc"><strong>Type</strong></label>
              <select id="levelNonc" name="levelNonc">
                <option value="NO">NO</option>
                <option value="NC">NC</option>
              </select>
            </div>
            <!-- Ext Lamp -->
            <div class="settings-row">
              <label for="extLamp"><strong>Ext Lamp</strong></label>
              <input type="checkbox" id="extLamp" name="extLamp">
            </div>
            <div class="settings-row" id="extLampOptionsRow" style="display:none;">
              <label for="extLampOptions"><strong>Lamp Mode</strong></label>
              <select id="extLampOptions" name="extLampOptions">
                <option value="RGB">RGB</option>
                <option value="STE">Steady</option>
                <option value="FLA">Flash</option>
              </select>
            </div>
            <!-- Blockage Current -->
            <div class="settings-row">
              <label><strong>Blockage Current</strong></label>
              <input type="checkbox" id="blockageManual" name="blockageManual">
              <span style="margin-right:8px;">Manual</span>
              <input type="checkbox" id="blockageAuto" name="blockageAuto">
              <span>Auto</span>
            </div>
            <div class="settings-row" id="blockageManualRow" style="display:none;">
              <label for="blockageManualValue"><strong>Manual Current</strong></label>
              <input type="number" id="blockageManualValue" name="blockageManualValue" placeholder="Enter motor current">
            </div>
            <div class="settings-row" id="blockageAutoRow" style="display:none;">
              <label for="blockageAutoValue"><strong>Auto Test</strong></label>
              <input type="text" id="blockageAutoValue" name="blockageAutoValue" placeholder="Pump Starting" disabled>
            </div>
            <!-- Pump2 -->
            <div class="settings-row">
              <label for="pump2"><strong>Pump2</strong></label>
              <input type="checkbox" id="pump2" name="pump2">
            </div>
            <div id="pump2SettingsGroup" style="display:none;">
              <div class="settings-row">
                <label for="pump2Mode"><strong>Mode</strong></label>
                <select id="pump2Mode" name="pump2Mode">
                  <option value="PLS">PLS</option>
                  <option value="SLS">SLS</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2PauseTime"><strong>Pause Time</strong></label>
                <input type="text" id="pump2PauseTime" name="pump2PauseTime" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
              </div>
              <div class="settings-row">
                <label for="pump2TimeCyclesSelect"><strong>Time/Cycles</strong></label>
                <select id="pump2TimeCyclesSelect" name="pump2TimeCycles">
                  <option value="TIME">Time</option>
                  <option value="CYCLE">Cycles</option>
                </select>
              </div>
              <div class="settings-row" id="pump2TimeCyclesValueRow">
                <label for="pump2TimeCyclesValue" id="pump2TimeCyclesValueLabel"><strong>Pump ON Time</strong></label>
                <input type="text" id="pump2TimeCyclesValue" name="pump2TimeCyclesValue" placeholder="00:00">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy1"><strong>Proxy1</strong></label>
                <input type="checkbox" id="pump2Proxy1" name="pump2Proxy1">
              </div>
              <div class="settings-row" id="pump2DwellTime1Row" style="display:none;">
                <label for="pump2DwellTime1"><strong>Dwell Time</strong></label>
                <input type="number" id="pump2DwellTime1" name="pump2DwellTime1" placeholder="Enter dwell time">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy2"><strong>Proxy2</strong></label>
                <input type="checkbox" id="pump2Proxy2" name="pump2Proxy2">
              </div>
              <div class="settings-row" id="pump2DwellTime2Row" style="display:none;">
                <label for="pump2DwellTime2"><strong>Dwell Time Proxy2</strong></label>
                <input type="number" id="pump2DwellTime2" name="pump2DwellTime2" placeholder="Enter dwell time for Proxy2">
              </div>
              <div class="settings-row">
                <label for="pump2LevelSense"><strong>Level Sense</strong></label>
                <input type="checkbox" id="pump2LevelSense" name="pump2LevelSense">
              </div>
              <div class="settings-row" id="pump2LevelSenseOptionsRow" style="display:none;">
                <label for="pump2LevelSenseOptions"><strong>Level Sense Mode</strong></label>
                <select id="pump2LevelSenseOptions" name="pump2LevelSenseOptions">
                  <option value="HEF">Hall Sense</option>
                  <option value="PULE">Pulse Empty</option>
                  <option value="PULF">Pulse Full</option>
                  <option value="LLO">Steady</option>
                </select>
              </div>
              <div class="settings-row" id="pump2LevelNoncRow" style="display:none;">
                <label for="pump2LevelNonc"><strong>Type</strong></label>
                <select id="pump2LevelNonc" name="pump2LevelNonc">
                  <option value="NO">NO</option>
                  <option value="NC">NC</option>
                </select>
              </div>
              <div class="settings-row">
                <label><strong>Blockage Current</strong></label>
                <input type="checkbox" id="pump2BlockageManual" name="pump2BlockageManual">
                <span style="margin-right:8px;">Manual</span>
                <input type="checkbox" id="pump2BlockageAuto" name="pump2BlockageAuto">
                <span>Auto</span>
              </div>
              <div class="settings-row" id="pump2BlockageManualRow" style="display:none;">
                <label for="pump2BlockageManualValue"><strong>Manual Current</strong></label>
                <input type="number" id="pump2BlockageManualValue" name="pump2BlockageManualValue" placeholder="Enter motor current">
              </div>
              <div class="settings-row" id="pump2BlockageAutoRow" style="display:none;">
                <label for="pump2BlockageAutoValue"><strong>Auto Test</strong></label>
                <input type="text" id="pump2BlockageAutoValue" name="pump2BlockageAutoValue" placeholder="Pump Starting" disabled>
              </div>
            </div>
          </div>
          <div class="btn-row" id="testModeBtnRow" style="margin-bottom:10px;">
            <button type="button" class="btn" id="testModeBtn">Test</button>
            <button type="submit" class="btn" id="saveSettingsBtn">Save Settings</button>
          </div>
        </form>
        <!-- Test Mode UI (hidden by default) -->
        <div id="testModePanel" style="display:none;">
          <div class="testmode-panel-container">
            <div class="testmode-row">
              <span class="testmode-label">Pump1</span>
              <button type="button" class="btn testmode-pump-btn pump-on" id="pump1TestBtn">ON</button>
            </div>
            <div class="testmode-row" id="pump2TestRow" style="display:none;">
              <span class="testmode-label">Pump2</span>
              <button type="button" class="btn testmode-pump-btn pump-on" id="pump2TestBtn">ON</button>
            </div>
            <div class="testmode-row" id="proxy1Row">
              <span class="testmode-label">Proxy1</span>
              <span class="testmode-indicator proxy-off" id="proxy1Indicator">OFF</span>
            </div>
            <div class="testmode-row" id="proxy2Row">
              <span class="testmode-label">Proxy2</span>
              <span class="testmode-indicator proxy-off" id="proxy2Indicator">OFF</span>
            </div>
            <!-- ADD pump2 proxy indicators -->
            <div class="testmode-row" id="pump2Proxy1Row" style="display:none;">
              <span class="testmode-label">P2 Proxy1</span>
              <span class="testmode-indicator proxy-off" id="pump2Proxy1Indicator">OFF</span>
            </div>
            <div class="testmode-row" id="pump2Proxy2Row" style="display:none;">
              <span class="testmode-label">P2 Proxy2</span>
              <span class="testmode-indicator proxy-off" id="pump2Proxy2Indicator">OFF</span>
            </div>
          </div>
          <div class="btn-row" style="margin-top:24px;">
            <button type="button" class="btn" id="testModeBackBtn">Back</button>
            <button type="submit" class="btn" id="testModeSaveBtn">Save Settings</button>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tabWiFi">
        <form id="wifiFormMain" autocomplete="off">
          <div class="fields-flex">
            <div class="input-group">
              <label for="ssid-main">WiFi Name:</label>
              <input type="text" id="ssid-main" name="ssid" required>
            </div>
            <div class="input-group">
              <label for="password-main">WiFi Password:</label>
              <input type="password" id="password-main" name="password" required>
            </div>
          </div>
          <div class="btn-row">
            <button type="submit" class="btn">SAVE</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      let lastBlockCurrentP1Value = undefined;
      let userBlockCurrentP1Value = undefined;
      let latestSettingsPayload = { p1: null, p2: null, xtra: null };
      let p1AutoCalibrating = false;
      let p2AutoCalibrating = false;
      let isAlreadyConnected = false; // ADD this line

      // Blockage Current logic for Pump1
      const blockageManual = document.getElementById('blockageManual');
      const blockageAuto = document.getElementById('blockageAuto');
      const blockageManualRow = document.getElementById('blockageManualRow');
      const blockageAutoRow = document.getElementById('blockageAutoRow');
      const blockageManualValue = document.getElementById('blockageManualValue');
      const blockageAutoValue = document.getElementById('blockageAutoValue');

      // Blockage Current logic for Pump2
      const pump2BlockageManual = document.getElementById('pump2BlockageManual');
      const pump2BlockageAuto = document.getElementById('pump2BlockageAuto');
      const pump2BlockageManualRow = document.getElementById('pump2BlockageManualRow');
      const pump2BlockageAutoRow = document.getElementById('pump2BlockageAutoRow');
      const pump2BlockageManualValue = document.getElementById('pump2BlockageManualValue');
      const pump2BlockageAutoValue = document.getElementById('pump2BlockageAutoValue');

      // Track pump state for correct MQTT payload
      let pump1IsOn = false;
      let pump2IsOn = false; // ADD this line

      // Add pump1 test button click handler
      const pump1TestBtn = document.getElementById('pump1TestBtn');
      if (pump1TestBtn) {
        pump1TestBtn.onclick = function() {
          if (client && client.connected && serial) {
            const payload = pump1IsOn ? "off" : "on";
            client.publish(`a3/${serial}/test/pump1`, payload);
            console.log(`Published test command for Pump1: ${payload}`);
          }
        };
      }

      // ADD pump2 test button click handler
      const pump2TestBtn = document.getElementById('pump2TestBtn');
      if (pump2TestBtn) {
        pump2TestBtn.onclick = function() {
          if (client && client.connected && serial) {
            const payload = pump2IsOn ? "off" : "on";
            client.publish(`a3/${serial}/test/pump2`, payload);
            console.log(`Published test command for Pump2: ${payload}`);
          }
        };
      }

      // Track user edits
      blockageManualValue.addEventListener('input', function() {
        userBlockCurrentP1Value = this.value;
      });

      // Auto calibration functions
      function startP1AutoCalibration() {
        if (client && client.connected && serial) {
          p1AutoCalibrating = true;
          client.publish(`a3/${serial}/test/pump1`, "currentAutoCalibrate");
          console.log("Started P1 auto calibration");
        }
      }

      function startP2AutoCalibration() {
        console.log("startP2AutoCalibration called");
        console.log("Client exists:", !!client);
        console.log("Client connected:", client && client.connected);
        console.log("Serial:", serial);
        
        if (client && client.connected && serial) {
          p2AutoCalibrating = true;
          const topic = `a3/${serial}/test/pump2`;
          const result = client.publish(topic, "currentAutoCalibrate");
          console.log("Published to topic:", topic);
          console.log("Publish result:", result);
          console.log("Started P2 auto calibration - p2AutoCalibrating set to:", p2AutoCalibrating);
        } else {
          console.log("Cannot start P2 auto calibration - requirements not met");
        }
      }

      // Time conversion functions
      function secondsToHMS(seconds) {
        const totalSeconds = parseInt(seconds);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const secs = totalSeconds % 60;
        
        return String(hours).padStart(2, '0') + ':' + 
               String(minutes).padStart(2, '0') + ':' + 
               String(secs).padStart(2, '0');
      }

      function secondsToMS(seconds) {
        const totalSeconds = parseInt(seconds);
        const minutes = Math.floor(totalSeconds / 60);
        const secs = totalSeconds % 60;
        
        return String(minutes).padStart(2, '0') + ':' + 
               String(secs).padStart(2, '0');
      }

      function msToSeconds(msString) {
        const parts = msString.split(':');
        if (parts.length !== 2) return 0;
        
        const minutes = parseInt(parts[0]) || 0;
        const seconds = parseInt(parts[1]) || 0;
        
        return (minutes * 60) + seconds;
      }

      function hmsToSeconds(hmsString) {
        const parts = hmsString.split(':');
        if (parts.length !== 3) return 0;
        
        const hours = parseInt(parts[0]) || 0;
        const minutes = parseInt(parts[1]) || 0;
        const seconds = parseInt(parts[2]) || 0;
        
        return (hours * 3600) + (minutes * 60) + seconds;
      }

      function validateHMSInput(input) {
        input.addEventListener('input', function() {
          let value = this.value.replace(/[^0-9:]/g, '');
          
          // Auto-format as user types
          if (value.length === 2 && !value.includes(':')) {
            value += ':';
          } else if (value.length === 5 && value.split(':').length === 2) {
            value += ':';
          }
          
          this.value = value;
        });

        input.addEventListener('blur', function() {
          let value = this.value;
          const parts = value.split(':');
          
          // Ensure we have 3 parts
          while (parts.length < 3) {
            parts.push('00');
          }
          
          // Validate and format each part
          const hours = Math.max(0, Math.min(99, parseInt(parts[0]) || 0));
          const minutes = Math.max(0, Math.min(59, parseInt(parts[1]) || 0));
          const seconds = Math.max(0, Math.min(59, parseInt(parts[2]) || 0));
          
          this.value = String(hours).padStart(2, '0') + ':' + 
                       String(minutes).padStart(2, '0') + ':' + 
                       String(seconds).padStart(2, '0');
        });
      }

      function validateMSInput(input) {
        input.addEventListener('input', function() {
          let value = this.value.replace(/[^0-9:]/g, '');
          
          // Auto-format as user types
          if (value.length === 2 && !value.includes(':')) {
            value += ':';
          }
          
          this.value = value;
        });

        input.addEventListener('blur', function() {
          let value = this.value;
          const parts = value.split(':');
          
          // Ensure we have 2 parts
          while (parts.length < 2) {
            parts.push('00');
          }
          
          // Validate and format each part
          const minutes = Math.max(0, Math.min(999, parseInt(parts[0]) || 0));
          const seconds = Math.max(0, Math.min(59, parseInt(parts[1]) || 0));
          
          this.value = String(minutes).padStart(2, '0') + ':' + 
                       String(seconds).padStart(2, '0');
        });
      }

      // Apply validation to inputs
      validateHMSInput(document.getElementById('pauseTime'));
      validateHMSInput(document.getElementById('pump2PauseTime'));
      validateMSInput(document.getElementById('timeCyclesValue'));
      validateMSInput(document.getElementById('pump2TimeCyclesValue'));

      function updateBlockageRows() {
        const autoLabel = document.querySelector('label[for="blockageAutoValue"]');
        
        if (blockageManual.checked) {
          blockageManualRow.style.display = '';
          blockageAutoRow.style.display = 'none';
          if (userBlockCurrentP1Value !== undefined && userBlockCurrentP1Value !== '') {
            blockageManualValue.value = userBlockCurrentP1Value;
          } else if (lastBlockCurrentP1Value !== undefined && lastBlockCurrentP1Value !== null && lastBlockCurrentP1Value !== '') {
            blockageManualValue.value = lastBlockCurrentP1Value;
          } else {
            blockageManualValue.value = '';
            blockageManualValue.placeholder = 'Enter motor current';
          }
        } else if (blockageAuto.checked) {
          blockageManualRow.style.display = 'none';
          blockageAutoRow.style.display = '';
          if (autoLabel) {
            autoLabel.innerHTML = '<strong>Auto Test</strong>';
          }
          if (!p1AutoCalibrating) {
            blockageAutoValue.value = 'Pump Starting';
            // Start auto calibration when auto is selected
            startP1AutoCalibration();
          }
        } else {
          blockageManualRow.style.display = 'none';
          blockageAutoRow.style.display = 'none';
          p1AutoCalibrating = false;
        }
      }

      function updatePump2BlockageRows() {
        console.log("updatePump2BlockageRows called");
        const pump2AutoLabel = document.querySelector('label[for="pump2BlockageAutoValue"]');
        
        if (pump2BlockageManual.checked) {
          console.log("Pump2 Manual checked");
          pump2BlockageManualRow.style.display = '';
          pump2BlockageAutoRow.style.display = 'none';
        } else if (pump2BlockageAuto.checked) {
          console.log("Pump2 Auto checked");
          pump2BlockageManualRow.style.display = 'none';
          pump2BlockageAutoRow.style.display = '';
          if (pump2AutoLabel) {
            pump2AutoLabel.innerHTML = '<strong>Auto Test</strong>';
          }
          if (!p2AutoCalibrating) {
            console.log("p2AutoCalibrating is false, starting calibration");
            pump2BlockageAutoValue.value = 'Pump Starting';
            startP2AutoCalibration();
          } else {
            console.log("p2AutoCalibrating is already true, skipping");
          }
        } else {
          console.log("Neither pump2 manual nor auto checked");
          pump2BlockageManualRow.style.display = 'none';
          pump2BlockageAutoRow.style.display = 'none';
          p2AutoCalibrating = false;
        }
      }

      blockageManual.addEventListener('change', updateBlockageRows);
      blockageAuto.addEventListener('change', updateBlockageRows);
      pump2BlockageManual.addEventListener('change', updatePump2BlockageRows);
      pump2BlockageAuto.addEventListener('change', updatePump2BlockageRows);

      // Dynamic label updates for Time/Cycles
      function updateTimeCyclesLabel() {
        const timeCyclesSelect = document.getElementById('timeCyclesSelect');
        const timeCyclesValueLabel = document.getElementById('timeCyclesValueLabel');
        const timeCyclesValue = document.getElementById('timeCyclesValue');
        
        if (timeCyclesSelect.value === 'TIME') {
          timeCyclesValueLabel.innerHTML = '<strong>Pump ON Time</strong>';
          timeCyclesValue.placeholder = '00:00';
        } else if (timeCyclesSelect.value === 'CYCLE') {
          timeCyclesValueLabel.innerHTML = '<strong>Pump ON Cycles</strong>';
          timeCyclesValue.placeholder = 'Enter cycles';
        }
      }

      function updatePump2TimeCyclesLabel() {
        const pump2TimeCyclesSelect = document.getElementById('pump2TimeCyclesSelect');
        const pump2TimeCyclesValueLabel = document.getElementById('pump2TimeCyclesValueLabel');
        const pump2TimeCyclesValue = document.getElementById('pump2TimeCyclesValue');
        
        if (pump2TimeCyclesSelect.value === 'TIME') {
          pump2TimeCyclesValueLabel.innerHTML = '<strong>Pump ON Time</strong>';
          pump2TimeCyclesValue.placeholder = '00:00';
        } else if (pump2TimeCyclesSelect.value === 'CYCLE') {
          pump2TimeCyclesValueLabel.innerHTML = '<strong>Pump ON Cycles</strong>';
          pump2TimeCyclesValue.placeholder = 'Enter cycles';
        }
      }

      document.getElementById('timeCyclesSelect').addEventListener('change', updateTimeCyclesLabel);
      document.getElementById('pump2TimeCyclesSelect').addEventListener('change', updatePump2TimeCyclesLabel);

      // Tab switching logic
      const tabMainBtn = document.getElementById('tabMainBtn');
      const tabLiveBtn = document.getElementById('tabLiveBtn');
      const tabSettingsBtn = document.getElementById('tabSettingsBtn');
      const tabWiFiBtn = document.getElementById('tabWiFiBtn');
      const tabMain = document.getElementById('tabMain');
      const tabLive = document.getElementById('tabLive');
      const tabSettings = document.getElementById('tabSettings');
      const tabWiFi = document.getElementById('tabWiFi');

      function switchAwayFromSettings() {
        // Send pump off messages when switching away from settings tab
        const testModePanel = document.getElementById('testModePanel');
        if (testModePanel && testModePanel.style.display !== 'none') {
          sendPumpOffMessages();
        }
      }

      // Add these variables at the top to store device info
      let deviceSerial = null;
      let deviceVersion = null;

      // Update the main tab click handler
      tabMainBtn.onclick = function() {
        switchAwayFromSettings();
        tabMainBtn.classList.add('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabMain.classList.add('active');
        tabLive.classList.remove('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
        
        // CHANGE: Always restore device info from localStorage first
        const storedSerial = localStorage.getItem('deviceSerial');
        const storedVersion = localStorage.getItem('deviceVersion');
        
        if (storedSerial) {
          deviceSerial = storedSerial;
          document.getElementById("serial-number").textContent = deviceSerial;
        }
        if (storedVersion) {
          deviceVersion = storedVersion;
          document.getElementById("ver-string").textContent = deviceVersion;
        }
        
        // Only try to connect if we don't have ANY device info
        if (!deviceSerial && !deviceVersion) {
          connectMQTTAndQuery();
        } else {
          showStatus("");
        }
      };
      tabLiveBtn.onclick = function() {
        switchAwayFromSettings(); // ADD this line
        tabLiveBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabLive.classList.add('active');
        tabMain.classList.remove('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
      };
      // Update the Settings tab click handler
      tabSettingsBtn.onclick = function() {
        // Don't switch tabs immediately - show loading state first
        showStatus("Loading device settings...", false);
        
        // Start the settings loading process
        loadSettingsBeforeTabSwitch();
      };

      // NEW: Function to handle the complete settings loading workflow
function loadSettingsBeforeTabSwitch() {
  // Reset settings payload object
  latestSettingsPayload = { p1: null, p2: null, xtra: null };
  
  // Set up a timeout for the entire loading process
  const loadingTimeout = setTimeout(() => {
    showStatus("Failed to load device settings. Loading default settings.", true);
    // Load default settings and then switch to tab
    loadDefaultSettingsAndSwitchTab();
  }, 10000);
  
  // Override the normal settings application to handle tab switching
  window.settingsLoadingForTabSwitch = true;
  window.settingsLoadingTimeout = loadingTimeout;
  
  if (client && client.connected && serial) {
    // Query for all three settings
    client.publish(`a3/${serial}/queryP1Settings`, serial);
    client.publish(`a3/${serial}/queryP2Settings`, serial);
    client.publish(`a3/${serial}/queryXtraSettings`, serial);
  } else {
    // No connection - load defaults
    clearTimeout(loadingTimeout);
    loadDefaultSettingsAndSwitchTab();
  }
}

// Updated applySettingsFromPayload to handle tab switching workflow
function applySettingsFromPayload(payloads) {
  console.log("applySettingsFromPayload called with:", payloads);
  
  // Check if this is for tab switching workflow
  const isTabSwitchLoading = window.settingsLoadingForTabSwitch;
  
  try {
    const settingsP1 = payloads.p1 ? JSON.parse(payloads.p1) : null;
    const settingsP2 = payloads.p2 ? JSON.parse(payloads.p2) : null;
    const settingsXtra = payloads.xtra ? JSON.parse(payloads.xtra) : null;

    // Validate that we have complete settings
    const hasValidSettings = settingsP1 && settingsP2 && settingsXtra &&
                           settingsP1.modeP1 && settingsP2.modeP2 && settingsXtra.extLampType;

    if (isTabSwitchLoading) {
      if (!hasValidSettings) {
        console.log("Settings incomplete or corrupted, loading defaults");
        clearTimeout(window.settingsLoadingTimeout);
        loadDefaultSettingsAndSwitchTab();
        return;
      } else {
        console.log("Valid settings loaded, applying and switching to tab");
        clearTimeout(window.settingsLoadingTimeout);
      }
    }

    console.log("Parsed P1 settings:", settingsP1);
    console.log("Parsed P2 settings:", settingsP2);
    console.log("Parsed Xtra settings:", settingsXtra);

    // Apply all settings without any logic interference
    if (settingsP1) {
      applyP1Settings(settingsP1);
    }
    
    if (settingsP2) {
      applyP2Settings(settingsP2);
    }
    
    if (settingsXtra) {
      applyXtraSettings(settingsXtra);
    }

    // If this was for tab switching, now switch to the tab
    if (isTabSwitchLoading) {
      window.settingsLoadingForTabSwitch = false;
      actuallyActivateSettingsTab();
      showStatus("Settings loaded successfully.", false);
    }

  } catch (e) {
    console.error("applySettingsFromPayload error:", e);
    
    if (isTabSwitchLoading) {
      clearTimeout(window.settingsLoadingTimeout);
      loadDefaultSettingsAndSwitchTab();
    } else {
      showStatus("Failed to parse settings from device.", true);
    }
  }
}

// NEW: Apply P1 settings without any logic interference
function applyP1Settings(settingsP1) {
  if (settingsP1.modeP1) {
    document.getElementById('modeSelect').value = settingsP1.modeP1;
  }
  
  if (settingsP1.pauseTimeP1 !== undefined) {
    document.getElementById('pauseTime').value = secondsToHMS(settingsP1.pauseTimeP1);
  }
  
  if (settingsP1.runModeP1) {
    document.getElementById('timeCyclesSelect').value = settingsP1.runModeP1;
  }
  
  if (settingsP1.timeCyclesP1 !== undefined) {
    const timeCyclesValue = settingsP1.runModeP1 === 'TIME' ? 
      secondsToMS(settingsP1.timeCyclesP1) : 
      settingsP1.timeCyclesP1.toString();
    document.getElementById('timeCyclesValue').value = timeCyclesValue;
  }
  
  if (settingsP1.proxy1P1 !== undefined) {
    document.getElementById('proxy1').checked = settingsP1.proxy1P1 === "YES";
  }
  
  if (settingsP1.proxy2P1 !== undefined) {
    document.getElementById('proxy2').checked = settingsP1.proxy2P1 === "YES";
  }
  
  if (settingsP1.dwellTimeP1Px1 !== undefined) {
    document.getElementById('dwellTime1').value = settingsP1.dwellTimeP1Px1.toString();
  }
  
  if (settingsP1.dwellTimeP1Px2 !== undefined) {
    document.getElementById('dwellTime2').value = settingsP1.dwellTimeP1Px2.toString();
  }
  
  if (settingsP1.levelP1 !== undefined) {
    document.getElementById('levelSense').checked = settingsP1.levelP1 === "YES";
  }
  
  if (settingsP1.levelTypeP1) {
    document.getElementById('levelSenseOptions').value = settingsP1.levelTypeP1;
  }
  
  if (settingsP1.levelNoncP1) {
    document.getElementById('levelNonc').value = settingsP1.levelNoncP1;
  }
}

// NEW: Apply P2 settings without any logic interference
function applyP2Settings(settingsP2) {
  if (settingsP2.pump2InUse !== undefined) {
    document.getElementById('pump2').checked = settingsP2.pump2InUse === "YES";
  }
  
  if (settingsP2.modeP2) {
    document.getElementById('pump2Mode').value = settingsP2.modeP2;
  }
  
  if (settingsP2.pauseTimeP2 !== undefined) {
    document.getElementById('pump2PauseTime').value = secondsToHMS(settingsP2.pauseTimeP2);
  }
  
  if (settingsP2.runModeP2) {
    document.getElementById('pump2TimeCyclesSelect').value = settingsP2.runModeP2;
  }
  
  if (settingsP2.timeCyclesP2 !== undefined) {
    const pump2TimeCyclesValue = settingsP2.runModeP2 === 'TIME' ? 
      secondsToMS(settingsP2.timeCyclesP2) : 
      settingsP2.timeCyclesP2.toString();
    document.getElementById('pump2TimeCyclesValue').value = pump2TimeCyclesValue;
  }
  
  if (settingsP2.proxy1P2 !== undefined) {
    document.getElementById('pump2Proxy1').checked = settingsP2.proxy1P2 === "YES";
  }
  
  if (settingsP2.proxy2P2 !== undefined) {
    document.getElementById('pump2Proxy2').checked = settingsP2.proxy2P2 === "YES";
  }
  
  if (settingsP2.dwellTimeP2Px1 !== undefined) {
    document.getElementById('pump2DwellTime1').value = settingsP2.dwellTimeP2Px1.toString();
  }
  
  if (settingsP2.dwellTimeP2Px2 !== undefined) {
    document.getElementById('pump2DwellTime2').value = settingsP2.dwellTimeP2Px2.toString();
  }
  
  if (settingsP2.levelP2 !== undefined) {
    document.getElementById('pump2LevelSense').checked = settingsP2.levelP2 === "YES";
  }
  
  if (settingsP2.levelTypeP2) {
    document.getElementById('pump2LevelSenseOptions').value = settingsP2.levelTypeP2;
  }
  
  if (settingsP2.levelNoncP2) {
    document.getElementById('pump2LevelNonc').value = settingsP2.levelNoncP2;
  }
}

// NEW: Apply Xtra settings without any logic interference
function applyXtraSettings(settingsXtra) {
  if (settingsXtra.extLampInUse !== undefined) {
    document.getElementById('extLamp').checked = settingsXtra.extLampInUse === "YES";
  }
  
  if (settingsXtra.extLampType) {
    document.getElementById('extLampOptions').value = settingsXtra.extLampType;
  }
  
  if (settingsXtra.blockCurrentP1 !== undefined) {
    document.getElementById('blockageManualValue').value = settingsXtra.blockCurrentP1.toString();
    document.getElementById('blockageManual').checked = true;
  }
  
  if (settingsXtra.blockCurrentP2 !== undefined) {
    document.getElementById('pump2BlockageManualValue').value = settingsXtra.blockCurrentP2.toString();
    document.getElementById('pump2BlockageManual').checked = true;
  }
}

// NEW: Load default settings and switch to tab
function loadDefaultSettingsAndSwitchTab() {
  console.log("Loading default settings");
  
  // Apply default P1 settings
  document.getElementById('modeSelect').value = 'PLS';
  document.getElementById('pauseTime').value = '00:00:10';
  document.getElementById('timeCyclesSelect').value = 'TIME';
  document.getElementById('timeCyclesValue').value = '00:15';
  document.getElementById('proxy1').checked = false;
  document.getElementById('proxy2').checked = false;
  document.getElementById('dwellTime1').value = '15';
  document.getElementById('dwellTime2').value = '10';
  document.getElementById('levelSense').checked = false;
  document.getElementById('levelSenseOptions').value = 'HEF';
  document.getElementById('levelNonc').value = 'NO';
  
  // Apply default P2 settings
  document.getElementById('pump2').checked = false;
  document.getElementById('pump2Mode').value = 'PLS';
  document.getElementById('pump2PauseTime').value = '00:00:10';
  document.getElementById('pump2TimeCyclesSelect').value = 'TIME';
  document.getElementById('pump2TimeCyclesValue').value = '00:05';
  document.getElementById('pump2Proxy1').checked = false;
  document.getElementById('pump2Proxy2').checked = false;
  document.getElementById('pump2DwellTime1').value = '10';
  document.getElementById('pump2DwellTime2').value = '10';
  document.getElementById('pump2LevelSense').checked = false;
  document.getElementById('pump2LevelSenseOptions').value = 'HEF';
  document.getElementById('pump2LevelNonc').value = 'NO';
  
  // Apply default Xtra settings
  document.getElementById('extLamp').checked = false;
  document.getElementById('extLampOptions').value = 'RGB';
  document.getElementById('blockageManual').checked = false;
  document.getElementById('blockageManualValue').value = '0';
  document.getElementById('pump2BlockageManual').checked = false;
  document.getElementById('pump2BlockageManualValue').value = '1000';
  
  // Now switch to settings tab
  window.settingsLoadingForTabSwitch = false;
  actuallyActivateSettingsTab();
  showStatus("Default settings loaded.", false);
}

// NEW: Actually perform the tab switch (separated from loading logic)
function actuallyActivateSettingsTab() {
  // Perform the actual tab switch
  switchAwayFromSettings();
  tabMainBtn.classList.remove('active');
  tabLiveBtn.classList.remove('active');
  tabSettingsBtn.classList.add('active');
  tabWiFiBtn.classList.remove('active');
  tabMain.classList.remove('active');
  tabLive.classList.remove('active');
  tabSettings.classList.add('active');
  tabWiFi.classList.remove('active');

  // Now apply the visibility logic AFTER the tab is active and settings are loaded
  setTimeout(() => {
    applyAllVisibilityLogic();
  }, 50);
}

// NEW: Apply all visibility logic after settings are fully loaded
function applyAllVisibilityLogic() {
  // Update labels based on current selections
  updateTimeCyclesLabel();
  updatePump2TimeCyclesLabel();
  
  // Apply proxy visibility rules based on loaded settings
  const timeCyclesMode = document.getElementById('timeCyclesSelect').value;
  const proxy1Checked = document.getElementById('proxy1').checked;
  
  // P1 Proxy visibility
  document.getElementById('dwellTime1Row').style.display = proxy1Checked ? '' : 'none';
  
  const proxy2Row = document.querySelector('[for="proxy2"]').parentElement;
  if (proxy2Row) {
    if (timeCyclesMode === 'TIME' && !proxy1Checked) {
      proxy2Row.style.display = 'none';
      document.getElementById('dwellTime2Row').style.display = 'none';
    } else {
      proxy2Row.style.display = proxy1Checked ? '' : 'none';
      document.getElementById('dwellTime2Row').style.display = document.getElementById('proxy2').checked ? '' : 'none';
    }
  }
  
  // P2 visibility (if pump2 is enabled)
  if (document.getElementById('pump2').checked) {
    const pump2TimeCyclesMode = document.getElementById('pump2TimeCyclesSelect').value;
    const pump2Proxy1Checked = document.getElementById('pump2Proxy1').checked;
    
    document.getElementById('pump2DwellTime1Row').style.display = pump2Proxy1Checked ? '' : 'none';
    
    const pump2Proxy2Row = document.querySelector('[for="pump2Proxy2"]').parentElement;
    if (pump2Proxy2Row) {
      if (pump2TimeCyclesMode === 'TIME' && !pump2Proxy1Checked) {
        pump2Proxy2Row.style.display = 'none';
        document.getElementById('pump2DwellTime2Row').style.display = 'none';
      } else {
        pump2Proxy2Row.style.display = pump2Proxy1Checked ? '' : 'none';
        document.getElementById('pump2DwellTime2Row').style.display = document.getElementById('pump2Proxy2').checked ? '' : 'none';
      }
    }
  }
  
  console.log("All visibility logic applied");
}
    </script>
  </body>
</html>