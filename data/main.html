<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A3 Setup</title>
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/style.css?v=' + new Date().getTime();
      document.head.appendChild(link);
    </script>
    <style>
      /* Hide arrows for number inputs (Chrome, Safari, Edge) */
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      /* Hide arrows for number inputs (Firefox) */
      input[type=number] {
        -moz-appearance: textfield;
      }
    </style>
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
  </head>
  <body>
    <div class="header-box">
      <h1>A3 Setup</h1>
    </div>
    <div class="content main-content">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" id="tabMainBtn" type="button">Main</button>
        <button class="tab-btn" id="tabLiveBtn" type="button">Live</button>
        <button class="tab-btn" id="tabSettingsBtn" type="button">Settings</button>
        <button class="tab-btn" id="tabWiFiBtn" type="button">WiFi</button>
      </div>
      <!-- Tab Contents -->
      <div class="tab-content active" id="tabMain">
        <div class="info-row">
          <div>
            Serial: <span id="serial-number" class="info-value">...</span>
          </div>
          <div>
            Version: <span id="ver-string" class="info-value">...</span>
          </div>
        </div>
        <div id="status-message" class="status-message"></div>
        <div class="btn-row">
          <button class="btn" id="backBtn">CHANGE</button>
        </div>
      </div>
      <div class="tab-content" id="tabLive">
        <div style="margin: 40px 0 20px 0; text-align: center;">
          <strong>Live tab content goes here.</strong>
        </div>
      </div>
      <div class="tab-content" id="tabSettings">
        <form id="settingsForm" autocomplete="off">
          <div class="settings-group" id="settingsFields">
            <!-- Mode -->
            <div class="settings-row">
              <label for="modeSelect"><strong>Mode</strong></label>
              <select id="modeSelect" name="mode">
                <option value="PLS">PLS</option>
                <option value="SLS">SLS</option>
              </select>
            </div>
            <!-- Pause Time -->
            <div class="settings-row">
              <label for="pauseTime"><strong>Pause Time</strong></label>
              <input type="number" id="pauseTime" name="pauseTime" placeholder="Enter pause time">
            </div>
            <!-- Time/Cycles -->
            <div class="settings-row">
              <label for="timeCyclesSelect"><strong>Time/Cycles</strong></label>
              <select id="timeCyclesSelect" name="timeCycles">
                <option value="TIME">Time</option>
                <option value="CYCLE">Cycles</option>
              </select>
            </div>
            <!-- Time/Cycles Value -->
            <div class="settings-row" id="timeCyclesValueRow">
              <label for="timeCyclesValue" id="timeCyclesValueLabel"><strong>Value</strong></label>
              <input type="number" id="timeCyclesValue" name="timeCyclesValue" placeholder="Enter Pump ON time">
            </div>
            <!-- Proxy1 -->
            <div class="settings-row">
              <label for="proxy1"><strong>Proxy1</strong></label>
              <input type="checkbox" id="proxy1" name="proxy1">
            </div>
            <!-- Dwell Time (Proxy1) -->
            <div class="settings-row" id="dwellTime1Row" style="display:none;">
              <label for="dwellTime1"><strong>Dwell Time</strong></label>
              <input type="number" id="dwellTime1" name="dwellTime1" placeholder="Enter dwell time">
            </div>
            <!-- Proxy2 -->
            <div class="settings-row">
              <label for="proxy2"><strong>Proxy2</strong></label>
              <input type="checkbox" id="proxy2" name="proxy2">
            </div>
            <div class="settings-row" id="dwellTime2Row" style="display:none;">
              <label for="dwellTime2"><strong>Dwell Time Proxy2</strong></label>
              <input type="number" id="dwellTime2" name="dwellTime2" placeholder="Enter dwell time for Proxy2">
            </div>
            <!-- Level Sense -->
            <div class="settings-row">
              <label for="levelSense"><strong>Level Sense</strong></label>
              <input type="checkbox" id="levelSense" name="levelSense">
            </div>
            <div class="settings-row" id="levelSenseOptionsRow" style="display:none;">
              <label for="levelSenseOptions"><strong>Level Sense Mode</strong></label>
              <select id="levelSenseOptions" name="levelSenseOptions">
                <option value="HEF">Hall Sense</option>
                <option value="PULE">Pulse Empty</option>
                <option value="PULF">Pulse Full</option>
                <option value="LLO">Steady</option>
              </select>
              <label for="levelNonc" style="margin-left:16px;"><strong>Type</strong></label>
              <select id="levelNonc" name="levelNonc">
                <option value="NO">NO</option>
                <option value="NC">NC</option>
              </select>
            </div>
            <!-- Ext Lamp -->
            <div class="settings-row">
              <label for="extLamp"><strong>Ext Lamp</strong></label>
              <input type="checkbox" id="extLamp" name="extLamp">
            </div>
            <div class="settings-row" id="extLampOptionsRow" style="display:none;">
              <label for="extLampOptions"><strong>Lamp Mode</strong></label>
              <select id="extLampOptions" name="extLampOptions">
                <option value="RGB">RGB</option>
                <option value="STE">Steady</option>
                <option value="FLA">Flash</option>
              </select>
            </div>
            <!-- Blockage Current -->
            <div class="settings-row">
              <label><strong>Blockage Current</strong></label>
              <input type="checkbox" id="blockageManual" name="blockageManual">
              <span style="margin-right:8px;">Manual</span>
              <input type="checkbox" id="blockageAuto" name="blockageAuto">
              <span>Auto</span>
            </div>
            <div class="settings-row" id="blockageManualRow" style="display:none;">
              <label for="blockageManualValue"><strong>Manual Current</strong></label>
              <input type="number" id="blockageManualValue" name="blockageManualValue" placeholder="Enter motor current">
            </div>
            <div class="settings-row" id="blockageAutoRow" style="display:none;">
              <label for="blockageAutoValue"><strong>Pump Starting</strong></label>
              <input type="number" id="blockageAutoValue" name="blockageAutoValue" placeholder="Pump Starting" disabled>
            </div>
            <!-- Pump2 -->
            <div class="settings-row">
              <label for="pump2"><strong>Pump2</strong></label>
              <input type="checkbox" id="pump2" name="pump2">
            </div>
            <div id="pump2SettingsGroup" style="display:none;">
              <div class="settings-row">
                <label for="pump2Mode"><strong>Mode</strong></label>
                <select id="pump2Mode" name="pump2Mode">
                  <option value="PLS">PLS</option>
                  <option value="SLS">SLS</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2PauseTime"><strong>Pause Time</strong></label>
                <input type="number" id="pump2PauseTime" name="pump2PauseTime" placeholder="Enter pause time">
              </div>
              <div class="settings-row">
                <label for="pump2TimeCyclesSelect"><strong>Time/Cycles</strong></label>
                <select id="pump2TimeCyclesSelect" name="pump2TimeCycles">
                  <option value="TIME">Time</option>
                  <option value="CYCLE">Cycles</option>
                </select>
              </div>
              <div class="settings-row" id="pump2TimeCyclesValueRow">
                <label for="pump2TimeCyclesValue" id="pump2TimeCyclesValueLabel"><strong>Value</strong></label>
                <input type="number" id="pump2TimeCyclesValue" name="pump2TimeCyclesValue" placeholder="Enter Pump ON time">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy1"><strong>Proxy1</strong></label>
                <input type="checkbox" id="pump2Proxy1" name="pump2Proxy1">
              </div>
              <div class="settings-row" id="pump2DwellTime1Row" style="display:none;">
                <label for="pump2DwellTime1"><strong>Dwell Time</strong></label>
                <input type="number" id="pump2DwellTime1" name="pump2DwellTime1" placeholder="Enter dwell time">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy2"><strong>Proxy2</strong></label>
                <input type="checkbox" id="pump2Proxy2" name="pump2Proxy2">
              </div>
              <div class="settings-row" id="pump2DwellTime2Row" style="display:none;">
                <label for="pump2DwellTime2"><strong>Dwell Time Proxy2</strong></label>
                <input type="number" id="pump2DwellTime2" name="pump2DwellTime2" placeholder="Enter dwell time for Proxy2">
              </div>
              <div class="settings-row">
                <label for="pump2LevelSense"><strong>Level Sense</strong></label>
                <input type="checkbox" id="pump2LevelSense" name="pump2LevelSense">
              </div>
              <div class="settings-row" id="pump2LevelSenseOptionsRow" style="display:none;">
                <label for="pump2LevelSenseOptions"><strong>Level Sense Mode</strong></label>
                <select id="pump2LevelSenseOptions" name="pump2LevelSenseOptions">
                  <option value="HEF">Hall Sense</option>
                  <option value="PULE">Pulse Empty</option>
                  <option value="PULF">Pulse Full</option>
                  <option value="LLO">Steady</option>
                </select>
                <label for="pump2LevelNonc" style="margin-left:16px;"><strong>Type</strong></label>
                <select id="pump2LevelNonc" name="pump2LevelNonc">
                  <option value="NO">NO</option>
                  <option value="NC">NC</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2ExtLamp"><strong>Ext Lamp</strong></label>
                <input type="checkbox" id="pump2ExtLamp" name="pump2ExtLamp">
              </div>
              <div class="settings-row" id="pump2ExtLampOptionsRow" style="display:none;">
                <label for="pump2ExtLampOptions"><strong>Lamp Mode</strong></label>
                <select id="pump2ExtLampOptions" name="pump2ExtLampOptions">
                  <option value="RGB">RGB</option>
                  <option value="STE">Steady</option>
                  <option value="FLA">Flash</option>
                </select>
              </div>
              <div class="settings-row">
                <label><strong>Blockage Current</strong></label>
                <input type="checkbox" id="pump2BlockageManual" name="pump2BlockageManual">
                <span style="margin-right:8px;">Manual</span>
                <input type="checkbox" id="pump2BlockageAuto" name="pump2BlockageAuto">
                <span>Auto</span>
              </div>
              <div class="settings-row" id="pump2BlockageManualRow" style="display:none;">
                <label for="pump2BlockageManualValue"><strong>Manual Current</strong></label>
                <input type="number" id="pump2BlockageManualValue" name="pump2BlockageManualValue" placeholder="Enter motor current">
              </div>
              <div class="settings-row" id="pump2BlockageAutoRow" style="display:none;">
                <label for="pump2BlockageAutoValue"><strong>Pump Starting</strong></label>
                <input type="number" id="pump2BlockageAutoValue" name="pump2BlockageAutoValue" placeholder="Pump Starting" disabled>
              </div>
            </div>
          </div>
          <div class="btn-row" id="testModeBtnRow" style="margin-bottom:10px;">
            <button type="button" class="btn" id="testModeBtn">Test</button>
            <button type="submit" class="btn" id="saveSettingsBtn">Save Settings</button>
          </div>
        </form>
        <!-- Test Mode UI (hidden by default) -->
        <div id="testModePanel" style="display:none;">
          <div class="testmode-panel-container">
            <div class="testmode-row">
              <span class="testmode-label">Pump1</span>
              <button type="button" class="btn testmode-pump-btn pump-off" id="pump1TestBtn">ON/OFF</button>
            </div>
            <div class="testmode-row" id="proxy1Row" style="display:none;">
              <span class="testmode-label">Proxy1</span>
              <span class="testmode-indicator proxy-off" id="proxy1Indicator">OFF</span>
            </div>
            <div class="testmode-row" id="proxy2Row" style="display:none;">
              <span class="testmode-label">Proxy2</span>
              <span class="testmode-indicator proxy-off" id="proxy2Indicator">OFF</span>
            </div>
          </div>
          <div class="btn-row" style="margin-top:24px;">
            <button type="button" class="btn" id="testModeBackBtn">Back</button>
            <button type="submit" class="btn" id="testModeSaveBtn">Save Settings</button>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tabWiFi">
        <form id="wifiFormMain" autocomplete="off">
          <div class="fields-flex">
            <div class="input-group">
              <label for="ssid-main">WiFi Name:</label>
              <input type="text" id="ssid-main" name="ssid" required>
            </div>
            <div class="input-group">
              <label for="password-main">WiFi Password:</label>
              <input type="password" id="password-main" name="password" required>
            </div>
          </div>
          <div class="btn-row">
            <button type="submit" class="btn">SAVE</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Tab switching logic
        const tabMainBtn = document.getElementById('tabMainBtn');
        const tabLiveBtn = document.getElementById('tabLiveBtn');
        const tabSettingsBtn = document.getElementById('tabSettingsBtn');
        const tabWiFiBtn = document.getElementById('tabWiFiBtn');
        const tabMain = document.getElementById('tabMain');
        const tabLive = document.getElementById('tabLive');
        const tabSettings = document.getElementById('tabSettings');
        const tabWiFi = document.getElementById('tabWiFi');

        tabMainBtn.onclick = function() {
          tabMainBtn.classList.add('active');
          tabLiveBtn.classList.remove('active');
          tabSettingsBtn.classList.remove('active');
          tabWiFiBtn.classList.remove('active');
          tabMain.classList.add('active');
          tabLive.classList.remove('active');
          tabSettings.classList.remove('active');
          tabWiFi.classList.remove('active');
        };
        tabLiveBtn.onclick = function() {
          tabLiveBtn.classList.add('active');
          tabMainBtn.classList.remove('active');
          tabSettingsBtn.classList.remove('active');
          tabWiFiBtn.classList.remove('active');
          tabLive.classList.add('active');
          tabMain.classList.remove('active');
          tabSettings.classList.remove('active');
          tabWiFi.classList.remove('active');
        };
        tabSettingsBtn.onclick = function() {
          tabSettingsBtn.classList.add('active');
          tabMainBtn.classList.remove('active');
          tabLiveBtn.classList.remove('active');
          tabWiFiBtn.classList.remove('active');
          tabSettings.classList.add('active');
          tabMain.classList.remove('active');
          tabLive.classList.remove('active');
          tabWiFi.classList.remove('active');
          // Request settings from device when switching to Settings tab
          if (client && client.connected && typeof client.publish === "function") {
            const serial = getSerialFromURL();
            if (serial) {
              client.publish('a3/querySettings', serial);
              showStatus("Requesting settings from device...");
            }
          }
        };
        tabWiFiBtn.onclick = function() {
          tabWiFiBtn.classList.add('active');
          tabMainBtn.classList.remove('active');
          tabLiveBtn.classList.remove('active');
          tabSettingsBtn.classList.remove('active');
          tabWiFi.classList.add('active');
          tabMain.classList.remove('active');
          tabLive.classList.remove('active');
          tabSettings.classList.remove('active');
        };

        // Show/hide logic for dwell time and options fields
        function setupShowHideCheckbox(triggerId, targetRowId) {
          const trigger = document.getElementById(triggerId);
          const target = document.getElementById(targetRowId);
          if (trigger && target) {
            trigger.addEventListener('change', function() {
              target.style.display = this.checked ? '' : 'none';
            });
          }
        }
        setupShowHideCheckbox('proxy1', 'dwellTime1Row');
        setupShowHideCheckbox('proxy2', 'dwellTime2Row');
        setupShowHideCheckbox('levelSense', 'levelSenseOptionsRow');
        setupShowHideCheckbox('extLamp', 'extLampOptionsRow');
        setupShowHideCheckbox('pump2', 'pump2SettingsGroup');
        setupShowHideCheckbox('pump2Proxy1', 'pump2DwellTime1Row');
        setupShowHideCheckbox('pump2Proxy2', 'pump2DwellTime2Row');
        setupShowHideCheckbox('pump2LevelSense', 'pump2LevelSenseOptionsRow');
        setupShowHideCheckbox('pump2ExtLamp', 'pump2ExtLampOptionsRow');

        // MQTT config
        const hivemqBrokerUrl = 'wss://bd58f8878eef4f5eb73ac65312b10130.s1.eu.hivemq.cloud:8884/mqtt';
        const hivemqUsername = 'a3Admin';
        const hivemqPassword = 'DontLetMeIn247';

        let client = null;
        let serial = null;
        let queryTimeout = null;

        function getSerialFromURL() {
          const params = new URLSearchParams(window.location.search);
          return params.get("serial");
        }

        function showStatus(msg, isError = false) {
          const status = document.getElementById("status-message");
          status.textContent = msg;
          status.className = "status-message" + (isError ? " error" : "");
        }

        // Accepts boolean, "YES"/"NO", "true"/"false", 1/0
        function isChecked(val) {
          if (typeof val === "boolean") return val;
          if (typeof val === "string") return val.toUpperCase() === "YES" || val.toLowerCase() === "true";
          if (typeof val === "number") return val === 1;
          return false;
        }

        function applySettingsFromPayload(payload) {
          try {
            const settings = JSON.parse(payload);

            // --- PUMP 1 ---
            if (settings.modeP1 !== undefined)
              document.getElementById('modeSelect').value = settings.modeP1;

            if (settings.pauseTimeP1 !== undefined)
              document.getElementById('pauseTime').value = settings.pauseTimeP1;

            // Only set TIME/CYCLE, not a numeric value
            if (settings.timeCyclesP1 !== undefined && (settings.timeCyclesP1 === "TIME" || settings.timeCyclesP1 === "CYCLE"))
              document.getElementById('timeCyclesSelect').value = settings.timeCyclesP1;

            if (settings.timeCyclesValueP1 !== undefined)
              document.getElementById('timeCyclesValue').value = settings.timeCyclesValueP1;

            if (settings.proxy1P1 !== undefined) {
              document.getElementById('proxy1').checked = isChecked(settings.proxy1P1);
              document.getElementById('dwellTime1Row').style.display = isChecked(settings.proxy1P1) ? '' : 'none';
            }
            if (settings.dwellTimeP1Px1 !== undefined)
              document.getElementById('dwellTime1').value = settings.dwellTimeP1Px1;

            if (settings.proxy2P1 !== undefined) {
              document.getElementById('proxy2').checked = isChecked(settings.proxy2P1);
              document.getElementById('dwellTime2Row').style.display = isChecked(settings.proxy2P1) ? '' : 'none';
            }
            if (settings.dwellTimeP1Px2 !== undefined)
              document.getElementById('dwellTime2').value = settings.dwellTimeP1Px2;

            if (settings.levelP1 !== undefined) {
              document.getElementById('levelSense').checked = isChecked(settings.levelP1);
              document.getElementById('levelSenseOptionsRow').style.display = isChecked(settings.levelP1) ? '' : 'none';
            }
            if (settings.levelTypeP1 !== undefined)
              document.getElementById('levelSenseOptions').value = settings.levelTypeP1;
            if (settings.levelNoncP1 !== undefined)
              document.getElementById('levelNonc').value = settings.levelNoncP1;

            // --- EXT LAMP ---
            if (settings.extLampInUse !== undefined) {
              document.getElementById('extLamp').checked = isChecked(settings.extLampInUse);
              document.getElementById('extLampOptionsRow').style.display = isChecked(settings.extLampInUse) ? '' : 'none';
            }
            if (settings.extLampType !== undefined)
              document.getElementById('extLampOptions').value = settings.extLampType;

            // --- BLOCKAGE CURRENT ---
            if (settings.blockCurrentP1 !== undefined)
              document.getElementById('blockageManualValue').value = settings.blockCurrentP1;

            // --- PUMP 2 ---
            if (settings.pump2InUse !== undefined) {
              document.getElementById('pump2').checked = isChecked(settings.pump2InUse);
              document.getElementById('pump2SettingsGroup').style.display = isChecked(settings.pump2InUse) ? '' : 'none';
            }
            if (settings.modeP2 !== undefined)
              document.getElementById('pump2Mode').value = settings.modeP2;
            if (settings.pauseTimeP2 !== undefined)
              document.getElementById('pump2PauseTime').value = settings.pauseTimeP2;
            if (settings.timeCyclesP2 !== undefined && (settings.timeCyclesP2 === "TIME" || settings.timeCyclesP2 === "CYCLE"))
              document.getElementById('pump2TimeCyclesSelect').value = settings.timeCyclesP2;
            if (settings.timeCyclesValueP2 !== undefined)
              document.getElementById('pump2TimeCyclesValue').value = settings.timeCyclesValueP2;
            if (settings.proxy1P2 !== undefined) {
              document.getElementById('pump2Proxy1').checked = isChecked(settings.proxy1P2);
              document.getElementById('pump2DwellTime1Row').style.display = isChecked(settings.proxy1P2) ? '' : 'none';
            }
            if (settings.dwellTimeP2Px1 !== undefined)
              document.getElementById('pump2DwellTime1').value = settings.dwellTimeP2Px1;
            if (settings.proxy2P2 !== undefined) {
              document.getElementById('pump2Proxy2').checked = isChecked(settings.proxy2P2);
              document.getElementById('pump2DwellTime2Row').style.display = isChecked(settings.proxy2P2) ? '' : 'none';
            }
            if (settings.dwellTimeP2Px2 !== undefined)
              document.getElementById('pump2DwellTime2').value = settings.dwellTimeP2Px2;
            if (settings.levelP2 !== undefined) {
              document.getElementById('pump2LevelSense').checked = isChecked(settings.levelP2);
              document.getElementById('pump2LevelSenseOptionsRow').style.display = isChecked(settings.levelP2) ? '' : 'none';
            }
            if (settings.levelTypeP2 !== undefined)
              document.getElementById('pump2LevelSenseOptions').value = settings.levelTypeP2;
            if (settings.levelNoncP2 !== undefined)
              document.getElementById('pump2LevelNonc').value = settings.levelNoncP2;
          } catch (e) {
            showStatus("Failed to parse settings from device.", true);
            console.error("applySettingsFromPayload error:", e);
          }
        }

        function connectMQTTAndQuery() {
          serial = getSerialFromURL();
          if (!serial) {
            showStatus("No serial number provided in URL.", true);
            return;
          }
          document.getElementById("serial-number").textContent = serial;
          showStatus("Connecting to device...", false);

          client = mqtt.connect(hivemqBrokerUrl, {
            clientId: 'webClient-' + Math.random().toString(16).substr(2, 8),
            username: hivemqUsername,
            password: hivemqPassword,
            clean: true,
            connectTimeout: 4000,
            reconnectPeriod: 2000,
          });

          client.on('connect', function() {
            showStatus("Connected. Querying device...");
            const responseTopic = `a3/${serial}/serialResponse`;
            client.subscribe(responseTopic, function() {
              client.publish(`a3/${serial}/querySerial`, "mainQuery");
            });
            client.subscribe('a3/test/pump1');
            client.subscribe('a3/test/proxy1');
            client.subscribe('a3/test/proxy2');
            client.subscribe('a3/settingsReply');
            client.publish('a3/querySettings', serial);
            queryTimeout = setTimeout(() => {
              showStatus("No response from device. Please check connection and try again.", true);
            }, 10000);
          });

          client.on('message', function(topic, message) {
            if (topic === `a3/${serial}/serialResponse`) {
              try {
                const payload = JSON.parse(message.toString());
                if (payload.serial) {
                  document.getElementById("serial-number").textContent = payload.serial;
                }
                if (payload.version) {
                  document.getElementById("ver-string").textContent = payload.version;
                }
                showStatus("");
                clearTimeout(queryTimeout);
              } catch (e) {
                showStatus("Error parsing device response.", true);
              }
            }
            if (topic === 'a3/settingsReply') {
              applySettingsFromPayload(message.toString());
              showStatus("Settings loaded from device.");
            }
            if (topic === 'a3/test/pump1') {
              const btn = document.getElementById('pump1TestBtn');
              if (!btn) return;
              const payload = message.toString();
              if (payload === "running") {
                btn.classList.add('pump-on');
                btn.classList.remove('pump-off');
                btn.textContent = "ON/OFF";
              } else if (payload === "stopped") {
                btn.classList.remove('pump-on');
                btn.classList.add('pump-off');
                btn.textContent = "ON/OFF";
              }
            }
            if (topic === 'a3/test/proxy1') {
              const ind = document.getElementById('proxy1Indicator');
              if (!ind) return;
              const payload = message.toString();
              if (payload === "on") {
                ind.classList.add('proxy-on');
                ind.classList.remove('proxy-off');
                ind.textContent = "ON";
              } else if (payload === "off") {
                ind.classList.remove('proxy-on');
                ind.classList.add('proxy-off');
                ind.textContent = "OFF";
              }
            }
            if (topic === 'a3/test/proxy2') {
              const ind = document.getElementById('proxy2Indicator');
              if (!ind) return;
              const payload = message.toString();
              if (payload === "on") {
                ind.classList.add('proxy-on');
                ind.classList.remove('proxy-off');
                ind.textContent = "ON";
              } else if (payload === "off") {
                ind.classList.remove('proxy-on');
                ind.classList.add('proxy-off');
                ind.textContent = "OFF";
              }
            }
          });

          client.on('error', function() {
            showStatus("MQTT connection error.", true);
          });
        }

        document.getElementById("backBtn").onclick = function() {
          window.location.href = "index.html";
        };
        connectMQTTAndQuery();
      });
    </script>
  </body>
</html>