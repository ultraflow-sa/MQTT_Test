<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Pump Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tabs {
            display: flex;
            background-color: #e9ecef;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background-color: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .tab:hover {
            background-color: #dee2e6;
        }
        
        .tab.active {
            background-color: #007bff;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .button-group {
            margin-top: 20px;
            text-align: center;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .connection-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        
        .connection-status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .connection-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .section {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }
        
        .section h3 {
            margin-top: 0;
            color: #007bff;
        }
        
        .hidden {
            display: none !important;
        }
        
        .time-input {
            display: inline-block;
            width: auto;
            margin-right: 10px;
        }
        
        .inline-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .inline-group select,
        .inline-group input {
            flex: 1;
        }
        
        .device-info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .device-info h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .info-label {
            font-weight: bold;
        }
        
        .pump2-settings {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .pump2-settings.enabled {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="connection-status" id="connectionStatus">
            Connecting to device...
        </div>
        
        <div class="device-info" id="deviceInfo" style="display: none;">
            <h3>Device Information</h3>
            <div class="info-row">
                <span class="info-label">Serial Number:</span>
                <span id="deviceSerial">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Firmware Version:</span>
                <span id="deviceVersion">-</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('monitor')">Monitor</button>
            <button class="tab" onclick="showTab('settings')">Settings</button>
        </div>

        <div id="monitor" class="tab-content active">
            <h2>Pump Monitor</h2>
            <div class="status" id="status"></div>
            
            <div class="section">
                <h3>Pump 1 Status</h3>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span id="pump1Status">Unknown</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Mode:</span>
                    <span id="pump1Mode">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Current:</span>
                    <span id="pump1Current">- mA</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Runtime:</span>
                    <span id="pump1Runtime">-</span>
                </div>
            </div>
            
            <div class="section" id="pump2StatusSection">
                <h3>Pump 2 Status</h3>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span id="pump2Status">Unknown</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Mode:</span>
                    <span id="pump2Mode">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Current:</span>
                    <span id="pump2Current">- mA</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Runtime:</span>
                    <span id="pump2Runtime">-</span>
                </div>
            </div>
            
            <div class="button-group">
                <button onclick="sendCommand('start')">Start Pumps</button>
                <button onclick="sendCommand('stop')">Stop Pumps</button>
                <button onclick="sendCommand('status')">Refresh Status</button>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <h2>Pump Settings</h2>
            <div class="status" id="settingsStatus"></div>
            
            <div class="section">
                <h3>Pump 1 Settings</h3>
                
                <div class="form-group">
                    <label for="modeSelect">Pump Mode:</label>
                    <select id="modeSelect">
                        <option value="PLS">Pulse Mode</option>
                        <option value="CNT">Continuous Mode</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pauseTime">Pause Time (HH:MM:SS):</label>
                    <input type="text" id="pauseTime" placeholder="00:00:10" pattern="^([0-9]|[0-1][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$">
                </div>
                
                <div class="form-group">
                    <div class="inline-group">
                        <select id="timeCyclesSelect">
                            <option value="TIME">Run Time</option>
                            <option value="CYCLES">Cycles</option>
                        </select>
                        <input type="text" id="timeCyclesValue" placeholder="00:15 or number">
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="proxy1">
                    <label for="proxy1">Proxy 1 Enabled</label>
                </div>
                
                <div class="form-group" id="dwellTime1Group">
                    <label for="dwellTime1">Proxy 1 Dwell Time (seconds):</label>
                    <input type="number" id="dwellTime1" min="1" max="3600" value="10">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="proxy2">
                    <label for="proxy2">Proxy 2 Enabled</label>
                </div>
                
                <div class="form-group" id="dwellTime2Group">
                    <label for="dwellTime2">Proxy 2 Dwell Time (seconds):</label>
                    <input type="number" id="dwellTime2" min="1" max="3600" value="10">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="levelSense">
                    <label for="levelSense">Level Sensing Enabled</label>
                </div>
                
                <div class="form-group" id="levelSenseOptionsGroup">
                    <label for="levelSenseOptions">Level Sense Type:</label>
                    <select id="levelSenseOptions">
                        <option value="HEF">High = Empty, Float</option>
                        <option value="LEF">Low = Empty, Float</option>
                        <option value="HER">High = Empty, Reed</option>
                        <option value="LER">Low = Empty, Reed</option>
                    </select>
                </div>
                
                <div class="form-group" id="levelNoncGroup">
                    <label for="levelNonc">Level Normally Closed:</label>
                    <select id="levelNonc">
                        <option value="NO">No</option>
                        <option value="YES">Yes</option>
                    </select>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="blockageManual">
                    <label for="blockageManual">Manual Blockage Current</label>
                </div>
                
                <div class="form-group" id="blockageManualGroup">
                    <label for="blockageManualValue">Blockage Current (mA):</label>
                    <input type="number" id="blockageManualValue" min="100" max="5000" value="1000">
                </div>
            </div>
            
            <div class="section pump2-settings" id="pump2SettingsSection">
                <div class="checkbox-group">
                    <input type="checkbox" id="pump2">
                    <label for="pump2">Enable Pump 2</label>
                </div>
                
                <h3>Pump 2 Settings</h3>
                
                <div class="form-group">
                    <label for="pump2Mode">Pump Mode:</label>
                    <select id="pump2Mode">
                        <option value="PLS">Pulse Mode</option>
                        <option value="CNT">Continuous Mode</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pump2PauseTime">Pause Time (HH:MM:SS):</label>
                    <input type="text" id="pump2PauseTime" placeholder="00:00:10" pattern="^([0-9]|[0-1][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$">
                </div>
                
                <div class="form-group">
                    <div class="inline-group">
                        <select id="pump2TimeCyclesSelect">
                            <option value="TIME">Run Time</option>
                            <option value="CYCLES">Cycles</option>
                        </select>
                        <input type="text" id="pump2TimeCyclesValue" placeholder="00:15 or number">
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="pump2Proxy1">
                    <label for="pump2Proxy1">Proxy 1 Enabled</label>
                </div>
                
                <div class="form-group" id="pump2DwellTime1Group">
                    <label for="pump2DwellTime1">Proxy 1 Dwell Time (seconds):</label>
                    <input type="number" id="pump2DwellTime1" min="1" max="3600" value="10">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="pump2Proxy2">
                    <label for="pump2Proxy2">Proxy 2 Enabled</label>
                </div>
                
                <div class="form-group" id="pump2DwellTime2Group">
                    <label for="pump2DwellTime2">Proxy 2 Dwell Time (seconds):</label>
                    <input type="number" id="pump2DwellTime2" min="1" max="3600" value="10">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="pump2LevelSense">
                    <label for="pump2LevelSense">Level Sensing Enabled</label>
                </div>
                
                <div class="form-group" id="pump2LevelSenseOptionsGroup">
                    <label for="pump2LevelSenseOptions">Level Sense Type:</label>
                    <select id="pump2LevelSenseOptions">
                        <option value="HEF">High = Empty, Float</option>
                        <option value="LEF">Low = Empty, Float</option>
                        <option value="HER">High = Empty, Reed</option>
                        <option value="LER">Low = Empty, Reed</option>
                    </select>
                </div>
                
                <div class="form-group" id="pump2LevelNoncGroup">
                    <label for="pump2LevelNonc">Level Normally Closed:</label>
                    <select id="pump2LevelNonc">
                        <option value="NO">No</option>
                        <option value="YES">Yes</option>
                    </select>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="pump2BlockageManual">
                    <label for="pump2BlockageManual">Manual Blockage Current</label>
                </div>
                
                <div class="form-group" id="pump2BlockageManualGroup">
                    <label for="pump2BlockageManualValue">Blockage Current (mA):</label>
                    <input type="number" id="pump2BlockageManualValue" min="100" max="5000" value="1000">
                </div>
            </div>
            
            <div class="section">
                <h3>External Lamp Settings</h3>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="extLamp">
                    <label for="extLamp">External Lamp Enabled</label>
                </div>
                
                <div class="form-group" id="extLampOptionsGroup">
                    <label for="extLampOptions">Lamp Type:</label>
                    <select id="extLampOptions">
                        <option value="RGB">RGB LED</option>
                        <option value="MONO">Mono LED</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group">
                <button onclick="loadSettings()">Load from Device</button>
                <button onclick="saveSettings()">Save to Device</button>
                <button onclick="resetToDefaults()">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        let client;
        let deviceSerial = null;
        let isConnected = false;
        
        // Collected settings for proper batch processing
        let collectedSettings = {
            p1: null,
            p2: null,
            xtra: null
        };
        
        // Timer to batch process settings
        let settingsProcessingTimer = null;
        
        // Global flags to prevent duplicate processing
        window.isLoadingSettings = false;
        window.processingSettings = false;
        window.preloadingForSettingsTab = false;

        // Initialize MQTT connection
        function initMQTT() {
            console.log("Attempting to connect to MQTT broker...");
            
            try {
                client = mqtt.connect('ws://localhost:9001');
                
                client.on('connect', function () {
                    console.log('Connected to MQTT broker');
                    isConnected = true;
                    updateConnectionStatus(true);
                    
                    // Subscribe to all relevant topics
                    const topics = [
                        'a3/+/status',
                        'a3/+/serialResponse',
                        'a3/+/P1settingsReply',
                        'a3/+/P2settingsReply',
                        'a3/+/xtraSettingsReply',
                        'a3/+/settingsSaved'
                    ];
                    
                    topics.forEach(topic => {
                        client.subscribe(topic, function (err) {
                            if (err) {
                                console.error('Failed to subscribe to', topic, err);
                            } else {
                                console.log('Subscribed to', topic);
                            }
                        });
                    });
                    
                    // Request device information
                    requestDeviceInfo();
                });
                
                client.on('message', function (topic, message) {
                    console.log('MQTT message received:', topic, message.toString());
                    handleMQTTMessage(topic, message.toString());
                });
                
                client.on('error', function (error) {
                    console.error('MQTT connection error:', error);
                    isConnected = false;
                    updateConnectionStatus(false);
                });
                
                client.on('close', function () {
                    console.log('MQTT connection closed');
                    isConnected = false;
                    updateConnectionStatus(false);
                });
                
            } catch (error) {
                console.error('Failed to initialize MQTT:', error);
                updateConnectionStatus(false);
            }
        }

        function handleMQTTMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                const topicParts = topic.split('/');
                const messageType = topicParts[2];
                const serial = topicParts[1];
                
                // Set device serial if not already set
                if (!deviceSerial && serial && serial !== '+') {
                    deviceSerial = serial;
                    console.log('Device serial set to:', deviceSerial);
                }
                
                switch (messageType) {
                    case 'status':
                        updatePumpStatus(data);
                        break;
                    case 'serialResponse':
                        updateDeviceInfo(data);
                        break;
                    case 'P1settingsReply':
                        console.log('Received P1 settings:', data);
                        collectedSettings.p1 = message;
                        scheduleSettingsProcessing();
                        break;
                    case 'P2settingsReply':
                        console.log('Received P2 settings:', data);
                        collectedSettings.p2 = message;
                        scheduleSettingsProcessing();
                        break;
                    case 'xtraSettingsReply':
                        console.log('Received Xtra settings:', data);
                        collectedSettings.xtra = message;
                        scheduleSettingsProcessing();
                        break;
                    case 'settingsSaved':
                        showStatus('Settings saved successfully!');
                        break;
                    default:
                        console.log('Unknown message type:', messageType);
                }
            } catch (e) {
                console.error('Error parsing MQTT message:', e);
            }
        }

        function scheduleSettingsProcessing() {
            // Clear any existing timer
            if (settingsProcessingTimer) {
                clearTimeout(settingsProcessingTimer);
            }
            
            // Don't process if already processing
            if (window.processingSettings) {
                console.log("Already processing settings - ignoring schedule request");
                return;
            }
            
            console.log("Scheduling settings processing...");
            
            // Schedule processing after a delay to collect all parts
            settingsProcessingTimer = setTimeout(() => {
                // Check if we have at least some settings data
                if (collectedSettings.p1 || collectedSettings.p2 || collectedSettings.xtra) {
                    console.log('Processing collected settings:', collectedSettings);
                    applySettingsFromPayload(collectedSettings);
                    
                    // Reset collected settings
                    collectedSettings = {
                        p1: null,
                        p2: null, 
                        xtra: null
                    };
                }
                settingsProcessingTimer = null;
            }, 200); // Increased delay to 200ms to ensure all messages arrive
        }
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.textContent = 'Connected to device';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'Disconnected from device';
                statusEl.className = 'connection-status disconnected';
            }
        }

        function updateDeviceInfo(data) {
            if (data.serial) {
                document.getElementById('deviceSerial').textContent = data.serial;
                deviceSerial = data.serial;
            }
            if (data.version) {
                document.getElementById('deviceVersion').textContent = data.version;
            }
            document.getElementById('deviceInfo').style.display = 'block';
        }

        function updatePumpStatus(data) {
            // Update Pump 1 status
            if (data.pump1) {
                document.getElementById('pump1Status').textContent = data.pump1.status || 'Unknown';
                document.getElementById('pump1Mode').textContent = data.pump1.mode || '-';
                document.getElementById('pump1Current').textContent = (data.pump1.current || 0) + ' mA';
                document.getElementById('pump1Runtime').textContent = data.pump1.runtime || '-';
            }
            
            // Update Pump 2 status if available
            if (data.pump2) {
                document.getElementById('pump2Status').textContent = data.pump2.status || 'Unknown';
                document.getElementById('pump2Mode').textContent = data.pump2.mode || '-';
                document.getElementById('pump2Current').textContent = (data.pump2.current || 0) + ' mA';
                document.getElementById('pump2Runtime').textContent = data.pump2.runtime || '-';
                document.getElementById('pump2StatusSection').style.display = 'block';
            } else {
                document.getElementById('pump2StatusSection').style.display = 'none';
            }
        }

        function requestDeviceInfo() {
            if (isConnected && client) {
                console.log('Requesting device information...');
                client.publish('a3/broadcast/getSerial', '{}');
            }
        }

        function sendCommand(command) {
            if (!isConnected || !client || !deviceSerial) {
                showStatus('Not connected to device', true);
                return;
            }
            
            const topic = `a3/${deviceSerial}/command`;
            const message = JSON.stringify({ command: command });
            
            client.publish(topic, message);
            showStatus(`Command sent: ${command}`);
        }

        function showTab(tabName) {
            console.log(`${tabName} tab clicked`);
            
            // Handle settings tab preloading
            if (tabName === 'settings') {
                console.log('Settings tab clicked, preloading settings...');
                window.preloadingForSettingsTab = true;
                loadSettings();
            }
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Setup any tab-specific functionality
            if (tabName === 'settings') {
                setupSettingsTab();
            }
        }

        function setupSettingsTab() {
            console.log('Setting up settings tab...');
            
            // Setup show/hide functionality for checkboxes after tab is loaded
            setTimeout(() => {
                setupShowHideCheckbox('proxy1', ['dwellTime1Group']);
                setupShowHideCheckbox('proxy2', ['dwellTime2Group']);
                setupShowHideCheckbox('levelSense', ['levelSenseOptionsGroup', 'levelNoncGroup']);
                setupShowHideCheckbox('blockageManual', ['blockageManualGroup']);
                setupShowHideCheckbox('extLamp', ['extLampOptionsGroup']);
                
                // Pump 2 specific setup
                setupShowHideCheckbox('pump2Proxy1', ['pump2DwellTime1Group']);
                setupShowHideCheckbox('pump2Proxy2', ['pump2DwellTime2Group']);
                setupShowHideCheckbox('pump2LevelSense', ['pump2LevelSenseOptionsGroup', 'pump2LevelNoncGroup']);
                setupShowHideCheckbox('pump2BlockageManual', ['pump2BlockageManualGroup']);
                
                // Special handling for pump2 - controls entire pump2 settings visibility
                console.log('setupShowHideCheckbox called for pump2 after tab load');
                const pump2Checkbox = document.getElementById('pump2');
                if (pump2Checkbox) {
                    pump2Checkbox.addEventListener('change', function() {
                        console.log('Pump2 checkbox changed to:', this.checked);
                        if (window.isLoadingSettings) {
                            console.log('Ignoring pump2 change - loading settings');
                            return;
                        }
                        
                        const pump2Settings = document.getElementById('pump2SettingsSection');
                        if (this.checked) {
                            pump2Settings.classList.add('enabled');
                            console.log('Pump2 settings enabled');
                        } else {
                            pump2Settings.classList.remove('enabled');
                            console.log('Pump2 settings disabled');
                        }
                    });
                }
                
                console.log('Settings tab setup complete');
            }, 50);
        }

        function setupShowHideCheckbox(checkboxId, targetIds) {
            const checkbox = document.getElementById(checkboxId);
            if (!checkbox) {
                console.log(`Checkbox ${checkboxId} not found`);
                return;
            }
            
            function updateVisibility() {
                if (window.isLoadingSettings) {
                    console.log(`Ignoring ${checkboxId} change - loading settings`);
                    return;
                }
                
                console.log(`${checkboxId} changed to:`, checkbox.checked);
                targetIds.forEach(targetId => {
                    const target = document.getElementById(targetId);
                    if (target) {
                        if (checkbox.checked) {
                            target.classList.remove('hidden');
                        } else {
                            target.classList.add('hidden');
                        }
                    }
                });
            }
            
            checkbox.addEventListener('change', updateVisibility);
        }

        function showSettingsTabAfterLoad() {
            console.log('Settings loaded, showing settings tab');
            window.preloadingForSettingsTab = false;
            // Tab is already shown, just clear the flag
        }

        function loadSettings() {
            if (!isConnected || !client || !deviceSerial) {
                showStatus('Not connected to device', true);
                return;
            }
            
            console.log('Loading settings from device...');
            showStatus('Loading settings from device...');
            
            // Request all settings
            const topics = [
                `a3/${deviceSerial}/getP1settings`,
                `a3/${deviceSerial}/getP2settings`, 
                `a3/${deviceSerial}/getXtraSettings`
            ];
            
            topics.forEach(topic => {
                client.publish(topic, '{}');
            });
        }

        function applySettingsFromPayload(payloads) {
            console.log("applySettingsFromPayload called with:", payloads);
            
            // PREVENT DUPLICATES: Check if we're already processing settings
            if (window.processingSettings) {
                console.log("Settings already being processed - ignoring duplicate call");
                return;
            }
            
            // Set flag to prevent duplicates
            window.processingSettings = true;
            window.isLoadingSettings = true;
            
            try {
                const settingsP1 = payloads.p1 ? JSON.parse(payloads.p1) : {};
                const settingsP2 = payloads.p2 ? JSON.parse(payloads.p2) : {};
                const settingsXtra = payloads.xtra ? JSON.parse(payloads.xtra) : {};

                console.log("Parsed P1 settings:", settingsP1);
                console.log("Parsed P2 settings:", settingsP2);
                console.log("Parsed Xtra settings:", settingsXtra);

                // Apply P1 settings
                if (settingsP1.modeP1) {
                    document.getElementById('modeSelect').value = settingsP1.modeP1;
                    console.log("Set modeSelect to:", settingsP1.modeP1);
                }
                
                if (settingsP1.pauseTimeP1 !== undefined) {
                    document.getElementById('pauseTime').value = secondsToHMS(settingsP1.pauseTimeP1);
                    console.log("Set pauseTime to:", secondsToHMS(settingsP1.pauseTimeP1));
                }
                
                if (settingsP1.runModeP1) {
                    document.getElementById('timeCyclesSelect').value = settingsP1.runModeP1;
                    console.log("Set timeCyclesSelect to:", settingsP1.runModeP1);
                }
                
                if (settingsP1.timeCyclesP1 !== undefined) {
                    const timeCyclesValue = settingsP1.runModeP1 === 'TIME' ? 
                        secondsToMS(settingsP1.timeCyclesP1) : 
                        settingsP1.timeCyclesP1.toString();
                    document.getElementById('timeCyclesValue').value = timeCyclesValue;
                    console.log("Set timeCyclesValue to:", timeCyclesValue);
                }
                
                if (settingsP1.proxy1P1 !== undefined) {
                    const proxy1Checkbox = document.getElementById('proxy1');
                    const shouldBeChecked = settingsP1.proxy1P1 === "YES";
                    proxy1Checkbox.checked = shouldBeChecked;
                    console.log("Set proxy1 checkbox to:", shouldBeChecked, "actual value:", proxy1Checkbox.checked);
                }
                
                if (settingsP1.proxy2P1 !== undefined) {
                    const proxy2Checkbox = document.getElementById('proxy2');
                    const shouldBeChecked = settingsP1.proxy2P1 === "YES";
                    proxy2Checkbox.checked = shouldBeChecked;
                    console.log("Set proxy2 checkbox to:", shouldBeChecked, "actual value:", proxy2Checkbox.checked);
                }
                
                if (settingsP1.dwellTimeP1Px1 !== undefined) {
                    document.getElementById('dwellTime1').value = settingsP1.dwellTimeP1Px1.toString();
                    console.log("Set dwellTime1 to:", settingsP1.dwellTimeP1Px1.toString());
                }
                
                if (settingsP1.dwellTimeP1Px2 !== undefined) {
                    document.getElementById('dwellTime2').value = settingsP1.dwellTimeP1Px2.toString();
                    console.log("Set dwellTime2 to:", settingsP1.dwellTimeP1Px2.toString());
                }
                
                if (settingsP1.levelP1 !== undefined) {
                    const levelSenseCheckbox = document.getElementById('levelSense');
                    const shouldBeChecked = settingsP1.levelP1 === "YES";
                    levelSenseCheckbox.checked = shouldBeChecked;
                    console.log("Set levelSense checkbox to:", shouldBeChecked, "actual value:", levelSenseCheckbox.checked);
                }
                
                if (settingsP1.levelTypeP1) {
                    document.getElementById('levelSenseOptions').value = settingsP1.levelTypeP1;
                    console.log("Set levelSenseOptions to:", settingsP1.levelTypeP1);
                }
                
                if (settingsP1.levelNoncP1) {
                    document.getElementById('levelNonc').value = settingsP1.levelNoncP1;
                    console.log("Set levelNonc to:", settingsP1.levelNoncP1);
                }

                // Apply P2 settings
                if (settingsP2.pump2InUse !== undefined) {
                    const pump2Checkbox = document.getElementById('pump2');
                    const shouldBeChecked = settingsP2.pump2InUse === "YES";
                    pump2Checkbox.checked = shouldBeChecked;
                    console.log("Set pump2 checkbox to:", shouldBeChecked, "actual value:", pump2Checkbox.checked);
                }
                
                if (settingsP2.modeP2) {
                    document.getElementById('pump2Mode').value = settingsP2.modeP2;
                    console.log("Set pump2Mode to:", settingsP2.modeP2);
                }
                
                if (settingsP2.pauseTimeP2 !== undefined) {
                    document.getElementById('pump2PauseTime').value = secondsToHMS(settingsP2.pauseTimeP2);
                    console.log("Set pump2PauseTime to:", secondsToHMS(settingsP2.pauseTimeP2));
                }
                
                if (settingsP2.runModeP2) {
                    document.getElementById('pump2TimeCyclesSelect').value = settingsP2.runModeP2;
                    console.log("Set pump2TimeCyclesSelect to:", settingsP2.runModeP2);
                }
                
                if (settingsP2.timeCyclesP2 !== undefined) {
                    const pump2TimeCyclesValue = settingsP2.runModeP2 === 'TIME' ? 
                        secondsToMS(settingsP2.timeCyclesP2) : 
                        settingsP2.timeCyclesP2.toString();
                    document.getElementById('pump2TimeCyclesValue').value = pump2TimeCyclesValue;
                    console.log("Set pump2TimeCyclesValue to:", pump2TimeCyclesValue);
                }
                
                if (settingsP2.proxy1P2 !== undefined) {
                    const pump2Proxy1Checkbox = document.getElementById('pump2Proxy1');
                    const shouldBeChecked = settingsP2.proxy1P2 === "YES";
                    pump2Proxy1Checkbox.checked = shouldBeChecked;
                    console.log("Set pump2Proxy1 checkbox to:", shouldBeChecked, "actual value:", pump2Proxy1Checkbox.checked);
                }
                
                if (settingsP2.proxy2P2 !== undefined) {
                    const pump2Proxy2Checkbox = document.getElementById('pump2Proxy2');
                    const shouldBeChecked = settingsP2.proxy2P2 === "YES";
                    pump2Proxy2Checkbox.checked = shouldBeChecked;
                    console.log("Set pump2Proxy2 checkbox to:", shouldBeChecked, "actual value:", pump2Proxy2Checkbox.checked);
                }
                
                if (settingsP2.dwellTimeP2Px1 !== undefined) {
                    document.getElementById('pump2DwellTime1').value = settingsP2.dwellTimeP2Px1.toString();
                    console.log("Set pump2DwellTime1 to:", settingsP2.dwellTimeP2Px1.toString());
                }
                
                if (settingsP2.dwellTimeP2Px2 !== undefined) {
                    document.getElementById('pump2DwellTime2').value = settingsP2.dwellTimeP2Px2.toString();
                    console.log("Set pump2DwellTime2 to:", settingsP2.dwellTimeP2Px2.toString());
                }
                
                if (settingsP2.levelP2 !== undefined) {
                    const pump2LevelSenseCheckbox = document.getElementById('pump2LevelSense');
                    const shouldBeChecked = settingsP2.levelP2 === "YES";
                    pump2LevelSenseCheckbox.checked = shouldBeChecked;
                    console.log("Set pump2LevelSense checkbox to:", shouldBeChecked, "actual value:", pump2LevelSenseCheckbox.checked);
                }
                
                if (settingsP2.levelTypeP2) {
                    document.getElementById('pump2LevelSenseOptions').value = settingsP2.levelTypeP2;
                    console.log("Set pump2LevelSenseOptions to:", settingsP2.levelTypeP2);
                }
                
                if (settingsP2.levelNoncP2) {
                    document.getElementById('pump2LevelNonc').value = settingsP2.levelNoncP2;
                    console.log("Set pump2LevelNonc to:", settingsP2.levelNoncP2);
                }

                // Apply Xtra settings
                if (settingsXtra.extLampInUse !== undefined) {
                    const extLampCheckbox = document.getElementById('extLamp');
                    const shouldBeChecked = settingsXtra.extLampInUse === "YES";
                    extLampCheckbox.checked = shouldBeChecked;
                    console.log("Set extLamp checkbox to:", shouldBeChecked, "actual value:", extLampCheckbox.checked);
                }
                
                if (settingsXtra.extLampType) {
                    document.getElementById('extLampOptions').value = settingsXtra.extLampType;
                    console.log("Set extLampOptions to:", settingsXtra.extLampType);
                }
                
                if (settingsXtra.blockCurrentP1 !== undefined) {
                    document.getElementById('blockageManualValue').value = settingsXtra.blockCurrentP1.toString();
                    document.getElementById('blockageManual').checked = true;
                    console.log("Set blockageManualValue to:", settingsXtra.blockCurrentP1.toString());
                }
                
                if (settingsXtra.blockCurrentP2 !== undefined) {
                    document.getElementById('pump2BlockageManualValue').value = settingsXtra.blockCurrentP2.toString();
                    document.getElementById('pump2BlockageManual').checked = true;
                    console.log("Set pump2BlockageManualValue to:", settingsXtra.blockCurrentP2.toString());
                }

                // Apply visibility logic AFTER settings are loaded
                setTimeout(() => {
                    console.log("Applying visibility logic only...");
                    applyVisibilityOnlyForLoadedSettings();
                    
                    const pump2Enabled = document.getElementById('pump2').checked;
                    console.log("Pump2 enabled after settings load:", pump2Enabled);
                    
                    if (pump2Enabled) {
                        console.log("Triggering pump2 change event to apply visibility");
                        document.getElementById('pump2').dispatchEvent(new Event('change'));
                    } else {
                        console.log("Pump2 disabled - skipping change event trigger");
                    }
                    
                    // Clear ALL flags
                    window.isLoadingSettings = false;
                    window.processingSettings = false;
                    
                    console.log("Settings loading complete, flags cleared");
                }, 50);

                showStatus("Settings loaded from device.");

            } catch (e) {
                // Clear flags on error
                window.isLoadingSettings = false;
                window.processingSettings = false;
                console.error("applySettingsFromPayload error:", e);
                showStatus("Failed to parse settings from device.", true);
            }

            // Check if we need to show settings tab after pre-loading
            if (window.preloadingForSettingsTab) {
                showSettingsTabAfterLoad();
            }
        }

        function applyVisibilityOnlyForLoadedSettings() {
            console.log("applyVisibilityOnlyForLoadedSettings: Starting visibility application");
            
            // Apply visibility for all checkboxes based on their current state
            const checkboxMappings = [
                { id: 'proxy1', targets: ['dwellTime1Group'] },
                { id: 'proxy2', targets: ['dwellTime2Group'] },
                { id: 'levelSense', targets: ['levelSenseOptionsGroup', 'levelNoncGroup'] },
                { id: 'blockageManual', targets: ['blockageManualGroup'] },
                { id: 'extLamp', targets: ['extLampOptionsGroup'] },
                { id: 'pump2Proxy1', targets: ['pump2DwellTime1Group'] },
                { id: 'pump2Proxy2', targets: ['pump2DwellTime2Group'] },
                { id: 'pump2LevelSense', targets: ['pump2LevelSenseOptionsGroup', 'pump2LevelNoncGroup'] },
                { id: 'pump2BlockageManual', targets: ['pump2BlockageManualGroup'] }
            ];
            
            checkboxMappings.forEach(mapping => {
                const checkbox = document.getElementById(mapping.id);
                if (checkbox) {
                    console.log(`Applying visibility for ${mapping.id}: ${checkbox.checked}`);
                    mapping.targets.forEach(targetId => {
                        const target = document.getElementById(targetId);
                        if (target) {
                            if (checkbox.checked) {
                                target.classList.remove('hidden');
                            } else {
                                target.classList.add('hidden');
                            }
                        }
                    });
                }
            });
            
            // Special handling for pump2 settings
            const pump2Checkbox = document.getElementById('pump2');
            const pump2Settings = document.getElementById('pump2SettingsSection');
            if (pump2Checkbox && pump2Settings) {
                if (pump2Checkbox.checked) {
                    pump2Settings.classList.add('enabled');
                    console.log("applyVisibilityOnlyForLoadedSettings: Set pump2 settings visibility to: enabled");
                } else {
                    pump2Settings.classList.remove('enabled');
                    console.log("applyVisibilityOnlyForLoadedSettings: Set pump2 settings visibility to: hidden");
                }
            }
            
            console.log("Visibility applied based on loaded settings");
        }

        // Add this function to handle the Save Settings button
        function saveSettings() {
            if (!isConnected || !client || !deviceSerial) {
                showStatus('Not connected to device', true);
                return;
            }
            
            console.log('Validating and saving settings...');
            
            // Validate all visible fields
            if (!validateAllFields()) {
                return;
            }
            
            // Compile settings
            const p1Settings = compileP1Settings();
            const p2Settings = compileP2Settings();
            const xtraSettings = compileXtraSettings();
            
            console.log('Compiled P1 settings:', p1Settings);
            console.log('Compiled P2 settings:', p2Settings);
            console.log('Compiled Xtra settings:', xtraSettings);
            
            // Send settings to device
            const topics = [
                { topic: `a3/${deviceSerial}/setP1settings`, payload: p1Settings },
                { topic: `a3/${deviceSerial}/setP2settings`, payload: p2Settings },
                { topic: `a3/${deviceSerial}/setXtraSettings`, payload: xtraSettings }
            ];
            
            topics.forEach(({ topic, payload }) => {
                client.publish(topic, JSON.stringify(payload));
            });
            
            showStatus('Settings sent to device...');
        }

        // Validate all visible fields
        function validateAllFields() {
            let isValid = true;
            const errors = [];
            
            // Validate time format fields
            const timeFields = [
                { id: 'pauseTime', name: 'Pause Time' },
                { id: 'pump2PauseTime', name: 'Pump 2 Pause Time' }
            ];
            
            timeFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element && !element.closest('.hidden')) {
                    if (!validateTimeFormat(element.value)) {
                        errors.push(`${field.name} must be in HH:MM:SS format`);
                        element.style.borderColor = 'red';
                        isValid = false;
                    } else {
                        element.style.borderColor = '';
                    }
                }
            });
            
            // Validate time/cycles fields
            const timeCyclesFields = [
                { id: 'timeCyclesValue', selectId: 'timeCyclesSelect', name: 'Run Time/Cycles' },
                { id: 'pump2TimeCyclesValue', selectId: 'pump2TimeCyclesSelect', name: 'Pump 2 Run Time/Cycles' }
            ];
            
            timeCyclesFields.forEach(field => {
                const element = document.getElementById(field.id);
                const selectElement = document.getElementById(field.selectId);
                if (element && selectElement && !element.closest('.hidden')) {
                    const isTimeMode = selectElement.value === 'TIME';
                    const value = element.value.trim();
                    
                    if (isTimeMode) {
                        if (!validateTimeFormatMS(value)) {
                            errors.push(`${field.name} must be in MM:SS format when in TIME mode`);
                            element.style.borderColor = 'red';
                            isValid = false;
                        } else {
                            element.style.borderColor = '';
                        }
                    } else {
                        const numValue = parseInt(value);
                        if (isNaN(numValue) || numValue < 1 || numValue > 999) {
                            errors.push(`${field.name} must be a number between 1 and 999 when in CYCLES mode`);
                            element.style.borderColor = 'red';
                            isValid = false;
                        } else {
                            element.style.borderColor = '';
                        }
                    }
                }
            });
            
            // Validate number fields
            const numberFields = [
                { id: 'dwellTime1', min: 1, max: 3600, name: 'Dwell Time 1' },
                { id: 'dwellTime2', min: 1, max: 3600, name: 'Dwell Time 2' },
                { id: 'pump2DwellTime1', min: 1, max: 3600, name: 'Pump 2 Dwell Time 1' },
                { id: 'pump2DwellTime2', min: 1, max: 3600, name: 'Pump 2 Dwell Time 2' },
                { id: 'blockageManualValue', min: 100, max: 5000, name: 'Blockage Current' },
                { id: 'pump2BlockageManualValue', min: 100, max: 5000, name: 'Pump 2 Blockage Current' }
            ];
            
            numberFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element && !element.closest('.hidden')) {
                    const value = parseInt(element.value);
                    if (isNaN(value) || value < field.min || value > field.max) {
                        errors.push(`${field.name} must be between ${field.min} and ${field.max}`);
                        element.style.borderColor = 'red';
                        isValid = false;
                    } else {
                        element.style.borderColor = '';
                    }
                }
            });
            
            if (!isValid) {
                showStatus('Validation errors: ' + errors.join(', '), true);
            }
            
            return isValid;
        }

        // Compile P1 settings in the same format as received from ESP32
        function compileP1Settings() {
            return {
                modeP1: document.getElementById('modeSelect').value,
                runModeP1: document.getElementById('timeCyclesSelect').value,
                pauseTimeP1: hmsToSeconds(document.getElementById('pauseTime').value),
                timeCyclesP1: document.getElementById('timeCyclesSelect').value === 'TIME' ? 
                    msToSeconds(document.getElementById('timeCyclesValue').value) : 
                    parseInt(document.getElementById('timeCyclesValue').value),
                proxy1P1: document.getElementById('proxy1').checked ? "YES" : "NO",
                dwellTimeP1Px1: parseInt(document.getElementById('dwellTime1').value) || 10,
                proxy2P1: document.getElementById('proxy2').checked ? "YES" : "NO", 
                dwellTimeP1Px2: parseInt(document.getElementById('dwellTime2').value) || 10,
                levelP1: document.getElementById('levelSense').checked ? "YES" : "NO",
                levelTypeP1: document.getElementById('levelSenseOptions').value,
                levelNoncP1: document.getElementById('levelNonc').value
            };
        }

        function compileP2Settings() {
            return {
                pump2InUse: document.getElementById('pump2').checked ? "YES" : "NO",
                modeP2: document.getElementById('pump2Mode').value,
                runModeP2: document.getElementById('pump2TimeCyclesSelect').value,
                pauseTimeP2: hmsToSeconds(document.getElementById('pump2PauseTime').value),
                timeCyclesP2: document.getElementById('pump2TimeCyclesSelect').value === 'TIME' ? 
                    msToSeconds(document.getElementById('pump2TimeCyclesValue').value) : 
                    parseInt(document.getElementById('pump2TimeCyclesValue').value),
                proxy1P2: document.getElementById('pump2Proxy1').checked ? "YES" : "NO",
                dwellTimeP2Px1: parseInt(document.getElementById('pump2DwellTime1').value) || 10,
                proxy2P2: document.getElementById('pump2Proxy2').checked ? "YES" : "NO",
                dwellTimeP2Px2: parseInt(document.getElementById('pump2DwellTime2').value) || 10,
                levelP2: document.getElementById('pump2LevelSense').checked ? "YES" : "NO",
                levelTypeP2: document.getElementById('pump2LevelSenseOptions').value,
                levelNoncP2: document.getElementById('pump2LevelNonc').value
            };
        }

        function compileXtraSettings() {
            return {
                extLampInUse: document.getElementById('extLamp').checked ? "YES" : "NO",
                extLampType: document.getElementById('extLampOptions').value,
                blockCurrentP1: parseInt(document.getElementById('blockageManualValue').value) || 1000,
                blockCurrentP2: parseInt(document.getElementById('pump2BlockageManualValue').value) || 1000
            };
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults?')) {
                // Set default values
                document.getElementById('modeSelect').value = 'PLS';
                document.getElementById('pauseTime').value = '00:00:10';
                document.getElementById('timeCyclesSelect').value = 'TIME';
                document.getElementById('timeCyclesValue').value = '00:15';
                document.getElementById('proxy1').checked = false;
                document.getElementById('proxy2').checked = false;
                document.getElementById('dwellTime1').value = '10';
                document.getElementById('dwellTime2').value = '10';
                document.getElementById('levelSense').checked = false;
                document.getElementById('levelSenseOptions').value = 'HEF';
                document.getElementById('levelNonc').value = 'NO';
                document.getElementById('blockageManual').checked = false;
                document.getElementById('blockageManualValue').value = '1000';
                
                // Pump 2 defaults
                document.getElementById('pump2').checked = false;
                document.getElementById('pump2Mode').value = 'PLS';
                document.getElementById('pump2PauseTime').value = '00:00:10';
                document.getElementById('pump2TimeCyclesSelect').value = 'TIME';
                document.getElementById('pump2TimeCyclesValue').value = '00:05';
                document.getElementById('pump2Proxy1').checked = false;
                document.getElementById('pump2Proxy2').checked = false;
                document.getElementById('pump2DwellTime1').value = '10';
                document.getElementById('pump2DwellTime2').value = '10';
                document.getElementById('pump2LevelSense').checked = false;
                document.getElementById('pump2LevelSenseOptions').value = 'HEF';
                document.getElementById('pump2LevelNonc').value = 'NO';
                document.getElementById('pump2BlockageManual').checked = false;
                document.getElementById('pump2BlockageManualValue').value = '1000';
                
                // External lamp defaults
                document.getElementById('extLamp').checked = false;
                document.getElementById('extLampOptions').value = 'RGB';
                
                // Apply visibility
                applyVisibilityOnlyForLoadedSettings();
                
                showStatus('Settings reset to defaults');
            }
        }

        // Time conversion utilities
        function secondsToHMS(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function hmsToSeconds(hms) {
            if (!hms || typeof hms !== 'string') return 10;
            const parts = hms.split(':');
            if (parts.length !== 3) return 10;
            return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
        }

        function secondsToMS(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function msToSeconds(ms) {
            if (!ms || typeof ms !== 'string') return 15;
            const parts = ms.split(':');
            if (parts.length !== 2) return 15;
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }

        function validateTimeFormat(time) {
            const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;
            return timeRegex.test(time);
        }

        function validateTimeFormatMS(time) {
            const timeRegex = /^[0-5]?[0-9]:[0-5][0-9]$/;
            return timeRegex.test(time);
        }

        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            const settingsStatusEl = document.getElementById('settingsStatus');
            
            const targetEl = settingsStatusEl.offsetParent ? settingsStatusEl : statusEl;
            
            targetEl.textContent = message;
            targetEl.className = isError ? 'status error' : 'status success';
            targetEl.style.display = 'block';
            
            setTimeout(() => {
                targetEl.style.display = 'none';
            }, 3000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing MQTT...');
            initMQTT();
        });
    </script>
</body>
</html>