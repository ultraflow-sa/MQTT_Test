<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A3 Setup</title>
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/style.css?v=' + new Date().getTime();
      document.head.appendChild(link);
    </script>
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
  </head>
  <body>
    <div class="header-box">
      <h1>A3 Setup</h1>
    </div>
    <div class="content main-content">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" id="tabMainBtn" type="button">Main</button>
        <button class="tab-btn" id="tabLiveBtn" type="button">Live</button>
        <button class="tab-btn" id="tabSettingsBtn" type="button">Settings</button>
        <button class="tab-btn" id="tabWiFiBtn" type="button">WiFi</button>
      </div>
      <!-- Tab Contents -->
      <div class="tab-content active" id="tabMain">
        <div class="info-row">
          <div>
            Serial: <span id="serial-number" class="info-value">...</span>
          </div>
          <div>
            Version: <span id="ver-string" class="info-value">...</span>
          </div>
        </div>
        <div id="status-message" class="status-message"></div>
        <div class="btn-row">
          <button class="btn" id="backBtn">CHANGE</button>
        </div>
      </div>
      <div class="tab-content" id="tabLive">
        <div style="margin: 40px 0 20px 0; text-align: center;">
          <strong>Live tab content goes here.</strong>
        </div>
      </div>
      <div class="tab-content" id="tabSettings">
        <form id="settingsForm" autocomplete="off">
          <div class="settings-group" id="settingsFields">
            <!-- Mode -->
            <div class="settings-row">
              <label for="modeSelect"><strong>Mode</strong></label>
              <select id="modeSelect" name="mode">
                <option value="PLS">PLS</option>
                <option value="SLS">SLS</option>
              </select>
            </div>
            <!-- Pause Time -->
            <div class="settings-row">
              <label for="pauseTime"><strong>Pause Time</strong></label>
              <input type="text" id="pauseTime" name="pauseTime" placeholder="Enter pause time">
            </div>
            <!-- Time/Cycles -->
            <div class="settings-row">
              <label for="timeCyclesSelect"><strong>Time/Cycles</strong></label>
              <select id="timeCyclesSelect" name="timeCycles">
                <option value="Time">Time</option>
                <option value="Cycles">Cycles</option>
              </select>
            </div>
            <!-- Time/Cycles Value -->
            <div class="settings-row" id="timeCyclesValueRow">
              <label for="timeCyclesValue" id="timeCyclesValueLabel"><strong>Value</strong></label>
              <input type="text" id="timeCyclesValue" name="timeCyclesValue" placeholder="Enter Pump ON time">
            </div>
            <!-- Proxy1 -->
            <div class="settings-row">
              <label for="proxy1"><strong>Proxy1</strong></label>
              <input type="checkbox" id="proxy1" name="proxy1">
            </div>
            <!-- Dwell Time (Proxy1) -->
            <div class="settings-row" id="dwellTime1Row">
              <label for="dwellTime1"><strong>Dwell Time</strong></label>
              <input type="text" id="dwellTime1" name="dwellTime1" placeholder="Enter dwell time">
            </div>
            <!-- Proxy2 -->
            <div class="settings-row">
              <label for="proxy2"><strong>Proxy2</strong></label>
              <input type="checkbox" id="proxy2" name="proxy2">
            </div>
            <div class="settings-row" id="dwellTime2Row" style="display:none;">
              <label for="dwellTime2"><strong>Dwell Time Proxy2</strong></label>
              <input type="text" id="dwellTime2" name="dwellTime2" placeholder="Enter dwell time for Proxy2">
            </div>
            <!-- Level Sense -->
            <div class="settings-row">
              <label for="levelSense"><strong>Level Sense</strong></label>
              <input type="checkbox" id="levelSense" name="levelSense">
            </div>
            <div class="settings-row" id="levelSenseOptionsRow" style="display:none;">
              <label for="levelSenseOptions"><strong>Level Sense Mode</strong></label>
              <select id="levelSenseOptions" name="levelSenseOptions">
                <option value="Hall Sense">Hall Sense</option>
                <option value="Pulse Empty">Pulse Empty</option>
                <option value="Pulse Full">Pulse Full</option>
                <option value="Steady">Steady</option>
              </select>
            </div>
            <!-- Ext Lamp -->
            <div class="settings-row">
              <label for="extLamp"><strong>Ext Lamp</strong></label>
              <input type="checkbox" id="extLamp" name="extLamp">
            </div>
            <div class="settings-row" id="extLampOptionsRow" style="display:none;">
              <label for="extLampOptions"><strong>Lamp Mode</strong></label>
              <select id="extLampOptions" name="extLampOptions">
                <option value="RGB">RGB</option>
                <option value="Steady">Steady</option>
                <option value="Flash">Flash</option>
              </select>
            </div>
            <!-- Blockage Current -->
            <div class="settings-row">
              <label><strong>Blockage Current</strong></label>
              <input type="checkbox" id="blockageManual" name="blockageManual">
              <span style="margin-right:8px;">Manual</span>
              <input type="checkbox" id="blockageAuto" name="blockageAuto">
              <span>Auto</span>
            </div>
            <div class="settings-row" id="blockageManualRow" style="display:none;">
              <label for="blockageManualValue"><strong>Manual Current</strong></label>
              <input type="text" id="blockageManualValue" name="blockageManualValue" placeholder="Enter motor current">
            </div>
            <div class="settings-row" id="blockageAutoRow" style="display:none;">
              <label for="blockageAutoValue"><strong>Pump Starting</strong></label>
              <input type="text" id="blockageAutoValue" name="blockageAutoValue" placeholder="Pump Starting" disabled>
            </div>
            <!-- Pump2 -->
            <div class="settings-row">
              <label for="pump2"><strong>Pump2</strong></label>
              <input type="checkbox" id="pump2" name="pump2">
            </div>
            <div id="pump2SettingsGroup" style="display:none;">
              <div class="settings-row">
                <label for="pump2Mode"><strong>Mode</strong></label>
                <select id="pump2Mode" name="pump2Mode">
                  <option value="PLS">PLS</option>
                  <option value="SLS">SLS</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2PauseTime"><strong>Pause Time</strong></label>
                <input type="text" id="pump2PauseTime" name="pump2PauseTime" placeholder="Enter pause time">
              </div>
              <div class="settings-row">
                <label for="pump2TimeCyclesSelect"><strong>Time/Cycles</strong></label>
                <select id="pump2TimeCyclesSelect" name="pump2TimeCycles">
                  <option value="Time">Time</option>
                  <option value="Cycles">Cycles</option>
                </select>
              </div>
              <div class="settings-row" id="pump2TimeCyclesValueRow">
                <label for="pump2TimeCyclesValue" id="pump2TimeCyclesValueLabel"><strong>Value</strong></label>
                <input type="text" id="pump2TimeCyclesValue" name="pump2TimeCyclesValue" placeholder="Enter Pump ON time">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy1"><strong>Proxy1</strong></label>
                <input type="checkbox" id="pump2Proxy1" name="pump2Proxy1">
              </div>
              <div class="settings-row" id="pump2DwellTime1Row">
                <label for="pump2DwellTime1"><strong>Dwell Time</strong></label>
                <input type="text" id="pump2DwellTime1" name="pump2DwellTime1" placeholder="Enter dwell time">
              </div>
              <div class="settings-row">
                <label for="pump2Proxy2"><strong>Proxy2</strong></label>
                <input type="checkbox" id="pump2Proxy2" name="pump2Proxy2">
              </div>
              <div class="settings-row" id="pump2DwellTime2Row" style="display:none;">
                <label for="pump2DwellTime2"><strong>Dwell Time Proxy2</strong></label>
                <input type="text" id="pump2DwellTime2" name="pump2DwellTime2" placeholder="Enter dwell time for Proxy2">
              </div>
              <div class="settings-row">
                <label for="pump2LevelSense"><strong>Level Sense</strong></label>
                <input type="checkbox" id="pump2LevelSense" name="pump2LevelSense">
              </div>
              <div class="settings-row" id="pump2LevelSenseOptionsRow" style="display:none;">
                <label for="pump2LevelSenseOptions"><strong>Level Sense Mode</strong></label>
                <select id="pump2LevelSenseOptions" name="pump2LevelSenseOptions">
                  <option value="Hall Sense">Hall Sense</option>
                  <option value="Pulse Empty">Pulse Empty</option>
                  <option value="Pulse Full">Pulse Full</option>
                  <option value="Steady">Steady</option>
                </select>
              </div>
              <div class="settings-row">
                <label for="pump2ExtLamp"><strong>Ext Lamp</strong></label>
                <input type="checkbox" id="pump2ExtLamp" name="pump2ExtLamp">
              </div>
              <div class="settings-row" id="pump2ExtLampOptionsRow" style="display:none;">
                <label for="pump2ExtLampOptions"><strong>Lamp Mode</strong></label>
                <select id="pump2ExtLampOptions" name="pump2ExtLampOptions">
                  <option value="RGB">RGB</option>
                  <option value="Steady">Steady</option>
                  <option value="Flash">Flash</option>
                </select>
              </div>
              <div class="settings-row">
                <label><strong>Blockage Current</strong></label>
                <input type="checkbox" id="pump2BlockageManual" name="pump2BlockageManual">
                <span style="margin-right:8px;">Manual</span>
                <input type="checkbox" id="pump2BlockageAuto" name="pump2BlockageAuto">
                <span>Auto</span>
              </div>
              <div class="settings-row" id="pump2BlockageManualRow" style="display:none;">
                <label for="pump2BlockageManualValue"><strong>Manual Current</strong></label>
                <input type="text" id="pump2BlockageManualValue" name="pump2BlockageManualValue" placeholder="Enter motor current">
              </div>
              <div class="settings-row" id="pump2BlockageAutoRow" style="display:none;">
                <label for="pump2BlockageAutoValue"><strong>Pump Starting</strong></label>
                <input type="text" id="pump2BlockageAutoValue" name="pump2BlockageAutoValue" placeholder="Pump Starting" disabled>
              </div>
            </div>
          </div>
          <div class="btn-row" id="testModeBtnRow" style="margin-bottom:10px;">
            <button type="button" class="btn" id="testModeBtn">Test</button>
            <button type="submit" class="btn" id="saveSettingsBtn">Save Settings</button>
          </div>
        </form>
        <!-- Test Mode UI (hidden by default) -->
        <div id="testModePanel" style="display:none;">
          <div class="testmode-panel-container">
            <div class="testmode-row">
              <span class="testmode-label">Pump1</span>
              <button type="button" class="btn testmode-pump-btn pump-off" id="pump1TestBtn">ON/OFF</button>
            </div>
            <div class="testmode-row" id="proxy1Row" style="display:none;">
              <span class="testmode-label">Proxy1</span>
              <span class="testmode-indicator proxy-off" id="proxy1Indicator">OFF</span>
            </div>
            <div class="testmode-row" id="proxy2Row" style="display:none;">
              <span class="testmode-label">Proxy2</span>
              <span class="testmode-indicator proxy-off" id="proxy2Indicator">OFF</span>
            </div>
          </div>
          <div class="btn-row" style="margin-top:24px;">
            <button type="button" class="btn" id="testModeBackBtn">Back</button>
            <button type="submit" class="btn" id="testModeSaveBtn">Save Settings</button>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tabWiFi">
        <form id="wifiFormMain" autocomplete="off">
          <div class="fields-flex">
            <div class="input-group">
              <label for="ssid-main">WiFi Name:</label>
              <input type="text" id="ssid-main" name="ssid" required>
            </div>
            <div class="input-group">
              <label for="password-main">WiFi Password:</label>
              <input type="password" id="password-main" name="password" required>
            </div>
          </div>
          <div class="btn-row">
            <button type="submit" class="btn">SAVE</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      // Tab switching logic
      const tabMainBtn = document.getElementById('tabMainBtn');
      const tabLiveBtn = document.getElementById('tabLiveBtn');
      const tabSettingsBtn = document.getElementById('tabSettingsBtn');
      const tabWiFiBtn = document.getElementById('tabWiFiBtn');
      const tabMain = document.getElementById('tabMain');
      const tabLive = document.getElementById('tabLive');
      const tabSettings = document.getElementById('tabSettings');
      const tabWiFi = document.getElementById('tabWiFi');

      tabMainBtn.onclick = function() {
        tabMainBtn.classList.add('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabMain.classList.add('active');
        tabLive.classList.remove('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
      };
      tabLiveBtn.onclick = function() {
        tabLiveBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabLive.classList.add('active');
        tabMain.classList.remove('active');
        tabSettings.classList.remove('active');
        tabWiFi.classList.remove('active');
      }; 
      tabSettingsBtn.onclick = function() {
        tabSettingsBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabLiveBtn.classList.remove('active');
        tabWiFiBtn.classList.remove('active');
        tabSettings.classList.add('active');
        tabMain.classList.remove('active');
        tabLive.classList.remove('active');
        tabWiFi.classList.remove('active');
      };
      tabWiFiBtn.onclick = function() {
        tabWiFiBtn.classList.add('active');
        tabMainBtn.classList.remove('active');
        tabLiveBtn.classList.remove('active');
        tabSettingsBtn.classList.remove('active');
        tabWiFi.classList.add('active');
        tabMain.classList.remove('active');
        tabLive.classList.remove('active');
        tabSettings.classList.remove('active');
      };

      // Settings logic
      const timeCyclesSelect = document.getElementById('timeCyclesSelect');
      const timeCyclesValue = document.getElementById('timeCyclesValue');
      const proxy1 = document.getElementById('proxy1');
      const dwellTime1Row = document.getElementById('dwellTime1Row');
      const proxy2 = document.getElementById('proxy2');
      const dwellTime2Row = document.getElementById('dwellTime2Row');
      const levelSense = document.getElementById('levelSense');
      const levelSenseOptionsRow = document.getElementById('levelSenseOptionsRow');
      const extLamp = document.getElementById('extLamp');
      const extLampOptionsRow = document.getElementById('extLampOptionsRow');
      const blockageManual = document.getElementById('blockageManual');
      const blockageAuto = document.getElementById('blockageAuto');
      const blockageManualRow = document.getElementById('blockageManualRow');
      const blockageAutoRow = document.getElementById('blockageAutoRow');
      const pump2 = document.getElementById('pump2');
      const pump2SettingsGroup = document.getElementById('pump2SettingsGroup');
      const testModeBtn = document.getElementById('testModeBtn');
      const tabTestModeContent = document.getElementById('tabTestMode');
      const tabSettingsContent = document.getElementById('tabSettings');
      const testModeSummary = document.getElementById('testModeSummary');

      // Proxy1 logic: auto-select if Cycles is selected, and show/hide dwell time
      timeCyclesSelect.addEventListener('change', function() {
        if (this.value === "Cycles") {
          proxy1.checked = true;
          proxy1.disabled = true;
          timeCyclesValue.placeholder = "Enter Pump ON Cycles";
        } else {
          proxy1.checked = false;
          proxy1.disabled = false;
          timeCyclesValue.placeholder = "Enter Pump ON time";
        }
        updateDwellTime1();
      });

      proxy1.addEventListener('change', updateDwellTime1);

      function updateDwellTime1() {
        dwellTime1Row.style.display = proxy1.checked ? '' : 'none';
      }
      updateDwellTime1();

      // Proxy2 logic: show/hide dwell time for Proxy2
      proxy2.addEventListener('change', function() {
        dwellTime2Row.style.display = proxy2.checked ? '' : 'none';
      });

      // Level Sense logic: show/hide level sense options
      levelSense.addEventListener('change', function() {
        levelSenseOptionsRow.style.display = this.checked ? '' : 'none';
      });

      // Ext Lamp logic: show/hide lamp options
      extLamp.addEventListener('change', function() {
        extLampOptionsRow.style.display = this.checked ? '' : 'none';
      });

      // Blockage Current logic: show/hide manual/auto fields
      blockageManual.addEventListener('change', function() {
        if (blockageManual.checked) {
          blockageAuto.checked = false;
          blockageManualRow.style.display = '';
          blockageAutoRow.style.display = 'none';
        } else {
          blockageManualRow.style.display = 'none';
        }
      });
      blockageAuto.addEventListener('change', function() {
        if (blockageAuto.checked) {
          blockageManual.checked = false;
          blockageAutoRow.style.display = '';
          blockageManualRow.style.display = 'none';
        } else {
          blockageAutoRow.style.display = 'none';
        }
      });

      // Pump2 logic: show/hide pump2 settings group
      pump2.addEventListener('change', function() {
        pump2SettingsGroup.style.display = this.checked ? '' : 'none';
      });

      // Pump2 sub-settings logic
      const pump2TimeCyclesSelect = document.getElementById('pump2TimeCyclesSelect');
      const pump2TimeCyclesValue = document.getElementById('pump2TimeCyclesValue');
      const pump2Proxy1 = document.getElementById('pump2Proxy1');
      const pump2DwellTime1Row = document.getElementById('pump2DwellTime1Row');
      const pump2Proxy2 = document.getElementById('pump2Proxy2');
      const pump2DwellTime2Row = document.getElementById('pump2DwellTime2Row');
      const pump2LevelSense = document.getElementById('pump2LevelSense');
      const pump2LevelSenseOptionsRow = document.getElementById('pump2LevelSenseOptionsRow');
      const pump2ExtLamp = document.getElementById('pump2ExtLamp');
      const pump2ExtLampOptionsRow = document.getElementById('pump2ExtLampOptionsRow');
      const pump2BlockageManual = document.getElementById('pump2BlockageManual');
      const pump2BlockageAuto = document.getElementById('pump2BlockageAuto');
      const pump2BlockageManualRow = document.getElementById('pump2BlockageManualRow');
      const pump2BlockageAutoRow = document.getElementById('pump2BlockageAutoRow');

      pump2TimeCyclesSelect.addEventListener('change', function() {
        if (this.value === "Cycles") {
          pump2Proxy1.checked = true;
          pump2Proxy1.disabled = true;
          pump2TimeCyclesValue.placeholder = "Enter Pump ON Cycles";
        } else {
          pump2Proxy1.checked = false;
          pump2Proxy1.disabled = false;
          pump2TimeCyclesValue.placeholder = "Enter Pump ON time";
        }
        updatePump2DwellTime1();
      });

      pump2Proxy1.addEventListener('change', updatePump2DwellTime1);

      function updatePump2DwellTime1() {
        pump2DwellTime1Row.style.display = pump2Proxy1.checked ? '' : 'none';
      }
      updatePump2DwellTime1();

      pump2Proxy2.addEventListener('change', function() {
        pump2DwellTime2Row.style.display = pump2Proxy2.checked ? '' : 'none';
      });

      pump2LevelSense.addEventListener('change', function() {
        pump2LevelSenseOptionsRow.style.display = this.checked ? '' : 'none';
      });

      pump2ExtLamp.addEventListener('change', function() {
        pump2ExtLampOptionsRow.style.display = this.checked ? '' : 'none';
      });

      pump2BlockageManual.addEventListener('change', function() {
        if (pump2BlockageManual.checked) {
          pump2BlockageAuto.checked = false;
          pump2BlockageManualRow.style.display = '';
          pump2BlockageAutoRow.style.display = 'none';
        } else {
          pump2BlockageManualRow.style.display = 'none';
        }
      });
      pump2BlockageAuto.addEventListener('change', function() {
        if (pump2BlockageAuto.checked) {
          pump2BlockageManual.checked = false;
          pump2BlockageAutoRow.style.display = '';
          pump2BlockageManualRow.style.display = 'none';
        } else {
          pump2BlockageAutoRow.style.display = 'none';
        }
      });

      // Test/Back toggle logic
      const saveSettingsBtn = document.getElementById('saveSettingsBtn');
      const settingsFields = document.getElementById('settingsFields');
      const testModePanel = document.getElementById('testModePanel');
      const testModeBackBtn = document.getElementById('testModeBackBtn');
      const testModeSaveBtn = document.getElementById('testModeSaveBtn');
      let testModeActive = false;

      // Proxy indicator logic
      function isProxy1Enabled() {
        const proxy1 = document.getElementById('proxy1');
        return proxy1 && proxy1.checked;
      }
      function isProxy2Enabled() {
        const proxy2 = document.getElementById('proxy2');
        return proxy2 && proxy2.checked;
      }
      function updateProxyIndicators() {
        document.getElementById('proxy1Row').style.display = isProxy1Enabled() ? "" : "none";
        document.getElementById('proxy2Row').style.display = isProxy2Enabled() ? "" : "none";
      }

      testModeBtn.addEventListener('click', function() {
        testModeActive = !testModeActive;
        if (testModeActive) {
          settingsFields.style.display = "none";
          document.getElementById('testModeBtnRow').style.display = "none";
          testModePanel.style.display = "";
          updateProxyIndicators();
        } else {
          settingsFields.style.display = "";
          document.getElementById('testModeBtnRow').style.display = "";
          testModePanel.style.display = "none";
        }
      });

      testModeBackBtn.addEventListener('click', function() {
        testModeActive = false;
        settingsFields.style.display = "";
        document.getElementById('testModeBtnRow').style.display = "";
        testModePanel.style.display = "none";
      });

      // MQTT config
      const hivemqBrokerUrl = 'wss://bd58f8878eef4f5eb73ac65312b10130.s1.eu.hivemq.cloud:8884/mqtt';
      const hivemqUsername = 'a3Admin';
      const hivemqPassword = 'DontLetMeIn247';

      let client = null;
      let serial = null;
      let queryTimeout = null;

      // Get serial from URL
      function getSerialFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("serial");
      }

      function showStatus(msg, isError = false) {
        const status = document.getElementById("status-message");
        status.textContent = msg;
        status.className = "status-message" + (isError ? " error" : "");
      }

      function connectMQTTAndQuery() {
        serial = getSerialFromURL();
        if (!serial) {
          showStatus("No serial number provided in URL.", true);
          return;
        }
        document.getElementById("serial-number").textContent = serial;
        showStatus("Connecting to device...", false);

        client = mqtt.connect(hivemqBrokerUrl, {
          clientId: 'webClient-' + Math.random().toString(16).substr(2, 8),
          username: hivemqUsername,
          password: hivemqPassword,
          clean: true,
          connectTimeout: 4000,
          reconnectPeriod: 2000,
        });

        client.on('connect', function() {
          showStatus("Connected. Querying device...");
          const responseTopic = `a3/${serial}/serialResponse`;
          client.subscribe(responseTopic, function() {
            client.publish(`a3/${serial}/querySerial`, "mainQuery");
          });
          // Subscribe to test mode topics
          client.subscribe('a3/test/pump1');
          if (isProxy1Enabled()) client.subscribe('a3/test/proxy1');
          if (isProxy2Enabled()) client.subscribe('a3/test/proxy2');
          // Timeout if no response in 10 seconds
          queryTimeout = setTimeout(() => {
            showStatus("No response from device. Please check connection and try again.", true);
          }, 10000);
        });

        client.on('message', function(topic, message) {
          if (topic === `a3/${serial}/serialResponse`) {
            try {
              const payload = JSON.parse(message.toString());
              if (payload.serial && payload.version) {
                document.getElementById("serial-number").textContent = payload.serial;
                document.getElementById("ver-string").textContent = payload.version;
                showStatus(""); // Clear status message
                clearTimeout(queryTimeout);
              } else {
                showStatus("Invalid response from device.", true);
              }
            } catch (e) {
              showStatus("Error parsing device response.", true);
            }
          }
          // Handle test mode pump1 feedback
          if (topic === 'a3/test/pump1') {
            const btn = document.getElementById('pump1TestBtn');
            if (!btn) return;
            const payload = message.toString();
            if (payload === "running") {
              btn.classList.add('pump-on');
              btn.classList.remove('pump-off');
              btn.textContent = "ON/OFF";
            } else if (payload === "stopped") {
              btn.classList.remove('pump-on');
              btn.classList.add('pump-off');
              btn.textContent = "ON/OFF";
            }
          }
          // Handle proxy indicators
          if (topic === 'a3/test/proxy1') {
            const ind = document.getElementById('proxy1Indicator');
            if (!ind) return;
            const payload = message.toString();
            if (payload === "on") {
              ind.classList.add('proxy-on');
              ind.classList.remove('proxy-off');
              ind.textContent = "ON";
            } else if (payload === "off") {
              ind.classList.remove('proxy-on');
              ind.classList.add('proxy-off');
              ind.textContent = "OFF";
            }
          }
          if (topic === 'a3/test/proxy2') {
            const ind = document.getElementById('proxy2Indicator');
            if (!ind) return;
            const payload = message.toString();
            if (payload === "on") {
              ind.classList.add('proxy-on');
              ind.classList.remove('proxy-off');
              ind.textContent = "ON";
            } else if (payload === "off") {
              ind.classList.remove('proxy-on');
              ind.classList.add('proxy-off');
              ind.textContent = "OFF";
            }
          }
        });

        client.on('error', function() {
          showStatus("MQTT connection error.", true);
        });
      }

      // Pump1 Test button logic
      document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("backBtn").onclick = function() {
          window.location.href = "index.html";
        };
        connectMQTTAndQuery();

        // WiFi form submit handler (for demonstration, prevent default and show alert)
        document.getElementById("wifiFormMain").onsubmit = function(e) {
          e.preventDefault();
          alert("WiFi settings saved (demo only).");
        };

        // Test Mode Pump1 button logic
        const pump1TestBtn = document.getElementById('pump1TestBtn');
        if (pump1TestBtn) {
          pump1TestBtn.addEventListener('click', function() {
            if (!client) return;
            if (pump1TestBtn.classList.contains('pump-on')) {
              client.publish('a3/test/pump1', 'off');
            } else {
              client.publish('a3/test/pump1', 'on');
            }
          });
        }
      });

      // Responsive min-height adjustment for all pages
      function adjustMinHeight() {
        const vh = window.innerHeight;
        document.body.style.minHeight = vh + "px";
        const mainContent = document.querySelector('.main-content');
        if (mainContent) mainContent.style.minHeight = (vh - 60) + "px"; // 60px for header
      }
      window.addEventListener("resize", adjustMinHeight);
      window.addEventListener("DOMContentLoaded", adjustMinHeight);
    </script>
  </body>
</html>